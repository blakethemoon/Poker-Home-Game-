<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Moon's ‚Äî Cash Game</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --s0:#08060f;--s1:#0f0c1a;--s2:#161122;--s3:#1d1830;--s4:#26203e;
  --i0:#fff;--i1:#e8e3f5;--i2:#a093c0;--i3:#5a5070;--i4:#332d47;
  --au:#c8a96e;--aul:#e2c98a;--aud:#8a6a38;
  --pos:#4ade80;--neg:#f87171;--neu:#60a5fa;--warn:#fb923c;
  --br:rgba(255,255,255,.055);--brh:rgba(200,169,110,.22);
  --r4:4px;--r6:6px;--r8:8px;--r10:10px;--r12:12px;
}
*,*:before,*:after{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

/* Base size + responsive scaling */
html{
  font-size:15px;                 /* slightly bigger baseline */
  -webkit-text-size-adjust:100%;
}

body{
  background:var(--s0);
  color:var(--i1);
  font-family:'DM Sans',sans-serif;
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  line-height:1.5;
}

/* Larger desktops / big monitors */
@media (min-width:1440px){
  html{ font-size:17px; }
}

/* Ultra-wide screens (like your screenshot) */
@media (min-width:1920px){
  html{ font-size:18px; }
}

/* BG */
#bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.amb{position:absolute;border-radius:50%;filter:blur(110px);opacity:.055;animation:adrift var(--t,20s) ease-in-out infinite alternate;will-change:transform}
@keyframes adrift{from{transform:translate(0,0) scale(1)}to{transform:translate(var(--dx,18px),var(--dy,-14px)) scale(1.06)}}
#bg::after{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.012) 1px,transparent 1px);background-size:52px 52px}

/* SHELL */
#app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100dvh}

/* TOPBAR */
.topbar{height:54px;background:rgba(8,6,15,.93);backdrop-filter:blur(20px);border-bottom:1px solid var(--br);display:flex;align-items:center;padding:0 20px;gap:14px;position:sticky;top:0;z-index:200;flex-shrink:0}
.wordmark{display:flex;align-items:center;gap:9px;margin-right:auto}
.wmark-name{font-family:'Instrument Serif',serif;font-size:20px;color:var(--i0);letter-spacing:.01em;line-height:1}
.wmark-dot{width:5px;height:5px;border-radius:50%;background:var(--au);box-shadow:0 0 7px var(--au);flex-shrink:0}
.wmark-sub{font-size:10px;color:var(--i3);letter-spacing:.08em;padding-left:8px;border-left:1px solid var(--br);margin-left:2px}
.hstat{text-align:right}
.hstat-v{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--i0);line-height:1}
.hstat-l{font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--i3);margin-top:2px}
.pill-live{display:flex;align-items:center;gap:5px;border:1px solid rgba(74,222,128,.2);background:rgba(74,222,128,.05);padding:4px 10px;border-radius:20px;font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--pos)}
.ldot{width:5px;height:5px;border-radius:50%;background:var(--pos);box-shadow:0 0 5px var(--pos);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* NAV */
.nav{background:rgba(8,6,15,.78);backdrop-filter:blur(12px);border-bottom:1px solid var(--br);display:flex;overflow-x:auto;padding:0 16px;scrollbar-width:none;flex-shrink:0}
.nav::-webkit-scrollbar{display:none}
.nvb{flex-shrink:0;padding:12px 14px;background:none;border:none;border-bottom:2px solid transparent;color:var(--i3);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;letter-spacing:.04em;cursor:pointer;white-space:nowrap;transition:color .14s,border-color .14s;touch-action:manipulation}
.nvb:hover{color:var(--i2)}.nvb.on{color:var(--au);border-bottom-color:var(--au)}

/* CONTENT */
.content{flex:1;padding:16px;max-width:1200px;width:100%;margin:0 auto}
.view{display:none}
.view.on{display:block;animation:pageIn .16s ease both}
@keyframes pageIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* CARD */
.card{background:var(--s1);border:1px solid var(--br);border-radius:var(--r8);padding:16px;position:relative}
.card-sm{padding:12px 15px}
.chd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.ctitle{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--i3)}

/* GRID */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.col{display:flex;flex-direction:column;gap:12px}
.flex{display:flex;gap:8px}.fc{display:flex;align-items:center;gap:8px}.fb{display:flex;justify-content:space-between;align-items:center}
.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
.mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}

/* STAT TILES */
.stile{background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:14px 16px}
.stile-v{font-family:'DM Mono',monospace;font-size:22px;font-weight:500;color:var(--i0);line-height:1;margin-bottom:5px}
.stile-v.au{color:var(--au)}.stile-v.pos{color:var(--pos)}.stile-v.neg{color:var(--neg)}.stile-v.neu{color:var(--neu)}
.stile-l{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--i3)}

/* FORMS */
.lbl{display:block;font-size:10px;font-weight:500;letter-spacing:.06em;color:var(--i3);margin-bottom:4px}
.inp,.sel{width:100%;background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:9px 12px;color:var(--i1);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .12s,box-shadow .12s;-webkit-appearance:none;appearance:none;caret-color:var(--au)}
.inp::placeholder{color:var(--i4)}.inp:focus,.sel:focus{border-color:var(--brh);box-shadow:0 0 0 3px rgba(200,169,110,.07)}
.sel{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%235a5070' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer}
.sel option{background:#161122}.fg{margin-bottom:11px}
.inp-sm{padding:7px 10px;font-size:13px}
.inp-xs{padding:5px 8px;font-size:12px;border-radius:var(--r4)}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 14px;border-radius:var(--r6);border:1px solid var(--br);background:var(--s3);color:var(--i2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;letter-spacing:.02em;cursor:pointer;white-space:nowrap;transition:all .12s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.btn:hover{background:var(--s4);color:var(--i1);border-color:var(--brh)}.btn:active{opacity:.75}
.btn-au{background:var(--au);border-color:var(--au);color:#090600;font-weight:600}
.btn-au:hover{background:var(--aul);border-color:var(--aul);color:#090600}
.btn-pos{background:rgba(74,222,128,.08);border-color:rgba(74,222,128,.2);color:var(--pos)}
.btn-pos:hover{background:rgba(74,222,128,.15)}
.btn-neg{background:rgba(248,113,113,.07);border-color:rgba(248,113,113,.18);color:var(--neg)}
.btn-neg:hover{background:rgba(248,113,113,.13)}
.btn-neu{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.2);color:var(--neu)}
.btn-neu:hover{background:rgba(96,165,250,.14)}
.btn-ghost{background:transparent;border-color:transparent;color:var(--i3)}
.btn-ghost:hover{color:var(--i2);background:var(--s2);border-color:var(--br)}
.btn-sm{padding:5px 12px;font-size:11px}.btn-xs{padding:3px 8px;font-size:10px;border-radius:var(--r4)}.btn-full{width:100%}

/* TABLE */
.tscroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:480px}
thead th{padding:7px 10px;text-align:left;font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--i3);border-bottom:1px solid var(--br)}
tbody td{padding:9px 10px;border-bottom:1px solid var(--br);font-size:13px;vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(255,255,255,.016)}
.mono{font-family:'DM Mono',monospace;font-size:12px}
.c-au{color:var(--au)}.c-pos{color:var(--pos)}.c-neg{color:var(--neg)}.c-dim{color:var(--i3)}.c-2{color:var(--i2)}
.pname{font-size:14px;font-weight:600;color:var(--i0)}
.pill{display:inline-block;padding:2px 7px;border-radius:20px;font-size:8px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;border:1px solid}
.pill-act{border-color:rgba(74,222,128,.26);color:var(--pos);background:rgba(74,222,128,.05)}
.pill-out{border-color:rgba(248,113,113,.26);color:var(--neg);background:rgba(248,113,113,.05)}
.pill-csh{border-color:rgba(200,169,110,.26);color:var(--au);background:rgba(200,169,110,.05)}
.ppos{color:var(--pos);font-family:'DM Mono',monospace;font-size:12px}
.pneg{color:var(--neg);font-family:'DM Mono',monospace;font-size:12px}
.pneu{color:var(--i3);font-family:'DM Mono',monospace;font-size:12px}

/* ‚îÄ‚îÄ PLAYER PANEL ‚îÄ‚îÄ */
.player-panel-grid{display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:start}
.player-list-card{background:var(--s1);border:1px solid var(--br);border-radius:var(--r8);overflow:hidden}
.pl-header{padding:12px 14px;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center}
.pl-title{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--i3)}
.pl-item{padding:11px 14px;border-bottom:1px solid var(--br);cursor:pointer;transition:background .12s;display:flex;align-items:center;gap:10px}
.pl-item:last-child{border-bottom:none}
.pl-item:hover{background:var(--s2)}
.pl-item.selected{background:rgba(200,169,110,.06);border-left:2px solid var(--au)}
.pl-item.selected .pl-item-name{color:var(--au)}
.pl-seat{width:22px;height:22px;border-radius:50%;background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:var(--i3);flex-shrink:0}
.pl-item.selected .pl-seat{background:rgba(200,169,110,.15);border-color:rgba(200,169,110,.3);color:var(--au)}
.pl-item-name{flex:1;font-size:13px;font-weight:500;color:var(--i1);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pl-item-stack{font-family:'DM Mono',monospace;font-size:12px;color:var(--au)}
.pl-item-pnl{font-family:'DM Mono',monospace;font-size:10px}
.pl-empty{padding:22px;text-align:center;color:var(--i4);font-size:12px}

/* Player detail pane */
.player-detail{background:var(--s1);border:1px solid var(--br);border-radius:var(--r8);padding:18px;animation:pageIn .15s ease both}
.pd-name{font-family:'Instrument Serif',serif;font-size:26px;color:var(--i0);line-height:1;margin-bottom:4px}
.pd-seat{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--i3);margin-bottom:16px;display:flex;align-items:center;gap:6px}
.pd-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px}
.pd-stat{background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:12px 13px}
.pd-stat-v{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--i0);line-height:1;margin-bottom:4px}
.pd-stat-l{font-size:9px;font-weight:600;letter-spacing:.09em;text-transform:uppercase;color:var(--i3)}
.pd-section{margin-bottom:16px}
.pd-section-title{font-size:9px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--i3);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--br)}
.pd-addons{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto}
.addon-row{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);font-size:12px}
.addon-type{font-size:9px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:2px 6px;border-radius:3px}
.addon-type.bi{background:rgba(200,169,110,.12);color:var(--au)}
.addon-type.rb{background:rgba(96,165,250,.1);color:var(--neu)}
.addon-amt{font-family:'DM Mono',monospace;font-size:13px;color:var(--i0);font-weight:500;margin-left:4px}
.addon-time{font-family:'DM Mono',monospace;font-size:10px;color:var(--i3);margin-left:auto}

/* Quick add-on form */
.addon-form{background:var(--s2);border:1px solid var(--brh);border-radius:var(--r8);padding:14px;margin-bottom:14px}
.addon-form-title{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--au);margin-bottom:11px;display:flex;align-items:center;gap:6px}
.addon-row-inputs{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end}

/* Stack edit inline */
.stack-edit-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end}

/* Cash out inline */
.cashout-form{background:rgba(74,222,128,.04);border:1px solid rgba(74,222,128,.15);border-radius:var(--r8);padding:14px;margin-bottom:14px}
.cashout-form-title{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--pos);margin-bottom:11px}
.co-preview{text-align:center;padding:10px 0 6px}
.co-net{font-family:'DM Mono',monospace;font-size:32px;font-weight:500;line-height:1}
.co-net.pos{color:var(--pos)}.co-net.neg{color:var(--neg)}
.co-sub{font-size:10px;color:var(--i3);margin-top:4px;letter-spacing:.08em}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
.dash-grid{display:grid;grid-template-columns:1fr 320px;gap:14px;align-items:start}
.dash-main{display:flex;flex-direction:column;gap:14px}
.dash-side{display:flex;flex-direction:column;gap:12px}
.bar-row{display:flex;align-items:center;gap:9px;margin-bottom:6px}
.bar-row:last-child{margin-bottom:0}
.bar-name{font-size:11px;color:var(--i2);min-width:72px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:4px;background:var(--s3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.bar-pct{font-family:'DM Mono',monospace;font-size:10px;color:var(--i3);min-width:28px;text-align:right}
.feed-item{display:flex;gap:9px;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--br)}
.feed-item:last-child{border-bottom:none}
.feed-ico{width:24px;height:24px;border-radius:var(--r4);background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.feed-body{flex:1;min-width:0}
.feed-title{font-size:12px;font-weight:500;color:var(--i1);line-height:1.3}
.feed-meta{font-size:10px;color:var(--i3);margin-top:1px}
.feed-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--i4);flex-shrink:0;margin-top:2px}

/* ‚îÄ‚îÄ TABLE VISUAL ‚îÄ‚îÄ */
.table-scene{display:flex;justify-content:center;padding:12px 0 16px}
.t-wrap{position:relative}
.felt{border-radius:50%;background:radial-gradient(ellipse at 40% 36%,#1a3d24,#0b1f13,#060d09);border:5px solid rgba(255,255,255,.05);box-shadow:inset 0 0 50px rgba(0,0,0,.6),0 0 0 1px rgba(200,169,110,.07),0 8px 32px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.fi-lbl{font-size:7px;letter-spacing:.26em;color:rgba(255,255,255,.18);text-transform:uppercase;margin-bottom:4px}
.fi-pot{font-family:'DM Mono',monospace;font-weight:500;color:var(--au);line-height:1}
.fi-sub{font-size:7px;letter-spacing:.18em;color:rgba(255,255,255,.15);text-transform:uppercase;margin-top:3px}
.seat-node{position:absolute;transform:translate(-50%,-50%);cursor:pointer;transition:transform .12s}
.seat-node:hover{transform:translate(-50%,-50%) scale(1.07)}
.seat-chip{background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:6px 5px;text-align:center;transition:border-color .12s;position:relative;overflow:hidden}
.seat-node:hover .seat-chip{border-color:var(--brh)}
.seat-chip.occ{border-color:rgba(200,169,110,.16);background:rgba(200,169,110,.04)}
.seat-chip.occ::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:var(--au)}
.seat-chip.emp{opacity:.36;border-style:dashed}
.seat-chip.big{border-color:rgba(74,222,128,.18)}.seat-chip.big::before{background:var(--pos)}
.seat-chip.sht{border-color:rgba(248,113,113,.18)}.seat-chip.sht::before{background:var(--neg)}
.sn-num{font-size:7px;letter-spacing:.1em;color:var(--i3);margin-bottom:1px}
.sn-name{font-size:9px;font-weight:600;color:var(--i1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px}
.sn-stack{font-family:'DM Mono',monospace;font-size:9px;color:var(--au)}
.sn-stack.up{color:var(--pos)}.sn-stack.dn{color:var(--neg)}
.sn-open{font-size:8px;color:var(--i4)}

/* ‚îÄ‚îÄ CHIP COUNTER ‚îÄ‚îÄ */
.chip-legend{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:13px}
.chip-item{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:5px 10px;font-family:'DM Mono',monospace;font-size:11px;color:var(--i2)}
.cdot{width:14px;height:14px;border-radius:50%;border:2px dashed rgba(255,255,255,.18);flex-shrink:0}
.cdot.r{background:#ef4444}.cdot.b{background:#3b82f6}.cdot.bl{background:#1a1a2e;border-color:rgba(255,255,255,.26)}.cdot.g{background:#22c55e}.cdot.w{background:#e5e7eb;border-color:rgba(229,231,235,.4)}.cdot.pk{background:#ec4899}.cdot.pu{background:#a855f7}
.upload-zone{border:1px dashed rgba(200,169,110,.25);border-radius:var(--r8);padding:28px 16px;text-align:center;cursor:pointer;transition:border-color .12s,background .12s;background:var(--s2)}
.upload-zone:hover{border-color:var(--au);background:rgba(200,169,110,.03)}
.upload-zone.dov{border-color:var(--au);background:rgba(200,169,110,.05)}
.up-icon{font-size:28px;margin-bottom:7px;display:block;opacity:.6}
.up-text{font-size:13px;font-weight:500;color:var(--i2);margin-bottom:3px}
.up-sub{font-size:11px;color:var(--i4)}
.chip-prev-img{width:100%;max-height:200px;object-fit:contain;border-radius:var(--r6);border:1px solid var(--br);margin-bottom:11px;display:none}
.loading-box{display:none;padding:20px;text-align:center}
.spin{display:inline-block;font-size:18px;animation:spin .8s linear infinite;margin-bottom:5px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-size:11px;color:var(--i3);letter-spacing:.06em}
.result-box{display:none;border:1px solid var(--brh);background:rgba(200,169,110,.04);border-radius:var(--r8);padding:15px;text-align:center;animation:pageIn .2s ease both}
.res-total{font-family:'DM Mono',monospace;font-size:38px;font-weight:500;color:var(--au);line-height:1}
.res-lbl{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--i3);margin:5px 0 12px}
.res-chips{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin-bottom:10px}
.rchip{background:var(--s3);border:1px solid var(--br);border-radius:var(--r6);padding:7px 10px;text-align:center;min-width:64px}
.rchip-n{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;line-height:1}
.rchip-l{font-size:8px;color:var(--i3);margin-top:2px}
.res-desc{font-size:11px;color:var(--i3);font-style:italic}
.pp-list{display:flex;flex-direction:column;gap:5px;margin:9px 0 11px}
.pp-row{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:var(--r6);border:1px solid var(--br);background:var(--s2);cursor:pointer;transition:all .11s}
.pp-row:hover{border-color:var(--brh);background:var(--s3)}
.pp-row.sel{border-color:rgba(200,169,110,.38);background:rgba(200,169,110,.06)}
.pp-name{flex:1;font-size:13px;font-weight:500;color:var(--i1)}
.pp-stack{font-family:'DM Mono',monospace;font-size:11px;color:var(--au)}
.chip-acts{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.denom-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.denom-item{background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:9px 10px;display:flex;align-items:center;gap:7px}
.denom-dot{width:16px;height:16px;border-radius:50%;flex-shrink:0;border:2px dashed rgba(255,255,255,.18)}
.denom-name{font-size:11px;color:var(--i2);font-weight:500;flex:1}
.denom-inp{width:60px;background:var(--s1);border:1px solid var(--br);border-radius:var(--r4);padding:4px 7px;color:var(--au);font-family:'DM Mono',monospace;font-size:12px;outline:none;text-align:center;caret-color:var(--au)}
.denom-inp:focus{border-color:var(--brh)}
.mc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mc-row2{display:flex;align-items:center;gap:7px}
.mc-dot{width:18px;height:18px;border-radius:50%;flex-shrink:0;border:2px dashed rgba(255,255,255,.16)}
.mc-dot.r{background:#ef4444}.mc-dot.b{background:#3b82f6}.mc-dot.bl{background:#1a1a2e;border-color:rgba(255,255,255,.26)}.mc-dot.g{background:#22c55e}.mc-dot.w{background:#e5e7eb}.mc-dot.pk{background:#ec4899}.mc-dot.pu{background:#a855f7}
.mc-inp{width:64px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:6px 8px;color:var(--au);font-family:'DM Mono',monospace;font-size:13px;outline:none;text-align:center;caret-color:var(--au)}
.mc-inp:focus{border-color:var(--brh)}
.mc-total-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0 2px;border-top:1px solid var(--br);margin-top:5px}
.mc-tlbl{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:var(--i3);font-weight:500}
.mc-tval{font-family:'DM Mono',monospace;font-size:24px;font-weight:500;color:var(--au)}

/* ‚îÄ‚îÄ PREFLOP TRAINER ‚îÄ‚îÄ */
.trainer-wrap{display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start}
.trainer-main{display:flex;flex-direction:column;gap:14px}
.trainer-side{display:flex;flex-direction:column;gap:12px}
.hand-display{background:var(--s2);border:1px solid var(--br);border-radius:var(--r10);padding:20px;text-align:center;margin-bottom:2px}
.hd-label{font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--i3);margin-bottom:12px}
.hd-cards{display:flex;justify-content:center;gap:10px;margin-bottom:14px}
.playing-card{width:68px;height:96px;background:var(--i0);border-radius:8px;display:flex;flex-direction:column;justify-content:space-between;padding:7px;box-shadow:0 4px 20px rgba(0,0,0,.5);position:relative}
.playing-card .rank{font-family:'Instrument Serif',serif;font-size:22px;font-weight:700;line-height:1}
.playing-card .suit-center{font-size:28px;align-self:center}
.playing-card .rank-bot{font-family:'Instrument Serif',serif;font-size:22px;font-weight:700;line-height:1;align-self:flex-end;transform:rotate(180deg)}
.playing-card.red .rank,.playing-card.red .rank-bot,.playing-card.red .suit-center{color:#dc2626}
.playing-card.black .rank,.playing-card.black .rank-bot,.playing-card.black .suit-center{color:#1a1a1a}
.hd-context{font-size:12px;color:var(--i2);line-height:1.6;background:var(--s1);border:1px solid var(--br);border-radius:var(--r6);padding:10px 13px;text-align:left}
.action-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:2px}
.action-btn{padding:12px 6px;border-radius:var(--r8);border:1px solid var(--br);background:var(--s2);color:var(--i2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .13s;touch-action:manipulation}
.action-btn:hover{background:var(--s3);border-color:var(--brh);color:var(--i1)}
.action-btn.fold{border-color:rgba(248,113,113,.22);color:var(--neg)}.action-btn.fold:hover{background:rgba(248,113,113,.1)}
.action-btn.call{border-color:rgba(96,165,250,.22);color:var(--neu)}.action-btn.call:hover{background:rgba(96,165,250,.1)}
.action-btn.raise{border-color:rgba(200,169,110,.22);color:var(--au)}.action-btn.raise:hover{background:rgba(200,169,110,.1)}
.action-btn.rr{border-color:rgba(251,146,60,.22);color:var(--warn)}.action-btn.rr:hover{background:rgba(251,146,60,.1)}
.action-btn.selected{transform:scale(.97)}
.action-btn.correct{background:rgba(74,222,128,.15)!important;border-color:var(--pos)!important;color:var(--pos)!important}
.action-btn.wrong{background:rgba(248,113,113,.12)!important;border-color:var(--neg)!important;color:var(--neg)!important}

/* AI feedback panel */
.feedback-box{background:var(--s2);border:1px solid var(--br);border-radius:var(--r10);padding:16px;display:none;animation:pageIn .2s ease both}
.feedback-box.show{display:block}
.fb-grade{font-family:'Instrument Serif',serif;font-size:48px;line-height:1;margin-bottom:4px}
.fb-grade.A{color:var(--pos)}.fb-grade.B{color:var(--au)}.fb-grade.C{color:var(--warn)}.fb-grade.D,.fb-grade.F{color:var(--neg)}
.fb-verdict{font-size:14px;font-weight:600;color:var(--i0);margin-bottom:10px}
.fb-ev-row{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.fb-ev{background:var(--s3);border:1px solid var(--br);border-radius:var(--r6);padding:8px 12px;text-align:center;flex:1;min-width:80px}
.fb-ev-val{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;line-height:1;margin-bottom:3px}
.fb-ev-lbl{font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--i3)}
.fb-analysis{font-size:12px;color:var(--i2);line-height:1.7;margin-bottom:12px;border-left:2px solid var(--s4);padding-left:10px}
.fb-analysis.loading{color:var(--i4);font-style:italic}
.fb-spot-info{font-size:10px;color:var(--i3);line-height:1.6;padding:9px 11px;background:var(--s1);border-radius:var(--r6);border:1px solid var(--br)}

/* Trainer stats sidebar */
.trainer-stat-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--br);font-size:12px}
.trainer-stat-row:last-child{border-bottom:none}
.ts-lbl{color:var(--i3)}.ts-val{font-family:'DM Mono',monospace;color:var(--i0);font-weight:500}
.ts-val.pos{color:var(--pos)}.ts-val.neg{color:var(--neg)}.ts-val.au{color:var(--au)}
.range-grid{display:grid;grid-template-columns:repeat(13,1fr);gap:2px;margin-top:8px}
.range-cell{aspect-ratio:1;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:7px;font-weight:700;cursor:default;border:1px solid transparent;transition:all .1s}
.rc-pp{background:rgba(74,222,128,.2);color:var(--pos);border-color:rgba(74,222,128,.3)}
.rc-suit{background:rgba(200,169,110,.18);color:var(--au);border-color:rgba(200,169,110,.28)}
.rc-off{background:rgba(96,165,250,.1);color:var(--neu);border-color:rgba(96,165,250,.18)}
.rc-fold{background:rgba(248,113,113,.08);color:var(--neg);border-color:rgba(248,113,113,.14)}

/* HANDS PAGE */
.hand-entry{background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:12px 13px;margin-bottom:7px;display:flex;gap:10px;align-items:flex-start;transition:border-color .12s}
.hand-entry:hover{border-color:var(--brh)}
.hand-emoji{font-size:20px;flex-shrink:0;margin-top:1px}
.hand-type{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--i3);margin-bottom:2px}
.hand-winner{font-size:14px;font-weight:600;color:var(--i0)}
.hand-note{font-size:11px;color:var(--i3);margin-top:2px;font-style:italic}
.hand-when{font-size:10px;color:var(--i4);margin-top:4px;font-family:'DM Mono',monospace}
.hand-pot{margin-left:auto;flex-shrink:0;font-family:'DM Mono',monospace;font-size:15px;font-weight:500;color:var(--pos)}

/* HISTORY */
.hist-entry{background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:12px 13px;margin-bottom:7px;cursor:pointer;transition:border-color .12s}
.hist-entry:hover{border-color:var(--brh)}
.hist-date{font-size:10px;font-family:'DM Mono',monospace;color:var(--i3);margin-bottom:4px}
.hist-title{font-size:14px;font-weight:600;color:var(--i0);margin-bottom:5px}
.hist-meta{display:flex;flex-wrap:wrap;gap:12px}
.hist-kv{font-size:11px;color:var(--i3)}
.hist-kv strong{color:var(--au);font-family:'DM Mono',monospace}

/* MISC */
.empty{padding:28px 16px;text-align:center;color:var(--i4)}
.empty-icon{font-size:22px;opacity:.28;margin-bottom:7px;display:block}
.empty-txt{font-size:12px;font-weight:500;letter-spacing:.04em}
hr{border:none;border-top:1px solid var(--br);margin:12px 0}
.divider{height:1px;background:var(--br);margin:14px 0}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(4,2,10,.87);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);z-index:800;align-items:center;justify-content:center;padding:14px}
.overlay.on{display:flex}
.modal{background:var(--s1);border:1px solid var(--brh);border-radius:var(--r12);padding:22px;width:100%;max-width:400px;box-shadow:0 24px 80px rgba(0,0,0,.8);animation:pageIn .18s ease both;position:relative;max-height:90dvh;overflow-y:auto}
.modal-title{font-size:15px;font-weight:600;color:var(--i0);margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center}
.mclose{background:none;border:none;color:var(--i3);font-size:16px;cursor:pointer;line-height:1;padding:2px;flex-shrink:0}
.mclose:hover{color:var(--i1)}

/* TOAST */
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(50px);background:var(--s3);border:1px solid var(--brh);border-radius:var(--r8);padding:9px 16px;color:var(--i1);font-size:12px;font-weight:500;z-index:900;opacity:0;transition:all .2s cubic-bezier(.22,1,.36,1);pointer-events:none;white-space:nowrap;max-width:84vw;text-align:center}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* RESPONSIVE */
@media(max-width:820px){
  .topbar{padding:0 14px;height:50px}
  .content{padding:12px}
  .dash-grid{grid-template-columns:1fr}
  .player-panel-grid{grid-template-columns:1fr}
  .trainer-wrap{grid-template-columns:1fr}
  .g4{grid-template-columns:1fr 1fr}
  .action-btns{grid-template-columns:1fr 1fr}
  .denom-grid{grid-template-columns:1fr 1fr}
  .pd-stats{grid-template-columns:1fr 1fr}
}
@media(max-width:480px){
  .wmark-sub{display:none}
  .g3{grid-template-columns:1fr 1fr}
  .modal{padding:16px}
  table{min-width:420px}
  .addon-row-inputs{grid-template-columns:1fr auto;grid-template-rows:auto auto}
}
</style>
</head>
<body>
<div id="bg"></div>
<div id="app">

<!-- TOPBAR -->
<header class="topbar">
  <div class="wordmark">
    <div class="wmark-dot"></div>
    <span class="wmark-name">Moon's</span>
    <span class="wmark-sub">Cash Game</span>
  </div>
  <div class="hstat"><div class="hstat-v" id="h-players">0</div><div class="hstat-l">Players</div></div>
  <div class="hstat"><div class="hstat-v" id="h-pot">$0</div><div class="hstat-l">In Play</div></div>
  <div class="pill-live"><div class="ldot"></div>Live</div>
</header>

<!-- NAV -->
<nav class="nav">
  <button class="nvb on"    onclick="goTab('dash',this)">Dashboard</button>
  <button class="nvb"       onclick="goTab('players',this)">Players</button>
  <button class="nvb"       onclick="goTab('table',this)">Table</button>
  <button class="nvb"       onclick="goTab('chips',this)">Chip Counter</button>
  <button class="nvb"       onclick="goTab('hands',this)">Hands</button>
  <button class="nvb"       onclick="goTab('trainer',this)">Preflop Trainer</button>
  <button class="nvb"       onclick="goTab('history',this)">History</button>
</nav>

<main class="content">

<!-- DASHBOARD -->
<div class="view on" id="view-dash">
  <div class="dash-grid">
    <div class="dash-main">
      <div class="g4">
        <div class="stile"><div class="stile-v au" id="d-players">0</div><div class="stile-l">Active Players</div></div>
        <div class="stile"><div class="stile-v" id="d-pot">$0</div><div class="stile-l">Chips in Play</div></div>
        <div class="stile"><div class="stile-v" id="d-rebuys">0</div><div class="stile-l">Add-Ons</div></div>
        <div class="stile"><div class="stile-v" id="d-hands">0</div><div class="stile-l">Hands Logged</div></div>
      </div>
      <div class="card">
        <div class="chd">
          <span class="ctitle">Players at the Table</span>
          <button class="btn btn-au btn-sm" onclick="openAdd()">+ Add Player</button>
        </div>
        <div id="d-roster-empty" class="empty" style="padding:20px 0"><span class="empty-icon">‚ô†</span><span class="empty-txt">No players yet</span></div>
        <div id="d-roster"></div>
      </div>
      <div class="card" id="d-share-card" style="display:none">
        <div class="chd"><span class="ctitle">Stack Share</span></div>
        <div id="d-share-bars"></div>
      </div>
      <div class="card" id="d-pnl-card" style="display:none">
        <div class="chd"><span class="ctitle">Current P&L</span></div>
        <div id="d-pnl-bars"></div>
      </div>
    </div>
    <div class="dash-side">
      <div class="card card-sm">
        <div class="fb">
          <div><div class="hstat-l" style="margin-bottom:2px">Blinds</div><div class="mono c-au" id="d-blinds" style="font-size:14px">$1 / $2</div></div>
          <div><div class="hstat-l" style="margin-bottom:2px">Game</div><div class="mono c-2" id="d-game" style="font-size:11px">NL HOLD'EM</div></div>
          <button class="btn btn-ghost btn-sm" onclick="openSettings()">‚öô</button>
        </div>
      </div>
      <div class="card" style="flex:1">
        <div class="chd">
          <span class="ctitle">Live Feed</span>
          <button class="btn btn-sm" onclick="openLogHand()">+ Log Hand</button>
        </div>
        <div id="d-feed-empty" class="empty" style="padding:16px 0"><span class="empty-icon">‚óà</span><span class="empty-txt">Activity appears here</span></div>
        <div id="d-feed"></div>
      </div>
    </div>
  </div>
</div>

<!-- PLAYERS -->
<div class="view" id="view-players">
  <div class="player-panel-grid">
    <!-- List -->
    <div class="player-list-card">
      <div class="pl-header">
        <span class="pl-title">Active Players</span>
        <button class="btn btn-au btn-xs" onclick="openAdd()">+ Add</button>
      </div>
      <div id="pl-list-empty" class="pl-empty">No players yet</div>
      <div id="pl-list"></div>
    </div>
    <!-- Detail pane -->
    <div id="pl-detail-empty" class="card empty" style="padding:40px 20px">
      <span class="empty-icon" style="font-size:28px">‚Üê</span>
      <span class="empty-txt">Select a player to manage</span>
    </div>
    <div id="pl-detail" style="display:none"></div>
  </div>
</div>

<!-- TABLE -->
<div class="view" id="view-table">
  <div class="fb mb12">
    <div class="fc" style="gap:16px;flex-wrap:wrap">
      <div><div class="hstat-l" style="margin-bottom:2px">Blinds</div><div class="mono c-au" id="t-blinds">$1 / $2</div></div>
      <div><div class="hstat-l" style="margin-bottom:2px">Game</div><div class="mono c-2" id="t-game" style="font-size:11px">NL HOLD'EM</div></div>
    </div>
    <div class="flex">
      <button class="btn btn-au btn-sm" onclick="openAdd()">+ Seat</button>
      <button class="btn btn-sm" onclick="openSettings()">‚öô</button>
      <button class="btn btn-neg btn-sm" onclick="openEndNight()">End Night</button>
    </div>
  </div>
  <div class="card" style="padding-bottom:12px">
    <div class="table-scene">
      <div class="t-wrap" id="t-wrap">
        <div class="felt" id="felt">
          <div style="text-align:center;pointer-events:none">
            <div class="fi-lbl">No Limit Hold'em</div>
            <div class="fi-pot" id="felt-pot">$0</div>
            <div class="fi-sub">In Play</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card mt12">
    <div class="chd"><span class="ctitle">Stack Overview</span></div>
    <div id="sov-empty" class="empty" style="padding:14px 0"><span class="empty-icon" style="font-size:18px">‚Äî</span><span class="empty-txt">No active players</span></div>
    <div class="tscroll"><table id="sov-table" style="display:none">
      <thead><tr><th>Seat</th><th>Player</th><th>In</th><th>Stack</th><th>Net</th><th></th></tr></thead>
      <tbody id="sov-body"></tbody>
    </table></div>
  </div>
</div>

<!-- CHIP COUNTER -->
<div class="view" id="view-chips">
  <div class="g2" style="gap:14px">
    <div class="col">
      <div class="card">
        <div class="chd"><span class="ctitle">Chip Denominations</span><button class="btn btn-sm" onclick="resetDenoms()">Reset to Default</button></div>
        <p style="font-size:11px;color:var(--i3);margin-bottom:11px">Edit values ‚Äî these carry over to all counts</p>
        <div class="denom-grid" id="denom-grid"></div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">AI Scanner</span></div>
        <div class="upload-zone" id="upload-zone"
          onclick="document.getElementById('chip-file').click()"
          ondragover="event.preventDefault();this.classList.add('dov')"
          ondragleave="this.classList.remove('dov')"
          ondrop="handleDrop(event)">
          <span class="up-icon">üì∑</span>
          <div class="up-text">Tap to upload or drag photo</div>
          <div class="up-sub">Shoot straight down, spread stacks</div>
          <input type="file" id="chip-file" accept="image/*" capture="environment" onchange="handleFile(event)" style="display:none">
        </div>
        <img id="chip-img" class="chip-prev-img mt12" alt="chips">
        <div class="loading-box" id="chip-loading"><span class="spin">‚óå</span><div class="loading-txt">Counting chips‚Ä¶</div></div>
        <div class="result-box mt12" id="chip-result">
          <div class="res-total" id="chip-total">$0.00</div>
          <div class="res-lbl">Total Stack Value</div>
          <div class="res-chips" id="chip-chips"></div>
          <div class="res-desc" id="chip-desc"></div>
        </div>
        <div id="chip-actions" style="display:none" class="mt12">
          <div class="lbl mb8">Apply to player</div>
          <div class="pp-list" id="chip-picker"></div>
          <div class="chip-acts">
            <button class="btn btn-au btn-sm" onclick="chipApply('buyin')">+ Buy-In</button>
            <button class="btn btn-sm" onclick="chipApply('rebuy')">‚Ü∫ Add-On</button>
            <button class="btn btn-pos btn-sm" style="grid-column:1/-1" onclick="chipApply('stack')">‚ü≥ Set as Stack</button>
          </div>
          <button class="btn btn-ghost btn-xs mt8" onclick="resetChip()">‚Ü© Scan another</button>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <div class="chd"><span class="ctitle">Manual Count</span></div>
        <div class="mc-grid" id="mc-inputs-grid"></div>
        <div class="mc-total-row">
          <span class="mc-tlbl">Total</span>
          <span class="mc-tval" id="mc-total">$0.00</span>
        </div>
        <div class="divider"></div>
        <div class="lbl mb8">Apply to player</div>
        <div class="pp-list" id="mc-picker"></div>
        <div class="chip-acts mt8">
          <button class="btn btn-au btn-sm" onclick="mcApply('buyin')">+ Buy-In</button>
          <button class="btn btn-sm" onclick="mcApply('rebuy')">‚Ü∫ Add-On</button>
          <button class="btn btn-pos btn-sm" style="grid-column:1/-1" onclick="mcApply('stack')">‚ü≥ Set as Stack</button>
        </div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">Tips</span></div>
        <div style="font-size:12px;color:var(--i3);line-height:2.1">
          <div>‚ë† Good lighting, flat surface</div>
          <div>‚ë° Shoot straight down, spread stacks</div>
          <div>‚ë¢ AI reads denominations you've set</div>
          <div>‚ë£ Select player, then choose action</div>
          <div>‚ë§ Manual count always available</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HANDS -->
<div class="view" id="view-hands">
  <div class="fb mb14">
    <div class="g3" style="flex:1;gap:10px">
      <div class="stile"><div class="stile-v au" id="sh-count">0</div><div class="stile-l">Logged</div></div>
      <div class="stile"><div class="stile-v pos" id="sh-big">‚Äî</div><div class="stile-l">Biggest Pot</div></div>
      <div class="stile"><div class="stile-v" id="sh-win">‚Äî</div><div class="stile-l">Most Wins</div></div>
    </div>
    <button class="btn btn-au btn-sm" style="margin-left:11px;align-self:flex-start;flex-shrink:0" onclick="openLogHand()">+ Log Hand</button>
  </div>
  <div id="hands-empty" class="card empty"><span class="empty-icon">‚óà</span><span class="empty-txt">No hands logged yet</span></div>
  <div id="hands-list"></div>
</div>

<!-- POSTFLOP TRAINER -->
<div class="view" id="view-trainer">
  <div class="trainer-wrap">
    <div class="trainer-main">
      <div class="card">
        <div class="chd">
          <span class="ctitle">Postflop Spot</span>
          <div class="flex">
            <select class="sel" id="tr-street" style="font-size:11px;padding:5px 26px 5px 10px;width:auto">
              <option value="flop">Flop</option>
              <option value="turn">Turn</option>
              <option value="river">River</option>
              <option value="random">Random</option>
            </select>
            <button class="btn btn-au btn-sm" onclick="newHand()">New Hand</button>
          </div>
        </div>

        <!-- Seats at table -->
        <div id="tr-seats-row" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px"></div>

        <!-- Board -->
        <div style="margin-bottom:14px">
          <div class="hd-label" style="margin-bottom:8px">Board</div>
          <div id="tr-board" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <!-- Hero hand -->
        <div style="margin-bottom:14px">
          <div class="hd-label" style="margin-bottom:8px" id="tr-hero-lbl">Your Hand</div>
          <div id="hd-cards" style="display:flex;gap:8px"></div>
        </div>

        <!-- Pot / stack info -->
        <div id="hd-context" class="hd-context" style="margin-bottom:14px"></div>

        <!-- Action buttons -->
        <div class="action-btns" id="action-btns">
          <button class="action-btn" id="ab-fold"  data-action="fold"  onclick="trainerAction('fold')">Fold</button>
          <button class="action-btn" id="ab-check" data-action="check" onclick="trainerAction('check')">Check</button>
          <button class="action-btn" id="ab-call"  data-action="call"  onclick="trainerAction('call')">Call</button>
          <button class="action-btn" id="ab-bet"   data-action="bet"   onclick="trainerAction('bet')">Bet / Raise</button>
        </div>

        <!-- Feedback -->
        <div class="feedback-box" id="feedback-box">
          <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:12px">
            <div class="fb-grade" id="fb-grade">A</div>
            <div><div class="fb-verdict" id="fb-verdict">Excellent</div><div id="fb-spot-info" style="font-size:11px;color:var(--i3);margin-top:3px"></div></div>
          </div>
          <div class="fb-ev-row" id="fb-ev-row"></div>
          <div class="fb-analysis" id="fb-analysis"></div>
          <button class="btn btn-au btn-full mt12" onclick="newHand()">Next Hand ‚Üí</button>
        </div>
      </div>
    </div>

    <div class="trainer-side">
      <div class="card">
        <div class="chd"><span class="ctitle">Session Stats</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Hands</span><span class="ts-val au" id="tr-played">0</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Correct</span><span class="ts-val pos" id="tr-correct">0</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Accuracy</span><span class="ts-val" id="tr-acc">‚Äî</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Avg EV</span><span class="ts-val au" id="tr-ev">‚Äî</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Best Street</span><span class="ts-val" id="tr-best" style="font-size:11px">‚Äî</span></div>
        <div class="trainer-stat-row"><span class="ts-lbl">Needs Work</span><span class="ts-val neg" id="tr-weak" style="font-size:11px">‚Äî</span></div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">Hand Strength</span></div>
        <div id="tr-hand-strength" style="font-size:12px;color:var(--i3);line-height:2">‚Äî</div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">Concepts</span></div>
        <div style="font-size:11px;color:var(--i3);line-height:2.1">
          <div><span class="mono c-au">Pot odds</span> ‚Äî % needed to call</div>
          <div><span class="mono c-au">Equity</span> ‚Äî % chance to win</div>
          <div><span class="mono c-au">SPR</span> ‚Äî Stack-to-pot ratio</div>
          <div><span class="mono c-au">Blockers</span> ‚Äî Cards that reduce villain combos</div>
          <div><span class="mono c-au">Polarized</span> ‚Äî Bet/fold range, no mediocre hands</div>
          <div><span class="mono c-au">Merged</span> ‚Äî Bet strong + value hands together</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HISTORY -->
<div class="view" id="view-history">
  <div class="fb mb14">
    <div class="g3" style="flex:1;gap:10px">
      <div class="stile"><div class="stile-v au" id="hs-sess">0</div><div class="stile-l">Sessions</div></div>
      <div class="stile"><div class="stile-v" id="hs-hands">0</div><div class="stile-l">Hands Total</div></div>
      <div class="stile"><div class="stile-v" id="hs-top">‚Äî</div><div class="stile-l">Most Appeared</div></div>
    </div>
    <button class="btn btn-neg btn-xs" id="clr-hist" style="display:none;margin-left:11px;align-self:flex-start" onclick="clearHistory()">Clear</button>
  </div>
  <div id="hist-empty" class="card empty"><span class="empty-icon">‚óà</span><span class="empty-txt">No sessions ‚Äî use End Night on the Table view</span></div>
  <div id="hist-list"></div>
</div>

</main>
</div>

<!-- MODALS -->
<div class="overlay" id="m-add">
  <div class="modal">
    <div class="modal-title">Add Player <button class="mclose" onclick="cm('m-add')">‚úï</button></div>
    <div class="fg"><label class="lbl">Name</label><input class="inp" type="text" id="ap-name" placeholder="Player name‚Ä¶" maxlength="20" onkeydown="if(event.key==='Enter')doAddPlayer()"></div>
    <div class="fg"><label class="lbl">Buy-In ($)</label><input class="inp" type="number" id="ap-buyin" placeholder="10" min="1" step="1"></div>
    <div class="fg"><label class="lbl">Starting Stack ‚Äî blank = same as buy-in</label><input class="inp" type="number" id="ap-stack" placeholder="same as buy-in"></div>
    <div class="fg"><label class="lbl">Seat</label><select class="sel" id="ap-seat"></select></div>
    <div class="flex mt12">
      <button class="btn btn-au" style="flex:1" onclick="doAddPlayer()">Seat Player</button>
      <button class="btn" onclick="cm('m-add')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-settings">
  <div class="modal">
    <div class="modal-title">Settings <button class="mclose" onclick="cm('m-settings')">‚úï</button></div>
    <div class="fg"><label class="lbl">Small Blind ($)</label><input class="inp" type="number" id="set-sb" value="1"></div>
    <div class="fg"><label class="lbl">Big Blind ($)</label><input class="inp" type="number" id="set-bb" value="2"></div>
    <div class="fg"><label class="lbl">Default Buy-In ($)</label><input class="inp" type="number" id="set-bi" value="10"></div>
    <div class="fg"><label class="lbl">Seats</label>
      <select class="sel" id="set-seats">
        <option value="6">6</option><option value="8">8</option><option value="9">9</option><option value="10" selected>10</option>
      </select>
    </div>
    <div class="fg"><label class="lbl">Game</label>
      <select class="sel" id="set-game">
        <option>NL HOLD'EM</option><option>PLO</option><option>MIXED</option>
      </select>
    </div>
    <div class="flex mt12">
      <button class="btn btn-au" style="flex:1" onclick="doSaveSettings()">Save</button>
      <button class="btn" onclick="cm('m-settings')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-hand">
  <div class="modal">
    <div class="modal-title">Log a Hand <button class="mclose" onclick="cm('m-hand')">‚úï</button></div>
    <div class="fg"><label class="lbl">Type</label>
      <select class="sel" id="lh-type">
        <option>üëë Royal Flush</option><option>üî• Straight Flush</option><option>üí• Four of a Kind</option>
        <option>üè† Full House</option><option>‚ô† Flush</option><option>‚û° Straight</option>
        <option>üíÄ Bad Beat</option><option>‚ö° All-In Showdown</option><option>üé≠ Bluff Called</option>
        <option>üèÜ Monster Pot</option><option>üíé Set Over Set</option><option>üÉè Other</option>
      </select>
    </div>
    <div class="fg"><label class="lbl">Winner</label><select class="sel" id="lh-winner"></select></div>
    <div class="fg"><label class="lbl">Pot ($)</label><input class="inp" type="number" id="lh-pot" placeholder="0"></div>
    <div class="fg"><label class="lbl">Notes</label><input class="inp" type="text" id="lh-note" placeholder="Blake rivered the nuts‚Ä¶"></div>
    <div class="flex mt12">
      <button class="btn btn-au" style="flex:1" onclick="doLogHand()">Log It</button>
      <button class="btn" onclick="cm('m-hand')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-end">
  <div class="modal">
    <div class="modal-title">End Night <button class="mclose" onclick="cm('m-end')">‚úï</button></div>
    <div style="font-size:12px;color:var(--i3);margin-bottom:11px">Archive session and clear the table?</div>
    <div id="end-sum" style="background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:11px;font-size:11px;color:var(--i3);line-height:2;margin-bottom:12px"></div>
    <div class="flex">
      <button class="btn btn-au" style="flex:1" onclick="doSaveEnd()">Save &amp; End</button>
      <button class="btn btn-neg" style="flex:1" onclick="doDiscardEnd()">Discard</button>
      <button class="btn" onclick="cm('m-end')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const G = {
  players:[], hands:[], feed:[], nextId:1,
  settings:{sb:1,bb:2,defaultBuyin:10,seats:10,game:"NL HOLD'EM"},
  start:new Date()
};

// Chip denominations ‚Äî editable, these are defaults
const DEFAULT_DENOMS = [
  {id:'r', name:'Red',   color:'#ef4444', dotCls:'r', value:0.10},
  {id:'b', name:'Blue',  color:'#3b82f6', dotCls:'b', value:0.50},
  {id:'bl',name:'Black', color:'#374151', dotCls:'bl',value:1.00},
  {id:'g', name:'Green', color:'#22c55e', dotCls:'g', value:5.00},
  {id:'w', name:'White', color:'#e5e7eb', dotCls:'w', value:0.05},
  {id:'pk',name:'Pink',  color:'#ec4899', dotCls:'pk',value:2.50},
];
let denoms = JSON.parse(JSON.stringify(DEFAULT_DENOMS));

let activeTab = 'dash';
let chipVal   = null;
let selPlayer = null;
let selPlayerId = null; // for players panel

// Trainer state
const TRAINER = {played:0,correct:0,totalEV:0,history:[],currentSpot:null};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $  = id => document.getElementById(id);
const ti = p  => p.buyin + p.addOnTotal;
const money = n => {
  const a = Math.abs(n);
  return '$' + (a >= 1000 ? a.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}) : a.toFixed(2));
};
const signed = n => (n >= 0 ? '+' : '‚àí') + money(n);
const clock  = d => d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
function om(id){$(id).classList.add('on')}
function cm(id){$(id).classList.remove('on')}
function toast(msg,dur=2400){
  const t=$('toast');t.textContent=msg;t.classList.add('on');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),dur);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BACKGROUND
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildBG(){
  const c=$('bg');
  [[800,800,'#4c1d95','-180px','-180px',null,null,'22s','26px','-17px'],
   [600,600,'#831843','50%',null,'-120px',null,'17s','-20px','24px'],
   [450,450,'#1e3a5f','28%','42%',null,null,'13s','16px','-26px'],
   [320,320,'#78350f',null,'16%',null,'-60px','25s','22px','-8px']
  ].forEach(([w,h,col,t,l,r,b,dur,dx,dy])=>{
    const e=document.createElement('div');e.className='amb';
    e.style.cssText=`width:${w}px;height:${h}px;background:${col};--t:${dur};--dx:${dx};--dy:${dy};`;
    if(t)e.style.top=t;if(l)e.style.left=l;if(r)e.style.right=r;if(b)e.style.bottom=b;
    c.appendChild(e);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goTab(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.querySelectorAll('.nvb').forEach(b=>b.classList.remove('on'));
  $(`view-${name}`).classList.add('on');
  el.classList.add('on');
  activeTab=name;
  if(name==='dash')    renderDash();
  if(name==='players') renderPlayerPanel();
  if(name==='table')   setTimeout(renderTable,20);
  if(name==='chips')   {buildDenomUI();populatePickers();}
  if(name==='hands')   renderHands();
  if(name==='trainer') {if(!TRAINER.currentSpot)newHand();}
  if(name==='history') renderHistory();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DASHBOARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDash(){
  const active=G.players.filter(p=>p.status==='active');
  const totalStack=active.reduce((s,p)=>s+p.currentStack,0);
  $('d-players').textContent=active.length;
  $('d-pot').textContent=money(totalStack);
  $('d-rebuys').textContent=G.players.reduce((s,p)=>s+p.addOns.length,0);
  $('d-hands').textContent=G.hands.length;
  $('d-blinds').textContent=`$${G.settings.sb} / $${G.settings.bb}`;
  $('d-game').textContent=G.settings.game;

  const rEl=$('d-roster'),rEmp=$('d-roster-empty');
  if(!active.length){rEmp.style.display='block';rEl.innerHTML='';}
  else{
    rEmp.style.display='none';
    rEl.innerHTML=`<div style="display:flex;flex-direction:column">
      ${active.sort((a,b)=>a.seat-b.seat).map(p=>{
        const tot=ti(p),pnl=p.currentStack-tot;
        const ps=pnl===0?'‚Äî':signed(pnl),pc=pnl>0?'ppos':pnl<0?'pneg':'pneu';
        return `<div style="display:flex;align-items:center;gap:10px;padding:9px 6px;border-bottom:1px solid var(--br);cursor:pointer;transition:background .1s;border-radius:var(--r4);margin:0 -6px" onclick="openPlayerPanel(${p.id})" onmouseover="this.style.background='rgba(255,255,255,.02)'" onmouseout="this.style.background='transparent'">
          <div style="width:22px;height:22px;border-radius:50%;background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:var(--i3);flex-shrink:0">${p.seat}</div>
          <div style="flex:1;font-size:14px;font-weight:500;color:var(--i0);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name}</div>
          <div style="font-family:'DM Mono',monospace;font-size:13px;color:var(--au)">${money(p.currentStack)}</div>
          <div class="${pc}" style="min-width:54px;text-align:right">${ps}</div>
        </div>`;
      }).join('')}
    </div>`;
  }

  const sc=$('d-share-card'),sb=$('d-share-bars');
  if(!active.length){sc.style.display='none';}
  else{
    sc.style.display='block';
    const sorted=[...active].sort((a,b)=>b.currentStack-a.currentStack);
    const cols=['#c8a96e','#60a5fa','#4ade80','#f87171','#a78bfa','#34d399','#fb923c','#e879f9','#38bdf8','#a3e635'];
    const tot=active.reduce((s,p)=>s+p.currentStack,0);
    sb.innerHTML=sorted.map((p,i)=>{
      const pct=tot>0?Math.round(p.currentStack/tot*100):0;
      return `<div class="bar-row"><div class="bar-name">${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${cols[i%cols.length]}"></div></div><div class="bar-pct">${pct}%</div></div>`;
    }).join('');
  }

  const pc=$('d-pnl-card'),pb=$('d-pnl-bars');
  if(!active.length){pc.style.display='none';}
  else{
    pc.style.display='block';
    const sorted2=[...active].sort((a,b)=>(b.currentStack-ti(b))-(a.currentStack-ti(a)));
    const maxA=Math.max(...sorted2.map(p=>Math.abs(p.currentStack-ti(p))),1);
    pb.innerHTML=sorted2.map(p=>{
      const net=p.currentStack-ti(p),pct=Math.round(Math.abs(net)/maxA*100);
      const col=net>=0?'var(--pos)':'var(--neg)';
      return `<div class="bar-row"><div class="bar-name">${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${col}"></div></div><div class="bar-pct" style="color:${col}">${net>=0?'+':'-'}${money(Math.abs(net))}</div></div>`;
    }).join('');
  }
  renderFeed();
}

function renderFeed(){
  const list=$('d-feed'),emp=$('d-feed-empty');
  if(!G.feed.length){emp.style.display='block';list.innerHTML='';return;}
  emp.style.display='none';
  list.innerHTML=[...G.feed].reverse().slice(0,30).map(f=>`
    <div class="feed-item">
      <div class="feed-ico">${f.icon}</div>
      <div class="feed-body"><div class="feed-title">${f.title}</div><div class="feed-meta">${f.meta}</div></div>
      <div class="feed-time">${clock(f.time)}</div>
    </div>`).join('');
}
function addFeed(icon,title,meta){
  G.feed.push({icon,title,meta,time:new Date()});
  if(activeTab==='dash')renderFeed();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPlayerPanel(){
  const all=G.players.filter(p=>p.status==='active');
  const lEl=$('pl-list'),lEmp=$('pl-list-empty');
  if(!all.length){lEmp.style.display='block';lEl.innerHTML='';}
  else{
    lEmp.style.display='none';
    lEl.innerHTML=all.sort((a,b)=>a.seat-b.seat).map(p=>{
      const tot=ti(p),pnl=p.currentStack-tot,pc=pnl>0?'ppos':pnl<0?'pneg':'pneu';
      const sel=selPlayerId===p.id?'selected':'';
      return `<div class="pl-item ${sel}" id="pli-${p.id}" onclick="openPlayerPanel(${p.id})">
        <div class="pl-seat">${p.seat}</div>
        <div class="pl-item-name">${p.name}</div>
        <div style="text-align:right">
          <div class="pl-item-stack">${money(p.currentStack)}</div>
          <div class="pl-item-pnl ${pc}" style="margin-top:1px">${pnl===0?'‚Äî':signed(pnl)}</div>
        </div>
      </div>`;
    }).join('');
  }
  if(selPlayerId){
    const p=G.players.find(p=>p.id===selPlayerId&&p.status==='active');
    if(p)renderPlayerDetail(p);
    else{selPlayerId=null;$('pl-detail').style.display='none';$('pl-detail-empty').style.display='block';}
  }
}

function openPlayerPanel(id){
  selPlayerId=id;
  if(activeTab!=='players'){
    goTab('players',document.querySelectorAll('.nvb')[1]);
    return;
  }
  renderPlayerPanel();
  const p=G.players.find(p=>p.id===id);
  if(p){
    $('pl-detail-empty').style.display='none';
    $('pl-detail').style.display='block';
    renderPlayerDetail(p);
  }
}

function renderPlayerDetail(p){
  const tot=ti(p),pnl=p.currentStack-tot;
  const pc=pnl>0?'pos':pnl<0?'neg':'';
  const addOnCount=p.addOns.length;
  const addOnTotal=p.addOnTotal;

  $('pl-detail').innerHTML=`
    <div class="player-detail">
      <div class="pd-name">${p.name}</div>
      <div class="pd-seat">
        <span>Seat ${p.seat}</span>
        <span class="pill pill-act">Active</span>
      </div>

      <div class="pd-stats">
        <div class="pd-stat">
          <div class="pd-stat-v c-au">${money(p.currentStack)}</div>
          <div class="pd-stat-l">Current Stack</div>
        </div>
        <div class="pd-stat">
          <div class="pd-stat-v ${pc?'c-'+pc:''}">${pnl===0?'‚Äî':signed(pnl)}</div>
          <div class="pd-stat-l">Net P&L</div>
        </div>
        <div class="pd-stat">
          <div class="pd-stat-v">${money(tot)}</div>
          <div class="pd-stat-l">Total In</div>
        </div>
      </div>

      <!-- Add-On section -->
      <div class="pd-section">
        <div class="pd-section-title">Quick Add-On / Re-Buy</div>
        <div class="addon-form">
          <div class="addon-form-title">‚Ü∫ Add chips to stack</div>
          <div class="addon-row-inputs">
            <div>
              <label class="lbl">Amount ($)</label>
              <input class="inp inp-sm" type="number" id="pd-addon-amt" value="${G.settings.defaultBuyin}" min="0" step="1" oninput="updateAddonPreview()">
            </div>
            <div>
              <label class="lbl">Type</label>
              <select class="sel inp-sm" id="pd-addon-type">
                <option value="rebuy">Re-Buy</option>
                <option value="addon">Add-On</option>
              </select>
            </div>
            <div style="padding-bottom:1px">
              <button class="btn btn-au" onclick="doAddon(${p.id})" style="height:38px;margin-top:auto">Add</button>
            </div>
          </div>
          <div style="font-size:10px;color:var(--i3);margin-top:7px" id="pd-addon-preview">
            Stack: ${money(p.currentStack)} + <span id="pd-addon-delta">${money(G.settings.defaultBuyin)}</span> = <span id="pd-addon-new">${money(p.currentStack+G.settings.defaultBuyin)}</span>
          </div>
        </div>
        <div class="pd-section-title">Transaction History</div>
        <div class="pd-addons" id="pd-addons-list">
          <div class="addon-row"><span class="addon-type bi">BUY-IN</span><span class="addon-amt">${money(p.buyin)}</span><span class="addon-time">${clock(p.joinedAt)}</span></div>
          ${p.addOns.map(a=>`
            <div class="addon-row">
              <span class="addon-type rb">${a.type.toUpperCase()}</span>
              <span class="addon-amt">+${money(a.amount)}</span>
              <span class="addon-time">${clock(a.time)}</span>
            </div>`).join('')}
          ${addOnCount>0?`<div style="font-size:10px;color:var(--i3);padding:5px 0">${addOnCount} add-on${addOnCount!==1?'s':''} ¬∑ ${money(addOnTotal)} total</div>`:''}
        </div>
      </div>

      <!-- Update Stack -->
      <div class="pd-section">
        <div class="pd-section-title">Update Stack</div>
        <div class="stack-edit-row">
          <div>
            <label class="lbl">New Stack ($)</label>
            <input class="inp inp-sm" type="number" id="pd-stack-val" value="${p.currentStack}" min="0" step="0.5" onkeydown="if(event.key==='Enter')doUpdateStack(${p.id})">
          </div>
          <div style="padding-bottom:1px"><button class="btn btn-au" onclick="doUpdateStack(${p.id})" style="height:38px;margin-top:auto">Set</button></div>
          <div style="padding-bottom:1px"><button class="btn" onclick="openChipsForPlayer(${p.id})" style="height:38px;margin-top:auto;font-size:10px">üì∑ Scan</button></div>
        </div>
      </div>

      <!-- Cash Out -->
      <div class="pd-section">
        <div class="pd-section-title">Cash Out</div>
        <div class="cashout-form">
          <div class="cashout-form-title">$ Record final chip count</div>
          <div class="fg">
            <label class="lbl">Final Stack ($)</label>
            <input class="inp inp-sm" type="number" id="pd-co-amt" placeholder="0.00" min="0" step="0.5" oninput="updateCoPreview(${p.id})">
          </div>
          <div class="co-preview" id="pd-co-preview" style="display:none">
            <div class="co-net" id="pd-co-net">$0</div>
            <div class="co-sub" id="pd-co-sub"></div>
          </div>
          <button class="btn btn-pos btn-full mt8" onclick="doPlayerCashout(${p.id})">Confirm Cash Out</button>
        </div>
      </div>

      <!-- Danger -->
      <div class="flex">
        <button class="btn btn-neg btn-sm" onclick="doMarkOut(${p.id})" style="flex:1">Bust Out</button>
        <button class="btn btn-ghost btn-sm" onclick="openSettings()" style="flex:1">‚öô Settings</button>
      </div>
    </div>`;

  // highlight in list
  document.querySelectorAll('.pl-item').forEach(el=>el.classList.remove('selected'));
  const pli=$(`pli-${p.id}`);if(pli)pli.classList.add('selected');
}

function updateAddonPreview(){
  const amt=parseFloat($('pd-addon-amt').value)||0;
  const p=G.players.find(p=>p.id===selPlayerId);
  if(!p)return;
  $('pd-addon-delta').textContent=money(amt);
  $('pd-addon-new').textContent=money(p.currentStack+amt);
}
function updateCoPreview(id){
  const p=G.players.find(p=>p.id===id);
  const av=$('pd-co-amt').value,prev=$('pd-co-preview');
  if(!p||av===''){prev.style.display='none';return;}
  const cv=parseFloat(av)||0,tot=ti(p),net=cv-tot;
  prev.style.display='block';
  const ne=$('pd-co-net');ne.textContent=signed(net);ne.className='co-net '+(net>=0?'pos':'neg');
  $('pd-co-sub').textContent=`Chips ${money(cv)} ¬∑ Invested ${money(tot)}`;
}

function doAddon(id){
  const amt=parseFloat($('pd-addon-amt').value)||G.settings.defaultBuyin;
  const type=$('pd-addon-type').value;
  const p=G.players.find(p=>p.id===id);
  p.addOns.push({amount:amt,type,time:new Date()});
  p.addOnTotal+=amt;
  p.currentStack+=amt;
  addFeed('‚Ü∫',`${p.name} ${type}`,`+${money(amt)} ¬∑ Stack ${money(p.currentStack)}`);
  refresh();renderPlayerPanel();toast(`${p.name}: +${money(amt)} ${type}`);
}
function doUpdateStack(id){
  const nv=parseFloat($('pd-stack-val').value);
  if(isNaN(nv)||nv<0){toast('Invalid value');return;}
  const p=G.players.find(p=>p.id===id),old=p.currentStack;
  p.currentStack=nv;
  addFeed('‚ü≥',`${p.name} stack updated`,`${money(old)} ‚Üí ${money(nv)}`);
  refresh();renderPlayerPanel();toast(`${p.name}: ${money(nv)}`);
}
function doPlayerCashout(id){
  const av=$('pd-co-amt').value;
  if(!av){toast('Enter chip value');return;}
  const cv=parseFloat(av),p=G.players.find(p=>p.id===id);
  const tot=ti(p),net=cv-tot;
  p.status='cashed';p.cashoutAmount=cv;p.currentStack=0;
  addFeed(net>=0?'üèÜ':'üí∏',`${p.name} cashed out`,`${money(cv)} ¬∑ Net ${signed(net)}`);
  selPlayerId=null;refresh();renderPlayerPanel();toast(`${p.name} cashes ${money(cv)}`);
}
function doMarkOut(id){
  const p=G.players.find(p=>p.id===id);
  if(!confirm(`Mark ${p.name} as busted out?`))return;
  p.status='out';
  addFeed('üíÄ',`${p.name} busted out`,`Invested ${money(ti(p))}`);
  selPlayerId=null;refresh();renderPlayerPanel();toast(`${p.name} is out`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADD PLAYER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openAdd(presetSeat){
  const n=G.settings.seats,sel=$('ap-seat');
  sel.innerHTML='';let found=false;
  for(let i=1;i<=n;i++){
    if(!G.players.some(p=>p.seat===i&&p.status==='active')){
      sel.innerHTML+=`<option value="${i}"${presetSeat===i?' selected':''}>Seat ${i}</option>`;found=true;
    }
  }
  if(!found){toast('All seats taken');return;}
  $('ap-name').value='';$('ap-buyin').value=G.settings.defaultBuyin;$('ap-stack').value='';
  om('m-add');setTimeout(()=>$('ap-name').focus(),110);
}
function doAddPlayer(){
  const name=$('ap-name').value.trim();
  const buyin=parseFloat($('ap-buyin').value)||G.settings.defaultBuyin;
  const sv=$('ap-stack').value;
  const stack=sv!==''?parseFloat(sv):buyin;
  const seat=parseInt($('ap-seat').value);
  if(!name){toast('Enter a name');return;}
  G.players.push({id:G.nextId++,name,buyin,addOns:[],addOnTotal:0,seat,status:'active',currentStack:stack,cashoutAmount:null,joinedAt:new Date()});
  addFeed('‚ô†',`${name} bought in`,`${money(buyin)} ¬∑ Seat ${seat}`);
  cm('m-add');refresh();toast(`${name} seated at ${seat}`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABLE VISUAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tableSize(){const W=Math.min(window.innerWidth-36,680);return{W,H:Math.round(W*.5)};}
function renderTable(){
  const wrap=$('t-wrap');wrap.querySelectorAll('.seat-node').forEach(e=>e.remove());
  const{W,H}=tableSize();
  wrap.style.width=W+'px';wrap.style.height=H+'px';
  $('felt').style.width=Math.round(W*.7)+'px';$('felt').style.height=Math.round(H*.7)+'px';
  $('felt-pot').style.fontSize=Math.round(H*.09)+'px';
  const n=G.settings.seats,cx=W/2,cy=H/2,rx=W*.45,ry=H*.44;
  const nodeW=Math.min(80,Math.round(W*.13));
  const active=G.players.filter(p=>p.status==='active');
  $('felt-pot').textContent=money(active.reduce((s,p)=>s+p.currentStack,0));
  for(let i=0;i<n;i++){
    const ang=-Math.PI/2+(2*Math.PI/n)*i;
    const x=cx+rx*Math.cos(ang),y=cy+ry*Math.sin(ang);
    const seat=i+1,p=G.players.find(p=>p.seat===seat&&p.status==='active');
    const node=document.createElement('div');node.className='seat-node';
    node.style.cssText=`left:${x}px;top:${y}px;width:${nodeW}px;`;
    node.onclick=()=>p?openPlayerPanel(p.id):openAdd(seat);
    if(p){
      const tot=ti(p),pnl=p.currentStack-tot,pct=tot>0?p.currentStack/tot:1;
      let cls='occ';if(pct>=1.5)cls='occ big';else if(pct<=0.4)cls='occ sht';
      const sc=pnl>0?'up':pnl<0?'dn':'';
      node.innerHTML=`<div class="seat-chip ${cls}" style="max-width:${nodeW}px"><div class="sn-num">S${seat}</div><div class="sn-name" style="max-width:${nodeW-10}px">${p.name}</div><div class="sn-stack ${sc}">${money(p.currentStack)}</div></div>`;
    }else{
      node.innerHTML=`<div class="seat-chip emp" style="max-width:${nodeW}px"><div class="sn-num">S${seat}</div><div class="sn-open">Open</div></div>`;
    }
    wrap.appendChild(node);
  }
  renderSOV();updateHeader();
}
function renderSOV(){
  const active=G.players.filter(p=>p.status==='active').sort((a,b)=>a.seat-b.seat);
  $('sov-empty').style.display=active.length?'none':'block';
  $('sov-table').style.display=active.length?'table':'none';
  if(!active.length)return;
  $('sov-body').innerHTML=active.map(p=>{
    const tot=ti(p),pnl=p.currentStack-tot,ps=pnl===0?'‚Äî':signed(pnl);
    const pc=pnl>0?'ppos':pnl<0?'pneg':'pneu';
    return `<tr><td class="mono c-dim">${p.seat}</td><td><span class="pname">${p.name}</span></td><td class="mono">${money(p.buyin)}</td><td class="mono c-au">${money(p.currentStack)}</td><td><span class="${pc}">${ps}</span></td><td><button class="btn btn-xs" onclick="openPlayerPanel(${p.id})">Manage</button></td></tr>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHIP DENOMINATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildDenomUI(){
  const grid=$('denom-grid');
  if(!grid)return;
  grid.innerHTML=denoms.map((d,i)=>`
    <div class="denom-item">
      <div class="denom-dot" style="background:${d.color};border-color:${d.color}66"></div>
      <span class="denom-name">${d.name}</span>
      <input class="denom-inp" type="number" id="denom-${d.id}" value="${d.value}" min="0.01" step="0.01"
        onchange="updateDenom('${d.id}',this.value)" title="${d.name} value">
    </div>`).join('');
  buildMCInputs();
  buildChipLegend();
}
function updateDenom(id,val){
  const d=denoms.find(d=>d.id===id);
  if(d){d.value=parseFloat(val)||d.value;}
  calcManual();
}
function resetDenoms(){
  denoms=JSON.parse(JSON.stringify(DEFAULT_DENOMS));
  buildDenomUI();
  toast('Denominations reset to default');
}
function buildMCInputs(){
  const grid=$('mc-inputs-grid');if(!grid)return;
  grid.innerHTML=denoms.map(d=>`
    <div class="fg">
      <label class="lbl">${d.name} √ó $${d.value.toFixed(2)}</label>
      <div class="mc-row2">
        <div class="mc-dot ${d.dotCls}" style="background:${d.color}"></div>
        <input class="mc-inp" type="number" id="mc-${d.id}" value="0" min="0" oninput="calcManual()">
      </div>
    </div>`).join('');
}
function buildChipLegend(){
  // Update legend in header if present
}
function calcManual(){
  let total=0;
  denoms.forEach(d=>{
    const inp=$(`mc-${d.id}`);
    if(inp)total+=(parseFloat(inp.value)||0)*d.value;
  });
  const mcT=$('mc-total');if(mcT)mcT.textContent=money(total);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHIP COUNTER ‚Äî AI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function handleFile(e){const f=e.target.files[0];if(f)processImg(f);}
function handleDrop(e){
  e.preventDefault();$('upload-zone').classList.remove('dov');
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/'))processImg(f);
}
function processImg(file){
  const r=new FileReader();
  r.onload=e=>{
    const img=$('chip-img');img.src=e.target.result;img.style.display='block';
    $('upload-zone').style.display='none';runAI(e.target.result);
  };
  r.readAsDataURL(file);
}
async function runAI(dataUrl){
  $('chip-loading').style.display='block';
  $('chip-result').style.display='none';
  $('chip-actions').style.display='none';
  const b64=dataUrl.split(',')[1];
  const mt=dataUrl.split(';')[0].split(':')[1]||'image/jpeg';
  const denomDesc=denoms.map(d=>`${d.name.toUpperCase()}=$${d.value.toFixed(2)}`).join(', ');
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',max_tokens:500,
        system:`You are a poker chip counter. Count chips by color.
Chip values for this game: ${denomDesc}.
Return ONLY raw JSON, no markdown, no backticks:
{"counts":{"red":0,"blue":0,"black":0,"green":0,"white":0,"pink":0,"purple":0},"total":0.00,"description":"brief one sentence"}`,
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mt,data:b64}},
          {type:'text',text:`Count poker chips. Values: ${denomDesc}. Return only JSON.`}
        ]}]
      })
    });
    if(!resp.ok)throw new Error(`HTTP ${resp.status}`);
    const data=await resp.json();
    if(data.error)throw new Error(data.error.message);
    const raw=data.content?.map(c=>c.type==='text'?c.text:'').join('')||'';
    const m=raw.match(/\{[\s\S]*\}/);
    if(!m)throw new Error('No JSON found');
    const result=JSON.parse(m[0]);
    // Recalc total using current denom values
    const colorMap={red:'r',blue:'b',black:'bl',green:'g',white:'w',pink:'pk',purple:'pu'};
    let total=0;
    if(result.counts){
      Object.entries(result.counts).forEach(([col,cnt])=>{
        const id=colorMap[col];
        const d=denoms.find(d=>d.id===id);
        if(d)total+=cnt*d.value;
      });
    }
    result.total=parseFloat(total.toFixed(2));
    showChipResult(result);
  }catch(err){
    $('chip-loading').style.display='none';
    toast('Scan failed: '+err.message,4000);console.error(err);
  }
}
function showChipResult(r){
  $('chip-loading').style.display='none';
  chipVal=r;
  $('chip-total').textContent=money(r.total);
  const colorMap={red:'r',blue:'b',black:'bl',green:'g',white:'w',pink:'pk',purple:'pu'};
  const colorHex={r:'#ef4444',b:'#3b82f6',bl:'#9ca3af',g:'#22c55e',w:'#e5e7eb',pk:'#ec4899',pu:'#a855f7'};
  $('chip-chips').innerHTML=r.counts?Object.entries(r.counts).filter(([,v])=>v>0).map(([col,cnt])=>{
    const id=colorMap[col]||'r';
    const d=denoms.find(d=>d.id===id);
    return `<div class="rchip"><div class="rchip-n" style="color:${colorHex[id]||'#fff'}">${cnt}</div><div class="rchip-l">${col} ¬∑ $${d?d.value.toFixed(2):'?'}</div></div>`;
  }).join(''):'';
  $('chip-desc').textContent=r.description||'';
  $('chip-result').style.display='block';
  $('chip-actions').style.display='block';
  populatePickers();toast(`Counted: ${money(r.total)}`);
}

function chipApply(action){if(!chipVal){toast('Scan chips first');return;}applyToPlayer(action,chipVal.total,'scan');}
function mcApply(action){
  let total=0;
  denoms.forEach(d=>{const i=$(`mc-${d.id}`);if(i)total+=(parseFloat(i.value)||0)*d.value;});
  applyToPlayer(action,parseFloat(total.toFixed(2)),'manual');
}
function applyToPlayer(action,val,src){
  if(!selPlayer){toast('Select a player first');return;}
  const p=G.players.find(p=>p.id===selPlayer);
  if(!p){toast('Player not found');return;}
  if(action==='buyin'){p.buyin+=val;p.currentStack+=val;addFeed('‚ô†',`${p.name} bought in (${src})`,`+${money(val)}`);}
  else if(action==='rebuy'){p.addOns.push({amount:val,type:'add-on',time:new Date()});p.addOnTotal+=val;p.currentStack+=val;addFeed('‚Ü∫',`${p.name} add-on (${src})`,`+${money(val)} ¬∑ Stack ${money(p.currentStack)}`);}
  else if(action==='stack'){const old=p.currentStack;p.currentStack=val;addFeed('‚ü≥',`${p.name} stack set (${src})`,`${money(old)} ‚Üí ${money(val)}`);}
  refresh();toast(`Applied ${money(val)} to ${p.name}`);
}
function openChipsForPlayer(id){
  selPlayer=id;
  goTab('chips',document.querySelectorAll('.nvb')[3]);
}
function populatePickers(){
  const active=G.players.filter(p=>p.status==='active');
  ['chip-picker','mc-picker'].forEach(pid=>{
    const pp=$(pid);if(!pp)return;
    if(!active.length){pp.innerHTML=`<div style="font-size:11px;color:var(--i4);padding:5px 0">No active players</div>`;return;}
    pp.innerHTML=active.map(p=>`
      <div class="pp-row${selPlayer===p.id?' sel':''}" id="ppr-${pid}-${p.id}" onclick="selectPlayer(${p.id})">
        <div class="pp-name">${p.name}</div>
        <div class="pp-stack">${money(p.currentStack)}</div>
      </div>`).join('');
  });
}
function selectPlayer(id){
  selPlayer=id;
  document.querySelectorAll('.pp-row').forEach(r=>{r.classList.remove('sel');if(r.id.endsWith('-'+id))r.classList.add('sel');});
  toast(`${G.players.find(p=>p.id===id)?.name} selected`);
}
function resetChip(){
  $('chip-img').style.display='none';$('chip-img').src='';
  $('upload-zone').style.display='block';
  $('chip-result').style.display='none';
  $('chip-loading').style.display='none';
  $('chip-actions').style.display='none';
  $('chip-file').value='';chipVal=null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HANDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openLogHand(){
  const sel=$('lh-winner');
  sel.innerHTML=G.players.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(!sel.options.length){toast('Add players first');return;}
  $('lh-pot').value='';$('lh-note').value='';om('m-hand');
}
function doLogHand(){
  const type=$('lh-type').value;
  const wid=parseInt($('lh-winner').value);
  const pot=parseFloat($('lh-pot').value)||0;
  const note=$('lh-note').value.trim();
  const w=G.players.find(p=>p.id===wid);
  G.hands.push({type,winner:w?w.name:'?',pot,note,time:new Date()});
  const tn=type.split(' ').slice(1).join(' ');
  addFeed('‚òÖ',`${tn} ‚Äî ${w?w.name:'?'} wins`,`Pot: ${money(pot)}${note?' ¬∑ '+note:''}`);
  cm('m-hand');renderHands();updateHeader();toast(`Hand logged ¬∑ ${money(pot)} pot`);
}
function renderHands(){
  const list=$('hands-list'),emp=$('hands-empty');
  if(!G.hands.length){emp.style.display='block';list.innerHTML='';$('sh-count').textContent='0';$('sh-big').textContent='‚Äî';$('sh-win').textContent='‚Äî';return;}
  emp.style.display='none';
  const wc={};G.hands.forEach(h=>{wc[h.winner]=(wc[h.winner]||0)+1;});
  const topW=Object.keys(wc).sort((a,b)=>wc[b]-wc[a])[0]||'‚Äî';
  const big=Math.max(...G.hands.map(h=>h.pot));
  $('sh-count').textContent=G.hands.length;
  $('sh-big').textContent=big>0?money(big):'‚Äî';
  $('sh-win').textContent=topW.length>9?topW.slice(0,9)+'‚Ä¶':topW;
  list.innerHTML=[...G.hands].reverse().map(h=>{
    const em=h.type.split(' ')[0],tn=h.type.slice(em.length+1);
    return `<div class="hand-entry"><div class="hand-emoji">${em}</div><div style="flex:1"><div class="hand-type">${tn}</div><div class="hand-winner">${h.winner}</div>${h.note?`<div class="hand-note">${h.note}</div>`:''}<div class="hand-when">${clock(h.time)}</div></div><div class="hand-pot">${money(h.pot)}</div></div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openSettings(){
  $('set-sb').value=G.settings.sb;$('set-bb').value=G.settings.bb;
  $('set-bi').value=G.settings.defaultBuyin;$('set-seats').value=G.settings.seats;
  $('set-game').value=G.settings.game;om('m-settings');
}
function doSaveSettings(){
  G.settings.sb=parseFloat($('set-sb').value)||1;
  G.settings.bb=parseFloat($('set-bb').value)||2;
  G.settings.defaultBuyin=parseFloat($('set-bi').value)||10;
  G.settings.seats=parseInt($('set-seats').value)||10;
  G.settings.game=$('set-game').value;
  ['d-blinds','t-blinds'].forEach(id=>{const e=$(id);if(e)e.textContent=`$${G.settings.sb} / $${G.settings.bb}`;});
  ['d-game','t-game'].forEach(id=>{const e=$(id);if(e)e.textContent=G.settings.game;});
  cm('m-settings');refresh();toast('Settings saved');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   END NIGHT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openEndNight(){
  const tot=G.players.reduce((s,p)=>s+ti(p),0);
  const act=G.players.filter(p=>p.status==='active').length;
  $('end-sum').innerHTML=`${G.players.length} players ¬∑ ${money(tot)} total ¬∑ ${G.hands.length} hands<br>Started: ${clock(G.start)}${act?`<br><span style="color:var(--neg)">${act} player${act!==1?'s':''} still active</span>`:''}`;
  om('m-end');
}
function doSaveEnd(){saveHistory();cm('m-end');resetGame();toast('Session saved ‚Äî good game');}
function doDiscardEnd(){cm('m-end');resetGame();toast('Table cleared');}
function resetGame(){G.players=[];G.hands=[];G.feed=[];G.nextId=1;G.start=new Date();selPlayerId=null;selPlayer=null;refresh();}
function saveHistory(){
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  hist.unshift({
    id:Date.now(),
    date:new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}),
    time:clock(G.start),
    players:G.players.map(p=>({name:p.name,buyin:ti(p),cashout:p.cashoutAmount,status:p.status})),
    handsCount:G.hands.length,
    totalPot:G.players.reduce((s,p)=>s+ti(p),0),
    biggestPot:G.hands.length?Math.max(...G.hands.map(h=>h.pot)):0
  });
  localStorage.setItem('moonsHistory',JSON.stringify(hist.slice(0,50)));
}
function renderHistory(){
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  $('hist-empty').style.display=hist.length?'none':'block';
  $('hist-list').innerHTML='';
  $('clr-hist').style.display=hist.length?'inline-flex':'none';
  if(!hist.length){$('hs-sess').textContent='0';$('hs-hands').textContent='0';$('hs-top').textContent='‚Äî';return;}
  $('hs-sess').textContent=hist.length;
  $('hs-hands').textContent=hist.reduce((s,h)=>s+h.handsCount,0);
  const pc={};hist.forEach(s=>s.players.forEach(p=>{pc[p.name]=(pc[p.name]||0)+1;}));
  const tp=Object.keys(pc).sort((a,b)=>pc[b]-pc[a])[0]||'‚Äî';
  $('hs-top').textContent=tp.length>8?tp.slice(0,8)+'‚Ä¶':tp;
  $('hist-list').innerHTML=hist.map(s=>{
    const wins=s.players.filter(p=>p.cashout!=null&&p.cashout>p.buyin).sort((a,b)=>(b.cashout-b.buyin)-(a.cashout-a.buyin));
    const tw=wins[0];
    return `<div class="hist-entry"><div class="hist-date">${s.date} ¬∑ ${s.time}</div><div class="hist-title">${s.players.length} Players ¬∑ ${money(s.totalPot)} Total</div><div class="hist-meta"><div class="hist-kv">${s.handsCount} hands</div>${s.biggestPot>0?`<div class="hist-kv">Biggest: <strong>${money(s.biggestPot)}</strong></div>`:''}${tw?`<div class="hist-kv">Winner: <strong>${tw.name} +${money(tw.cashout-tw.buyin)}</strong></div>`:''}</div></div>`;
  }).join('');
}
function clearHistory(){if(!confirm('Clear all saved sessions?'))return;localStorage.removeItem('moonsHistory');renderHistory();toast('History cleared');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   POSTFLOP TRAINER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RANKS  = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
const SUITS  = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const SUIT_COLOR = {'‚ô†':'black','‚ô£':'black','‚ô•':'red','‚ô¶':'red'};
const POSITIONS  = ['BTN','CO','HJ','MP','EP','SB','BB'];
const POSITIONS_FULL = {BTN:'Button',CO:'Cutoff',HJ:'Hijack',MP:'Middle',EP:'UTG',SB:'Small Blind',BB:'Big Blind'};

function buildDeck(){
  const d=[];
  RANKS.forEach(r=>SUITS.forEach(s=>d.push({r,s})));
  return d;
}
function shuffle(d){
  for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}
  return d;
}
function cardHTML(c,facedown=false){
  if(facedown)return`<div class="playing-card" style="background:var(--s3);border:1px solid var(--br);width:52px;height:72px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--i4)">?</div>`;
  return`<div class="playing-card ${SUIT_COLOR[c.s]}" style="width:52px;height:72px;border-radius:6px;padding:5px">
    <span class="rank" style="font-size:16px">${c.r}</span>
    <span class="suit-center" style="font-size:20px">${c.s}</span>
    <span class="rank-bot" style="font-size:16px">${c.r}</span>
  </div>`;
}

/* ‚îÄ‚îÄ Hand evaluation helpers ‚îÄ‚îÄ */
function rankIndex(r){return RANKS.indexOf(r);}
function evalHand(hole,board){
  // Returns {name, tier} where tier 1=trash..9=royal
  const all=[...hole,...board];
  const ranks=all.map(c=>rankIndex(c.r));
  const suits=all.map(c=>c.s);
  const rankCount={};ranks.forEach(r=>{rankCount[r]=(rankCount[r]||0)+1;});
  const suitCount={};suits.forEach(s=>{suitCount[s]=(suitCount[s]||0)+1;});
  const pairs=Object.values(rankCount).filter(v=>v===2).length;
  const trips=Object.values(rankCount).filter(v=>v===3).length;
  const quads=Object.values(rankCount).filter(v=>v===4).length;
  const flush=Object.values(suitCount).some(v=>v>=5);
  const sortedR=[...new Set(ranks)].sort((a,b)=>a-b);
  let straight=false;
  for(let i=0;i<=sortedR.length-5;i++){if(sortedR[i+4]-sortedR[i]===4&&sortedR.slice(i,i+5).length===5)straight=true;}
  // Ace-low straight
  if(sortedR.includes(0)&&sortedR.includes(9)&&sortedR.includes(10)&&sortedR.includes(11)&&sortedR.includes(12))straight=true;
  if(flush&&straight)return{name:'Straight Flush / Royal',tier:9};
  if(quads)return{name:'Four of a Kind',tier:8};
  if(trips&&pairs)return{name:'Full House',tier:7};
  if(flush)return{name:'Flush',tier:6};
  if(straight)return{name:'Straight',tier:5};
  if(trips)return{name:'Three of a Kind',tier:4};
  if(pairs>=2)return{name:'Two Pair',tier:3};
  if(pairs===1)return{name:'One Pair',tier:2};
  // High card
  const hcRank=RANKS[Math.min(...ranks)];
  return{name:`High Card (${hcRank})`,tier:1};
}

function hasDraws(hole,board){
  const draws=[];
  const all=[...hole,...board];
  const suits=all.map(c=>c.s);
  const suitCount={};suits.forEach(s=>{suitCount[s]=(suitCount[s]||0)+1;});
  if(Object.values(suitCount).some(v=>v===4))draws.push('Flush draw');
  // Open-ended / gutshot straight draws
  const ranks=[...new Set(all.map(c=>rankIndex(c.r)))].sort((a,b)=>a-b);
  let gaps=0;
  for(let i=0;i<ranks.length-1;i++){const g=ranks[i+1]-ranks[i];if(g<=2)gaps++;}
  if(gaps>=3)draws.push('Straight draw');
  return draws;
}

/* ‚îÄ‚îÄ Generate a postflop spot ‚îÄ‚îÄ */
function newHand(){
  $('feedback-box').classList.remove('show');
  const deck=shuffle(buildDeck());

  // Pick street
  let streetSel=($('tr-street')||{value:'random'}).value;
  if(streetSel==='random')streetSel=['flop','turn','river'][Math.floor(Math.random()*3)];

  // Deal cards
  const heroHole=[deck.pop(),deck.pop()];
  const villainHole=[deck.pop(),deck.pop()];
  const boardSize=streetSel==='flop'?3:streetSel==='turn'?4:5;
  const board=[];for(let i=0;i<boardSize;i++)board.push(deck.pop());

  // Random positions ‚Äî hero and villain get different seats
  const shuffledPos=shuffle([...POSITIONS]);
  const heroPos=shuffledPos[0];
  const villainPos=shuffledPos[1];
  const heroInPosition=POSITIONS.indexOf(heroPos)<POSITIONS.indexOf(villainPos);

  // Effective stack and pot (randomised realistic values)
  const bb=G.settings.bb||2;
  const stackBB=Math.floor(Math.random()*80+30); // 30-110 BB
  const potBB=Math.floor(Math.random()*12+4);    // 4-16 BB initial pot
  const villainBet=Math.random()<0.5?Math.floor(potBB*(0.33+Math.random()*0.67)):0;

  // Evaluate hero hand
  const heroEval=evalHand(heroHole,board);
  const draws=hasDraws(heroHole,board);
  const spr=parseFloat((stackBB/potBB).toFixed(1));
  const potOdds=villainBet>0?parseFloat((villainBet/(potBB+villainBet*2)*100).toFixed(0)):null;

  // Determine correct action using simplified postflop logic
  let correctAction,gtoEV,reasoning;
  const tier=heroEval.tier;
  const hasDraw=draws.length>0;
  const canCheck=villainBet===0;

  if(canCheck){
    // Checking vs betting
    if(tier>=7){correctAction='bet';gtoEV=1.4+Math.random()*1.2;reasoning='Monster hand ‚Äî bet for value, build pot';}
    else if(tier>=5){correctAction='bet';gtoEV=0.8+Math.random()*0.8;reasoning='Strong hand ‚Äî bet for value and protection';}
    else if(tier>=3&&heroInPosition){correctAction='bet';gtoEV=0.4+Math.random()*0.6;reasoning='Medium hand IP ‚Äî bet for value/protection';}
    else if(hasDraw&&heroInPosition){correctAction='bet';gtoEV=0.2+Math.random()*0.5;reasoning='Semi-bluff draw in position ‚Äî betting gives fold equity';}
    else if(hasDraw){correctAction='check';gtoEV=0.1+Math.random()*0.3;reasoning='Draw OOP ‚Äî check/call preferred, protect equity';}
    else{correctAction='check';gtoEV=-(0.1+Math.random()*0.2);reasoning='Weak hand ‚Äî check and pot control';}
  }else{
    // Facing a bet: fold/call/raise
    const equity=tier>=7?0.92:tier>=5?0.78:tier>=3?0.55:hasDraw?0.35:0.15+Math.random()*0.1;
    const needsEquity=potOdds?potOdds/100:0.33;
    if(tier>=8){correctAction='bet';gtoEV=2.0+Math.random()*1.0;reasoning='Huge hand ‚Äî raise for value, build pot fast';}
    else if(tier>=6&&spr<4){correctAction='bet';gtoEV=1.2+Math.random()*0.8;reasoning='Strong hand, low SPR ‚Äî raise or jam for value';}
    else if(equity>needsEquity+0.2){correctAction='call';gtoEV=0.5+Math.random()*0.7;reasoning='Good equity vs bet ‚Äî calling is profitable';}
    else if(equity>needsEquity){correctAction='call';gtoEV=0.1+Math.random()*0.3;reasoning='Marginal call ‚Äî just enough equity to continue';}
    else if(hasDraw&&equity>needsEquity-0.05){correctAction='call';gtoEV=0.05+Math.random()*0.25;reasoning='Draw with implied odds ‚Äî calling is borderline correct';}
    else{correctAction='fold';gtoEV=-(0.2+Math.random()*0.5);reasoning='Insufficient equity vs this bet ‚Äî folding saves chips';}
  }

  // Assign random seats to show at table
  const numSeats=G.settings.seats||10;
  const allSeats=Array.from({length:numSeats},(_,i)=>i+1);
  const shuffledSeats=shuffle([...allSeats]);
  const heroSeat=shuffledSeats[0];
  const villainSeat=shuffledSeats[1];

  TRAINER.currentSpot={heroHole,villainHole,board,street:streetSel,heroPos,villainPos,heroSeat,villainSeat,villainBet,potBB,stackBB,bb,correctAction,gtoEV,reasoning,heroEval,draws,spr,potOdds,heroInPosition,numSeats};

  // Render seats row
  const seatsEl=$('tr-seats-row');
  if(seatsEl){
    seatsEl.innerHTML=allSeats.slice(0,numSeats).map(s=>{
      let label='',style='';
      if(s===heroSeat){label=heroPos;style='background:rgba(200,169,110,.12);border-color:rgba(200,169,110,.4);color:var(--au);font-weight:600';}
      else if(s===villainSeat){label=villainPos;style='background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.25);color:var(--neu)';}
      else{label='S'+s;style='color:var(--i4);border-color:var(--br);opacity:.45';}
      return`<div style="padding:4px 9px;border-radius:var(--r6);border:1px solid;font-size:10px;font-weight:600;letter-spacing:.06em;${style}">${label}</div>`;
    }).join('');
  }

  // Render board
  $('tr-board').innerHTML=board.map(c=>cardHTML(c)).join('');

  // Render hero hand
  $('hd-cards').innerHTML=heroHole.map(c=>cardHTML(c)).join('');
  $('tr-hero-lbl').textContent=`Your Hand ¬∑ ${heroEval.name}${draws.length?' + '+draws.join(', '):''}`;

  // Context
  const potVal=(potBB*bb).toFixed(0);
  const stackVal=(stackBB*bb).toFixed(0);
  const ctx=$('hd-context');
  if(villainBet>0){
    ctx.innerHTML=`<strong style="color:var(--au)">${heroPos}</strong> vs <strong style="color:var(--neu)">${villainPos}</strong> ¬∑ ${streetSel.charAt(0).toUpperCase()+streetSel.slice(1)} ¬∑ Pot <strong>$${potVal}</strong> ¬∑ ${villainPos} bets <strong style="color:var(--neg)">$${(villainBet*bb).toFixed(0)}</strong> ¬∑ Your stack <strong>$${stackVal}</strong> ¬∑ SPR ${spr}${potOdds?` ¬∑ Need ${potOdds}% equity`:''}`;
  }else{
    ctx.innerHTML=`<strong style="color:var(--au)">${heroPos}</strong> vs <strong style="color:var(--neu)">${villainPos}</strong> ¬∑ ${streetSel.charAt(0).toUpperCase()+streetSel.slice(1)} ¬∑ Pot <strong>$${potVal}</strong> ¬∑ Action checked to you ¬∑ Stack <strong>$${stackVal}</strong> ¬∑ SPR ${spr}`;
  }

  // Set button labels and styles based on situation
  const abFold=$('ab-fold'),abCheck=$('ab-check'),abCall=$('ab-call'),abBet=$('ab-bet');
  [abFold,abCheck,abCall,abBet].forEach(b=>{if(b)b.classList.remove('correct','wrong','selected');});
  if(canCheck){
    if(abFold){abFold.textContent='Fold';abFold.style.display='none';}
    if(abCheck){abCheck.textContent='Check';abCheck.style.display='block';abCheck.style.borderColor='rgba(96,165,250,.22)';abCheck.style.color='var(--neu)';}
    if(abCall){abCall.textContent='Call';abCall.style.display='none';}
    if(abBet){abBet.textContent='Bet';abBet.style.display='block';abBet.style.borderColor='rgba(200,169,110,.22)';abBet.style.color='var(--au)';}
  }else{
    if(abFold){abFold.textContent='Fold';abFold.style.display='block';abFold.style.borderColor='rgba(248,113,113,.22)';abFold.style.color='var(--neg)';}
    if(abCheck){abCheck.textContent='Check';abCheck.style.display='none';}
    if(abCall){abCall.textContent='Call $'+(villainBet*bb).toFixed(0);abCall.style.display='block';abCall.style.borderColor='rgba(96,165,250,.22)';abCall.style.color='var(--neu)';}
    if(abBet){abBet.textContent='Raise';abBet.style.display='block';abBet.style.borderColor='rgba(251,146,60,.22)';abBet.style.color='var(--warn)';}
  }

  // Hand strength sidebar
  const hsEl=$('tr-hand-strength');
  if(hsEl){
    const tierLabel=['','Trash','One Pair','Two Pair','Three of a Kind','Straight','Flush','Full House','Quads','Straight Flush'];
    const tierColor=['','var(--neg)','var(--i2)','var(--i2)','var(--neu)','var(--au)','var(--au)','var(--pos)','var(--pos)','var(--pos)'];
    hsEl.innerHTML=`<div style="margin-bottom:8px"><span style="color:${tierColor[tier]||'var(--i1)'}">‚óè ${heroEval.name}</span></div>
      ${draws.map(d=>`<div style="color:var(--warn)">‚óÜ ${d}</div>`).join('')}
      <div style="margin-top:8px;color:var(--i4);font-size:10px">
        SPR: ${spr} ¬∑ ${heroInPosition?'In Position':'Out of Position'}
      </div>`;
  }

  updateTrainerStats();
}

function trainerAction(action){
  if(!TRAINER.currentSpot)return;
  const{correctAction,gtoEV,reasoning,heroPos,villainPos,street,heroEval,draws,villainBet,potBB,bb,spr}=TRAINER.currentSpot;
  const isCorrect=action===correctAction;

  // Highlight action buttons
  ['fold','check','call','bet'].forEach(a=>{
    const btn=$('ab-'+a);
    if(!btn||btn.style.display==='none')return;
    btn.classList.remove('correct','wrong');
    if(a===action)btn.classList.add(isCorrect?'correct':'wrong');
    if(a===correctAction&&!isCorrect)btn.classList.add('correct');
  });

  TRAINER.played++;
  if(isCorrect)TRAINER.correct++;
  TRAINER.totalEV+=gtoEV;
  TRAINER.history.push({street,action,correct:isCorrect,ev:gtoEV});

  // Grade based on EV and correctness
  let grade,verdict;
  const evDiff=isCorrect?0:gtoEV+0.3;
  if(isCorrect&&gtoEV>1.5){grade='A+';verdict='Perfect ‚Äî max value extracted';}
  else if(isCorrect&&gtoEV>0.8){grade='A';verdict='Correct ‚Äî solid value play';}
  else if(isCorrect){grade='B+';verdict='Correct ‚Äî disciplined spot';}
  else if(evDiff<0.4){grade='B';verdict='Close ‚Äî small mistake, marginal EV loss';}
  else if(evDiff<1.0){grade='C';verdict='Mistake ‚Äî notable EV leak here';}
  else{grade='D';verdict='Big error ‚Äî significant chips left on the table';}

  const gradeEl=$('fb-grade');gradeEl.textContent=grade;gradeEl.className='fb-grade '+grade[0];
  $('fb-verdict').textContent=verdict;

  // EV row
  const actionEVMap={fold:0,check:gtoEV*0.35,call:gtoEV*0.6,bet:gtoEV};
  const yourEV=actionEVMap[action]!==undefined?actionEVMap[action]:0;
  const evLost=isCorrect?0:parseFloat((gtoEV-yourEV).toFixed(2));
  $('fb-ev-row').innerHTML=`
    <div class="fb-ev"><div class="fb-ev-val" style="color:${yourEV>=0?'var(--pos)':'var(--neg)'}">${yourEV>=0?'+':''}${yourEV.toFixed(2)}BB</div><div class="fb-ev-lbl">Your EV</div></div>
    <div class="fb-ev"><div class="fb-ev-val" style="color:${gtoEV>=0?'var(--au)':'var(--neg)'}">${gtoEV>=0?'+':''}${gtoEV.toFixed(2)}BB</div><div class="fb-ev-lbl">Best EV</div></div>
    <div class="fb-ev"><div class="fb-ev-val" style="color:${evLost===0?'var(--pos)':'var(--neg)'}">${evLost===0?'0.00':'-'+evLost.toFixed(2)}BB</div><div class="fb-ev-lbl">EV Lost</div></div>`;

  $('fb-spot-info').innerHTML=`<strong>${heroEval.name}</strong>${draws.length?' + '+draws.join(', '):''}  ¬∑  ${street}  ¬∑  ${heroPos} vs ${villainPos}  ¬∑  SPR ${spr}  ¬∑  GTO: <strong style="color:var(--au)">${correctAction.toUpperCase()}</strong>  ¬∑  You: <strong style="color:${isCorrect?'var(--pos)':'var(--neg)'}">${action.toUpperCase()}</strong>`;

  // AI analysis
  const fb=$('fb-analysis');
  fb.textContent='Generating analysis‚Ä¶';
  fb.className='fb-analysis loading';
  $('feedback-box').classList.add('show');

  getPostflopAI(TRAINER.currentSpot,action,correctAction,gtoEV,isCorrect,grade).then(txt=>{
    fb.textContent=txt;fb.className='fb-analysis';
  }).catch(()=>{
    fb.textContent=reasoning+` You ${action==='fold'?'folded':'chose '+action}${isCorrect?' ‚Äî correct!':' ‚Äî the better line is to '+correctAction}.`;
    fb.className='fb-analysis';
  });

  updateTrainerStats();
  TRAINER.currentSpot=null;
}

async function getPostflopAI(spot,played,correct,ev,isCorrect,grade){
  const{heroHole,board,street,heroPos,villainPos,heroEval,draws,villainBet,potBB,bb,spr,potOdds,heroInPosition}=spot;
  const handStr=heroHole.map(c=>c.r+c.s).join('');
  const boardStr=board.map(c=>c.r+c.s).join(' ');
  const resp=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',max_tokens:250,
      system:'You are a sharp poker coach. Analyze this postflop spot in 2-3 sentences. Be specific: mention hand strength, draws, position, pot odds, SPR, and whether betting/checking/calling/folding is correct and why. No fluff, no pleasantries.',
      messages:[{role:'user',content:`Hand: ${handStr} | Board: ${boardStr} | Street: ${street} | Hero: ${heroPos} (${heroInPosition?'IP':'OOP'}) | Villain: ${villainPos} | Hero hand: ${heroEval.name}${draws.length?' + '+draws.join(', '):''} | Villain bet: ${villainBet>0?`$${(villainBet*bb).toFixed(0)}`:'checked'} | Pot: ${potBB}BB | SPR: ${spr}${potOdds?' | Pot odds: '+potOdds+'%':''} | Player action: ${played} | Correct action: ${correct} | Grade: ${grade} | EV: ${ev.toFixed(2)}BB`}]
    })
  });
  if(!resp.ok)throw new Error('API error');
  const data=await resp.json();
  return data.content?.map(c=>c.type==='text'?c.text:'').join('')||'Analysis unavailable.';
}

function updateTrainerStats(){
  $('tr-played').textContent=TRAINER.played;
  $('tr-correct').textContent=TRAINER.correct;
  const acc=TRAINER.played>0?Math.round(TRAINER.correct/TRAINER.played*100):null;
  $('tr-acc').textContent=acc!==null?acc+'%':'‚Äî';
  if(acc!==null)$('tr-acc').className='ts-val '+(acc>=70?'pos':acc<50?'neg':'au');
  const avgEV=TRAINER.played>0?TRAINER.totalEV/TRAINER.played:null;
  $('tr-ev').textContent=avgEV!==null?(avgEV>=0?'+':'')+avgEV.toFixed(2)+'BB':'‚Äî';
  if(avgEV!==null)$('tr-ev').className='ts-val '+(avgEV>=0.5?'pos':avgEV<0?'neg':'au');
  if(TRAINER.history.length>0){
    const streetMap={};TRAINER.history.forEach(h=>{if(!streetMap[h.street])streetMap[h.street]={c:0,t:0};streetMap[h.street].t++;if(h.correct)streetMap[h.street].c++;});
    const best=Object.entries(streetMap).sort((a,b)=>(b[1].c/b[1].t)-(a[1].c/a[1].t))[0];
    const worst=Object.entries(streetMap).sort((a,b)=>(a[1].c/a[1].t)-(b[1].c/b[1].t))[0];
    if(best)$('tr-best').textContent=best[0];
    if(worst)$('tr-weak').textContent=worst[0];
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBAL REFRESH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateHeader(){
  const act=G.players.filter(p=>p.status==='active');
  $('h-players').textContent=act.length;
  $('h-pot').textContent=money(act.reduce((s,p)=>s+p.currentStack,0));
}
function refresh(){
  updateHeader();
  if(activeTab==='dash')    renderDash();
  if(activeTab==='players') renderPlayerPanel();
  if(activeTab==='table')   renderTable();
  if(activeTab==='chips')   populatePickers();
  if(activeTab==='hands')   renderHands();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CLOSE MODALS / RESIZE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on')}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.overlay.on').forEach(m=>m.classList.remove('on'))});
let rsz;window.addEventListener('resize',()=>{clearTimeout(rsz);rsz=setTimeout(()=>{if(activeTab==='table')renderTable();},200)});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
buildBG();
buildDenomUI();
setTimeout(renderDash,80);
toast("Moon's ‚Äî ready to deal");
</script>
</body>
</html>
