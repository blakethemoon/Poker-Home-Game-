<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Moon's">
<meta name="theme-color" content="#06040f">
<title>Moon's Home Game</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06040f;--s1:#0d0a1a;--s2:#131020;--s3:#1a1628;--s4:#211d32;--s5:#2a2540;
  --i0:#fff;--i1:#e8e2ff;--i2:#9b91c4;--i3:#4e4670;--i4:#2c2848;
  --cy:#00d4ff;--cy2:#00a8cc;--cy3:rgba(0,212,255,.12);
  --mg:#ff006e;--mg2:#cc0057;--mg3:rgba(255,0,110,.1);
  --ag:#39ff14;--ag2:#2acc0f;--ag3:rgba(57,255,20,.1);
  --au:#e8b84b;--au2:#c49430;--au3:rgba(232,184,75,.1);
  --neg:#ff4560;--neg3:rgba(255,69,96,.1);
  --br:rgba(255,255,255,.06);--brc:rgba(0,212,255,.18);--brm:rgba(255,0,110,.18);
  --r4:4px;--r6:6px;--r8:8px;--r10:10px;--r12:12px;--r16:16px;
  --glow-cy:0 0 20px rgba(0,212,255,.35),0 0 40px rgba(0,212,255,.15);
  --glow-mg:0 0 20px rgba(255,0,110,.35),0 0 40px rgba(255,0,110,.15);
  --glow-ag:0 0 20px rgba(57,255,20,.35),0 0 40px rgba(57,255,20,.15);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{background:var(--bg);color:var(--i1);font-family:'Syne',sans-serif;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;line-height:1.5}

/* ‚îÄ‚îÄ BG ‚îÄ‚îÄ */
#bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.orb{position:absolute;border-radius:50%;animation:drift var(--t,22s) ease-in-out infinite alternate;will-change:transform;mix-blend-mode:screen}
@keyframes drift{from{transform:translate(0,0) scale(1)}to{transform:translate(var(--dx,20px),var(--dy,-15px)) scale(1.08)}}
.grid-overlay{position:absolute;inset:0;background-image:linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);background-size:48px 48px}
.scanline{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}

/* ‚îÄ‚îÄ SHELL ‚îÄ‚îÄ */
#app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100dvh}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{height:64px;background:rgba(6,4,15,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--br);display:flex;align-items:center;padding:0 22px;gap:16px;position:sticky;top:0;z-index:300;flex-shrink:0}
.topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cy),transparent);opacity:.3}
.wm{display:flex;align-items:center;gap:11px;margin-right:auto}
.wm-logo{flex-shrink:0;height:40px;width:40px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 2px rgba(168,85,247,.5),0 0 14px rgba(168,85,247,.4)}
.wm-name{font-family:'Instrument Serif',serif;font-size:24px;color:var(--i0);letter-spacing:.01em;line-height:1;text-shadow:0 0 30px rgba(0,212,255,.4)}
.wm-dot{width:6px;height:6px;border-radius:50%;background:var(--cy);box-shadow:var(--glow-cy);flex-shrink:0;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.4)}}
.wm-sub{font-size:10px;color:var(--i3);letter-spacing:.1em;text-transform:uppercase;margin-top:2px}
.hs{text-align:right}
.hs-v{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--i0);line-height:1}
.hs-l{font-size:11px;letter-spacing:.05em;text-transform:uppercase;color:var(--i3);margin-top:3px}
.live-badge{display:flex;align-items:center;gap:6px;border:1px solid rgba(57,255,20,.25);background:rgba(57,255,20,.06);padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ag)}
.ldot{width:5px;height:5px;border-radius:50%;background:var(--ag);box-shadow:var(--glow-ag);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav{background:rgba(6,4,15,.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--br);display:flex;overflow-x:auto;padding:0 18px;scrollbar-width:none;flex-shrink:0;position:sticky;top:64px;z-index:200}
.nav::-webkit-scrollbar{display:none}
.nvb{flex-shrink:0;padding:16px 20px;background:none;border:none;border-bottom:2px solid transparent;color:var(--i3);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:color .14s,border-color .14s,text-shadow .14s;touch-action:manipulation}
.nvb:hover{color:var(--i2)}
.nvb.on{color:var(--cy);border-bottom-color:var(--cy);text-shadow:0 0 12px rgba(0,212,255,.5)}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{flex:1;padding:22px;max-width:1280px;width:100%;margin:0 auto}
.view{display:none}
.view.on{display:block;animation:fadeUp .18s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--s1);border:1px solid var(--br);border-radius:var(--r12);padding:24px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,212,255,.12),transparent);pointer-events:none}
.card-cyan{border-color:var(--brc);box-shadow:inset 0 0 30px rgba(0,212,255,.04)}
.card-magenta{border-color:var(--brm);box-shadow:inset 0 0 30px rgba(255,0,110,.04)}
.card-cyan::before{background:linear-gradient(90deg,transparent,rgba(0,212,255,.3),transparent)}
.card-magenta::before{background:linear-gradient(90deg,transparent,rgba(255,0,110,.3),transparent)}
.chd{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.ctitle{font-size:13px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--i3)}
.ctitle.cy{color:var(--cy)}

/* ‚îÄ‚îÄ GRID HELPERS ‚îÄ‚îÄ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.col{display:flex;flex-direction:column;gap:18px}
.chip-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
.row{display:flex;gap:10px}
.flex{display:flex;gap:8px}
.fc{display:flex;align-items:center;gap:8px}
.fb{display:flex;justify-content:space-between;align-items:center}
.mt4{margin-top:4px}.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
.mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}

/* ‚îÄ‚îÄ STAT TILES ‚îÄ‚îÄ */
.stile{background:var(--s2);border:1px solid var(--br);border-radius:var(--r10);padding:20px 22px;position:relative;overflow:hidden;transition:border-color .2s}
.stile:hover{border-color:var(--brc)}
.stile-v{font-family:'DM Mono',monospace;font-size:30px;font-weight:500;color:var(--i0);line-height:1;margin-bottom:7px}
.stile-v.cy{color:var(--cy);text-shadow:0 0 16px rgba(0,212,255,.5)}
.stile-v.mg{color:var(--mg);text-shadow:0 0 16px rgba(255,0,110,.4)}
.stile-v.ag{color:var(--ag);text-shadow:0 0 16px rgba(57,255,20,.4)}
.stile-v.au{color:var(--au)}
.stile-v.neg{color:var(--neg)}
.stile-l{font-size:12px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--i3)}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.lbl{display:block;font-size:13px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;color:var(--i3);margin-bottom:8px}
.inp,.sel{width:100%;background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:13px 16px;color:var(--i1);font-family:'Syne',sans-serif;font-size:15px;outline:none;transition:border-color .12s,box-shadow .12s;-webkit-appearance:none;appearance:none;caret-color:var(--cy)}
.inp::placeholder{color:var(--i4)}.inp:focus,.sel:focus{border-color:var(--brc);box-shadow:0 0 0 3px rgba(0,212,255,.08)}
.sel{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%234e4670' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer}
.sel option{background:#13102020}.fg{margin-bottom:16px}
.inp-sm{padding:10px 13px;font-size:14px}.inp-xs{padding:7px 10px;font-size:13px;border-radius:var(--r6)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:13px 22px;border-radius:var(--r8);border:1px solid var(--br);background:var(--s3);color:var(--i2);font-family:'Syne',sans-serif;font-size:14px;font-weight:600;letter-spacing:.02em;cursor:pointer;white-space:nowrap;transition:all .12s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.btn:hover{background:var(--s4);color:var(--i1);border-color:var(--brc)}.btn:active{opacity:.7;transform:scale(.97)}
.btn-cy{background:var(--cy3);border-color:var(--brc);color:var(--cy)}
.btn-cy:hover{background:rgba(0,212,255,.2);box-shadow:var(--glow-cy)}
.btn-mg{background:var(--mg3);border-color:var(--brm);color:var(--mg)}
.btn-mg:hover{background:rgba(255,0,110,.18);box-shadow:var(--glow-mg)}
.btn-ag{background:var(--ag3);border-color:rgba(57,255,20,.25);color:var(--ag)}
.btn-ag:hover{background:rgba(57,255,20,.18);box-shadow:var(--glow-ag)}
.btn-au{background:var(--au3);border-color:rgba(232,184,75,.28);color:var(--au)}
.btn-au:hover{background:rgba(232,184,75,.18)}
.btn-neg{background:var(--neg3);border-color:rgba(255,69,96,.22);color:var(--neg)}
.btn-neg:hover{background:rgba(255,69,96,.16)}
.btn-ghost{background:transparent;border-color:transparent;color:var(--i3)}
.btn-ghost:hover{color:var(--i2);background:var(--s2);border-color:var(--br)}
.btn-solid-cy{background:var(--cy);border-color:var(--cy);color:#04080a;font-weight:700}
.btn-solid-cy:hover{background:#1ae0ff;box-shadow:var(--glow-cy)}
.btn-sm{padding:9px 18px;font-size:13px}.btn-xs{padding:7px 13px;font-size:12px;border-radius:var(--r6)}.btn-full{width:100%}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tscroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:480px}
thead th{padding:12px 14px;text-align:left;font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--i3);border-bottom:1px solid var(--br)}
tbody td{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.03);font-size:15px;vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(0,212,255,.03)}
.mono{font-family:'DM Mono',monospace;font-size:14px}
.cy{color:var(--cy)}.mg{color:var(--mg)}.ag{color:var(--ag)}.au{color:var(--au)}.neg{color:var(--neg)}.dim{color:var(--i3)}.i2{color:var(--i2)}
.pname{font-size:15px;font-weight:600;color:var(--i0)}
.ppnl-pos{color:var(--ag);font-family:'DM Mono',monospace;font-size:14px}
.ppnl-neg{color:var(--neg);font-family:'DM Mono',monospace;font-size:14px}
.ppnl-zero{color:var(--i3);font-family:'DM Mono',monospace;font-size:14px}

/* ‚îÄ‚îÄ DASH LAYOUT ‚îÄ‚îÄ */
.dash-grid{display:grid;grid-template-columns:1fr 320px;gap:20px;align-items:start}
.dash-main{display:flex;flex-direction:column;gap:20px}
.dash-side{display:flex;flex-direction:column;gap:18px}

/* ‚îÄ‚îÄ PLAYER ROWS ‚îÄ‚îÄ */
.p-row{display:flex;align-items:center;gap:12px;padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;transition:background .12s,border-color .12s;border-radius:var(--r8);border:1px solid transparent;margin-bottom:4px}
.p-row:hover{background:rgba(0,212,255,.04);border-color:var(--brc)}
.p-row.selected{background:rgba(0,212,255,.06);border-color:var(--brc)}
.p-seat{width:34px;height:34px;border-radius:50%;background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--i3);flex-shrink:0}
.p-row.selected .p-seat{background:var(--cy3);border-color:var(--brc);color:var(--cy)}
.p-name{flex:1;font-size:16px;font-weight:600;color:var(--i0)}
.p-stack{font-family:'DM Mono',monospace;font-size:15px;color:var(--au)}

/* ‚îÄ‚îÄ FEED ‚îÄ‚îÄ */
.feed-item{display:flex;gap:12px;align-items:flex-start;padding:13px 0;border-bottom:1px solid rgba(255,255,255,.03);animation:slideIn .18s ease both}
.feed-item.feed-new{background:rgba(0,212,255,.03);border-radius:var(--r6);padding:10px 9px;margin:0 -9px;animation:feedFlash .6s ease both}
@keyframes feedFlash{0%{background:rgba(0,212,255,.1)}100%{background:rgba(0,212,255,.03)}}
.feed-item:last-child{border-bottom:none}
.feed-ico{width:34px;height:34px;border-radius:var(--r8);background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.feed-body{flex:1;min-width:0}
.feed-t{font-size:15px;font-weight:500;color:var(--i1);line-height:1.4}
.feed-m{font-size:13px;color:var(--i3);margin-top:3px}
.feed-time{font-family:'DM Mono',monospace;font-size:12px;color:var(--i4);flex-shrink:0;margin-top:2px}

/* ‚îÄ‚îÄ BAR CHARTS ‚îÄ‚îÄ */
.bar-row{display:flex;align-items:center;gap:9px;margin-bottom:7px}
.bar-row:last-child{margin-bottom:0}
.bar-n{font-size:14px;color:var(--i2);min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:4px;background:var(--s3);border-radius:3px;overflow:hidden}
/* Felt seat avatars */
.felt-seat{position:absolute;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;transition:transform .12s}
.felt-seat:hover{transform:translate(-50%,-50%) scale(1.08)}
.felt-avatar{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;border:2px solid rgba(255,255,255,.15);box-shadow:0 2px 12px rgba(0,0,0,.6)}
.felt-avatar.active{border-width:2.5px;box-shadow:0 0 14px rgba(0,212,255,.35)}
.felt-avatar.empty{background:rgba(255,255,255,.04);border-style:dashed;border-color:rgba(255,255,255,.15)}
.felt-name{font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.9);white-space:nowrap;max-width:68px;overflow:hidden;text-overflow:ellipsis;text-align:center;margin-top:1px}
.felt-stack{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--au);text-align:center;white-space:nowrap;text-shadow:0 0 8px rgba(232,184,75,.4)}
.felt-sub{font-size:9px;text-align:center;white-space:nowrap;opacity:.8}
.bar-fill{height:100%;border-radius:3px;transition:width .45s ease}
.bar-pct{font-family:'DM Mono',monospace;font-size:11px;color:var(--i3);min-width:30px;text-align:right}
/* Scroll caps ‚Äî prevent page-level scroll on long lists */
#d-score-list{max-height:52vh;overflow-y:auto}
#pl-list{max-height:40vh;overflow-y:auto;padding-right:2px}
/* ‚îÄ‚îÄ FELT TABLE NEON STYLING ‚îÄ‚îÄ */
#d-felt-oval{
  position:absolute;inset:0;border-radius:50%;
  background:radial-gradient(ellipse at 50% 38%,#0e3d1c,#071510,#030a05);
  border:3px solid rgba(168,85,247,.55);
  box-shadow:
    0 0 0 1px rgba(0,212,255,.2),
    0 0 18px rgba(168,85,247,.65),
    0 0 45px rgba(168,85,247,.35),
    0 0 80px rgba(0,212,255,.18),
    inset 0 0 55px rgba(0,0,0,.65),
    inset 0 0 25px rgba(168,85,247,.06);
}
/* Full-width live table card above dash-grid */
#d-players-card{margin-bottom:20px}
#d-players-card .chd-live-dot{display:none}
#d-players-card.table-live{
  border-color:rgba(168,85,247,.35);
  background:rgba(168,85,247,.03);
}
#d-players-card.table-live .chd-live-dot{display:inline-block}
#d-players-card.table-live #d-felt{aspect-ratio:3/1}
#d-players-card.table-live #d-felt-oval{
  border-color:rgba(168,85,247,.7);
  box-shadow:
    0 0 0 1px rgba(0,212,255,.25),
    0 0 25px rgba(168,85,247,.8),
    0 0 60px rgba(168,85,247,.45),
    0 0 110px rgba(0,212,255,.2),
    inset 0 0 70px rgba(0,0,0,.7),
    inset 0 0 30px rgba(168,85,247,.08);
}

/* ‚îÄ‚îÄ TABLE VISUAL ‚îÄ‚îÄ */
.table-scene{display:flex;justify-content:center;padding:12px 0 16px;position:relative}
.t-wrap{position:relative}
.felt{border-radius:50%;background:radial-gradient(ellipse at 40% 36%,#0d2e1b,#071408,#040b06);border:5px solid rgba(0,212,255,.08);box-shadow:inset 0 0 60px rgba(0,0,0,.8),0 0 0 1px rgba(0,212,255,.05),0 0 40px rgba(0,212,255,.07),0 8px 40px rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
.felt-inner{text-align:center;pointer-events:none}
.fi-lbl{font-size:7px;letter-spacing:.24em;color:rgba(0,212,255,.3);text-transform:uppercase;margin-bottom:4px}
.fi-pot{font-family:'DM Mono',monospace;font-weight:500;color:var(--cy);line-height:1;text-shadow:var(--glow-cy)}
.fi-sub{font-size:7px;letter-spacing:.16em;color:rgba(255,255,255,.14);text-transform:uppercase;margin-top:3px}
.seat-node{position:absolute;transform:translate(-50%,-50%);cursor:pointer;transition:transform .12s}
.seat-node:hover{transform:translate(-50%,-50%) scale(1.08)}
.sc{background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);text-align:center;transition:all .12s;position:relative;overflow:hidden}
.seat-node:hover .sc{border-color:var(--brc)}
.sc.occ{border-color:rgba(0,212,255,.2);background:rgba(0,212,255,.04)}
.sc.occ::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:var(--cy)}
.sc.emp{opacity:.32;border-style:dashed}
.sc.big{border-color:rgba(57,255,20,.25)}.sc.big::before{background:var(--ag)}
.sc.sht{border-color:rgba(255,69,96,.25)}.sc.sht::before{background:var(--neg)}
.sn-num{font-size:7px;letter-spacing:.1em;color:var(--i3);margin-bottom:1px}
.sn-name{font-size:9px;font-weight:700;color:var(--i1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px;letter-spacing:.02em}
.sn-stack{font-family:'DM Mono',monospace;font-size:9px;color:var(--cy)}
.sn-stack.up{color:var(--ag)}.sn-stack.dn{color:var(--neg)}
.sn-open{font-size:7px;color:var(--i4)}

/* ‚îÄ‚îÄ PLAYER DETAIL PANEL ‚îÄ‚îÄ */
.pd-name{font-family:'Instrument Serif',serif;font-size:34px;color:var(--i0);line-height:1;margin-bottom:6px;text-shadow:0 0 30px rgba(0,212,255,.2)}
.pd-meta{font-size:13px;color:var(--i3);letter-spacing:.03em;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.pd-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.pd-stat{background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:16px 18px}
.pd-stat-v{font-family:'DM Mono',monospace;font-size:24px;font-weight:500;line-height:1;margin-bottom:6px}
.pd-stat-l{font-size:12px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;color:var(--i3)}
.addon-log{display:flex;flex-direction:column;gap:4px;max-height:150px;overflow-y:auto}
.addon-line{display:flex;align-items:center;gap:10px;padding:10px 13px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);font-size:14px}
.atag{font-size:9px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:2px 7px;border-radius:3px}
.atag.bi{background:var(--cy3);color:var(--cy)}.atag.rb{background:var(--au3);color:var(--au)}
.addon-amt{font-family:'DM Mono',monospace;font-size:12px;color:var(--i0);font-weight:500;margin-left:3px}
.addon-when{font-family:'DM Mono',monospace;font-size:10px;color:var(--i3);margin-left:auto}
.co-result-box{border-radius:var(--r8);padding:16px;text-align:center;border:1px solid var(--br);background:var(--s2);margin:10px 0;display:none}
.co-net{font-family:'DM Mono',monospace;font-size:36px;font-weight:500;line-height:1}
.co-net.pos{color:var(--ag);text-shadow:var(--glow-ag)}.co-net.neg{color:var(--neg);text-shadow:0 0 16px rgba(255,69,96,.4)}
.co-sub{font-size:11px;color:var(--i3);margin-top:5px;letter-spacing:.04em}

/* ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ */
.denom-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
.denom-item{background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:10px 12px;display:flex;align-items:center;gap:9px}
.denom-dot{width:16px;height:16px;border-radius:50%;flex-shrink:0;border:2px solid rgba(255,255,255,.15)}
.denom-name{font-size:12px;color:var(--i2);font-weight:600;flex:1}
.denom-val{font-family:'DM Mono',monospace;font-size:12px;color:var(--au);min-width:40px;text-align:right}
.denom-inp{width:60px;background:var(--s1);border:1px solid var(--br);border-radius:var(--r4);padding:5px 8px;color:var(--au);font-family:'DM Mono',monospace;font-size:13px;outline:none;text-align:center;caret-color:var(--cy)}
.denom-inp:focus{border-color:var(--brc)}
.upload-zone{border:1px dashed rgba(0,212,255,.2);border-radius:var(--r8);padding:28px 16px;text-align:center;cursor:pointer;transition:all .12s;background:var(--s2)}
.upload-zone:hover,.upload-zone.dov{border-color:var(--cy);background:var(--cy3);box-shadow:0 0 20px rgba(0,212,255,.08)}
.up-icon{font-size:28px;margin-bottom:7px;display:block;opacity:.6}
.up-text{font-size:13px;font-weight:600;color:var(--i2);margin-bottom:3px}
.up-sub{font-size:11px;color:var(--i4)}
.chip-prev-img{width:100%;max-height:200px;object-fit:contain;border-radius:var(--r6);border:1px solid var(--br);margin-bottom:11px;display:none}
.spin{display:inline-block;animation:spin .7s linear infinite;font-size:20px;margin-bottom:5px}
@keyframes spin{to{transform:rotate(360deg)}}
.result-box{display:none;border:1px solid var(--brc);background:var(--cy3);border-radius:var(--r8);padding:15px;text-align:center;animation:fadeUp .2s ease both}
.res-total{font-family:'DM Mono',monospace;font-size:38px;font-weight:500;color:var(--cy);line-height:1;text-shadow:var(--glow-cy)}
.res-lbl{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:var(--i3);margin:6px 0 13px}
.res-chips{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.rchip{background:var(--s3);border:1px solid var(--br);border-radius:var(--r6);padding:7px 10px;display:flex;align-items:center;gap:8px}
.rchip-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.rchip-n{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;line-height:1;min-width:26px;text-align:center}
.rchip-l{font-size:11px;color:var(--i3);flex:1}
.rchip-adj{background:none;border:1px solid var(--br);border-radius:var(--r4);color:var(--cy);font-size:15px;width:24px;height:24px;cursor:pointer;padding:0;line-height:1;flex-shrink:0}
.rchip-adj:hover{background:var(--cy3)}
.res-desc{font-size:11px;color:var(--i3);font-style:italic}
.pp-list{display:flex;flex-direction:column;gap:5px}
.pp-row{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--r6);border:1px solid var(--br);background:var(--s2);cursor:pointer;transition:all .11s}
.pp-row:hover{border-color:var(--brc);background:var(--s3)}
.pp-row.sel{border-color:var(--brc);background:var(--cy3)}
.pp-name{flex:1;font-size:13px;font-weight:600;color:var(--i1)}
.pp-stack{font-family:'DM Mono',monospace;font-size:11px;color:var(--au)}

/* ‚îÄ‚îÄ CASH OUT PAGE ‚îÄ‚îÄ */
.co-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
.co-player-list{display:flex;flex-direction:column;gap:4px;max-height:44vh;overflow-y:auto;padding-right:3px}
.co-player-card{background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:8px 12px;cursor:pointer;transition:all .12s}
.co-player-card:hover{border-color:var(--brc);background:var(--s3)}
.co-player-card.selected{border-color:var(--brc);background:var(--cy3)}
.co-player-card.cashed{border-color:rgba(57,255,20,.2);background:var(--ag3)}
.co-player-card.owes{border-color:rgba(255,69,96,.2)}
.co-row{display:flex;align-items:center;gap:8px}
.co-name{flex:1;font-size:13px;font-weight:600;color:var(--i0)}
.co-status-badge{font-size:10px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;padding:2px 8px;border-radius:20px;border:1px solid;flex-shrink:0}
.csb-pending{border-color:rgba(255,178,0,.3);color:#ffb200;background:rgba(255,178,0,.08)}
.csb-paid{border-color:rgba(57,255,20,.3);color:var(--ag);background:var(--ag3)}
.csb-collect{border-color:rgba(255,69,96,.3);color:var(--neg);background:var(--neg3)}
.settle-row{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);margin-bottom:8px}
.settle-name{flex:1;font-size:16px;font-weight:600;color:var(--i0)}
.settle-amt{font-family:'DM Mono',monospace;font-size:18px;font-weight:500}
.settle-check{width:22px;height:22px;border-radius:50%;border:2px solid var(--br);background:var(--s3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .12s;flex-shrink:0}
.settle-check.done{background:var(--ag);border-color:var(--ag);box-shadow:var(--glow-ag)}
.settle-check.done::after{content:'‚úì';color:#030a02;font-weight:700;font-size:10px}

/* ‚îÄ‚îÄ TRAINER ‚îÄ‚îÄ */
.trainer-grid{display:grid;grid-template-columns:1fr 300px;gap:20px;align-items:start}
.trainer-main{display:flex;flex-direction:column;gap:18px}
.trainer-side{display:flex;flex-direction:column;gap:18px}
.playing-card{border-radius:8px;padding:6px;box-shadow:0 4px 20px rgba(0,0,0,.6);position:relative;display:flex;flex-direction:column;justify-content:space-between}
.playing-card.red .rank,.playing-card.red .suit-ctr{color:#dc2626}
.playing-card.black .rank,.playing-card.black .suit-ctr{color:#111}
.action-btn{padding:12px 6px;border-radius:var(--r8);border:1px solid var(--br);background:var(--s2);color:var(--i2);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.03em;cursor:pointer;text-align:center;transition:all .12s;touch-action:manipulation}
.action-btn:hover{background:var(--s3);border-color:var(--brc);color:var(--i1)}
.ab-fold{border-color:rgba(255,69,96,.22);color:var(--neg)}.ab-fold:hover{background:rgba(255,69,96,.1)}
.ab-check{border-color:rgba(0,212,255,.22);color:var(--cy)}.ab-check:hover{background:var(--cy3)}
.ab-call{border-color:rgba(57,255,20,.22);color:var(--ag)}.ab-call:hover{background:var(--ag3)}
.ab-bet{border-color:rgba(232,184,75,.22);color:var(--au)}.ab-bet:hover{background:var(--au3)}
.action-btn.correct{background:rgba(57,255,20,.18)!important;border-color:var(--ag)!important;color:var(--ag)!important;box-shadow:var(--glow-ag)}
.action-btn.wrong{background:rgba(255,69,96,.14)!important;border-color:var(--neg)!important;color:var(--neg)!important}
.feedback-box{display:none;background:var(--s2);border:1px solid var(--brc);border-radius:var(--r10);padding:16px;animation:fadeUp .2s ease both}
.feedback-box.show{display:block}
.fb-grade{font-family:'Instrument Serif',serif;font-size:52px;line-height:1;margin-bottom:4px}
.fb-grade.A{color:var(--ag);text-shadow:var(--glow-ag)}
.fb-grade.B{color:var(--cy);text-shadow:var(--glow-cy)}
.fb-grade.C{color:var(--au)}
.fb-grade.D,.fb-grade.F{color:var(--neg);text-shadow:0 0 16px rgba(255,69,96,.4)}
.fb-verdict{font-size:14px;font-weight:700;color:var(--i0);margin-bottom:10px}
.fb-ev-row{display:flex;gap:8px;margin-bottom:11px;flex-wrap:wrap}
.fb-ev{background:var(--s3);border:1px solid var(--br);border-radius:var(--r6);padding:8px 11px;text-align:center;flex:1;min-width:72px}
.fb-ev-v{font-family:'DM Mono',monospace;font-size:15px;font-weight:500;line-height:1;margin-bottom:2px}
.fb-ev-l{font-size:10px;letter-spacing:.06em;text-transform:uppercase;color:var(--i3)}
.fb-analysis{font-size:13px;color:var(--i2);line-height:1.7;margin-bottom:11px;padding-left:11px;border-left:2px solid var(--s4)}
.fb-analysis.loading{color:var(--i4);font-style:italic}
.fb-spot{font-size:11px;color:var(--i3);padding:9px 11px;background:var(--s1);border-radius:var(--r6);border:1px solid var(--br);line-height:1.6}
.street-progress{display:flex;gap:6px;margin-bottom:14px}
.sp-dot{flex:1;height:4px;border-radius:3px;background:var(--s3);transition:all .3s}
.sp-dot.done{background:var(--ag)}
.sp-dot.active{background:var(--cy);box-shadow:0 0 8px rgba(0,212,255,.5)}
.sp-lbl{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--i3);text-align:center;margin-top:4px}
.trainer-table{width:100%;aspect-ratio:2/1;position:relative;margin-bottom:14px}
.trainer-felt{width:100%;height:100%;border-radius:50%;background:radial-gradient(ellipse,#0d2e1b,#071408);border:3px solid rgba(0,212,255,.1);box-shadow:0 0 30px rgba(0,212,255,.06),inset 0 0 40px rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
.tr-stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--br)}
.tr-stat-row:last-child{border-bottom:none}
.tr-sl{font-size:13px;color:var(--i3)}.tr-sv{font-family:'DM Mono',monospace;font-size:14px;color:var(--i0);font-weight:500}
.tr-sv.pos{color:var(--ag)}.tr-sv.neg{color:var(--neg)}.tr-sv.cy{color:var(--cy)}

@keyframes slideIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}

/* ‚îÄ‚îÄ SESSION CLOSED BANNER ‚îÄ‚îÄ */
#co-closed-banner{background:rgba(57,255,20,.07);border:1px solid rgba(57,255,20,.25);border-radius:var(--r8);padding:12px 16px;margin-bottom:14px;align-items:center;gap:12px}
.invite-hero{background:linear-gradient(135deg,var(--s2),var(--s1));border:1px solid var(--brc);border-radius:var(--r12);padding:36px;text-align:center;margin-bottom:20px;position:relative;overflow:hidden}
.invite-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0,rgba(0,212,255,.12),transparent 70%)}
.invite-title{font-family:'Instrument Serif',serif;font-size:38px;color:var(--i0);margin-bottom:6px;text-shadow:0 0 30px rgba(0,212,255,.4)}
.invite-sub{font-size:14px;color:var(--i3);letter-spacing:.04em}
.rsvp-list{display:flex;flex-direction:column;gap:6px}
.rsvp-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r10);transition:all .12s}
.rsvp-item.in{border-color:rgba(57,255,20,.2);background:var(--ag3)}
.rsvp-item.maybe{border-color:rgba(232,184,75,.2);background:var(--au3)}
.rsvp-avatar{width:38px;height:38px;border-radius:50%;background:var(--s3);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.rsvp-name{flex:1;font-size:16px;font-weight:600;color:var(--i0)}
.rsvp-status{font-size:11px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;padding:4px 11px;border-radius:20px;border:1px solid}
.rs-in{border-color:rgba(57,255,20,.3);color:var(--ag);background:var(--ag3)}
.rs-out{border-color:rgba(255,69,96,.3);color:var(--neg);background:var(--neg3)}
.rs-maybe{border-color:rgba(232,184,75,.3);color:var(--au);background:var(--au3)}
.share-box{background:var(--s2);border:1px solid var(--brc);border-radius:var(--r8);padding:12px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px}
.share-url{flex:1;font-family:'DM Mono',monospace;font-size:12px;color:var(--cy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.invite-form{background:var(--s2);border:1px solid var(--brm);border-radius:var(--r8);padding:16px;margin-bottom:14px}
.invite-form-title{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mg);margin-bottom:12px}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.hist-entry{background:var(--s2);border:1px solid var(--br);border-radius:var(--r10);padding:18px 20px;margin-bottom:10px;cursor:pointer;transition:border-color .12s}
.hist-entry:hover{border-color:var(--brc)}
.hist-date{font-size:12px;font-family:'DM Mono',monospace;color:var(--i3);margin-bottom:5px}
.hist-title{font-size:17px;font-weight:700;color:var(--i0);margin-bottom:7px}
.hist-meta{display:flex;flex-wrap:wrap;gap:14px}
.hist-kv{font-size:13px;color:var(--i3)}
.hist-kv strong{color:var(--au);font-family:'DM Mono',monospace}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty{padding:40px 20px;text-align:center;color:var(--i4)}
.empty-icon{font-size:30px;opacity:.25;margin-bottom:10px;display:block}
.empty-txt{font-size:14px;font-weight:600;letter-spacing:.03em;text-transform:uppercase}
hr{border:none;border-top:1px solid var(--br);margin:12px 0}
.pill{display:inline-block;padding:4px 11px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;border:1px solid}
.pill-act{border-color:rgba(57,255,20,.28);color:var(--ag);background:var(--ag3)}
.pill-out{border-color:rgba(255,69,96,.28);color:var(--neg);background:var(--neg3)}
.pill-csh{border-color:rgba(0,212,255,.28);color:var(--cy);background:var(--cy3)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(3,1,10,.9);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);z-index:800;align-items:center;justify-content:center;padding:14px}
.overlay.on{display:flex}
.modal{background:var(--s1);border:1px solid var(--brc);border-radius:var(--r12);padding:28px;width:100%;max-width:440px;box-shadow:0 0 60px rgba(0,212,255,.12),0 24px 80px rgba(0,0,0,.8);animation:fadeUp .18s ease both;max-height:90dvh;overflow-y:auto}
.modal-t{font-size:19px;font-weight:700;color:var(--i0);margin-bottom:22px;padding-bottom:16px;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center;letter-spacing:.01em}
.mclose{background:none;border:none;color:var(--i3);font-size:16px;cursor:pointer;padding:2px}
.mclose:hover{color:var(--i1)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--s3);border:1px solid var(--brc);border-radius:var(--r8);padding:10px 20px;color:var(--i1);font-size:12px;font-weight:600;z-index:900;opacity:0;transition:all .22s cubic-bezier(.22,1,.36,1);pointer-events:none;max-width:82vw;text-align:center;box-shadow:0 0 20px rgba(0,212,255,.15)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:820px){
  .dash-grid,.co-grid,.trainer-grid,.chip-grid,.g2{grid-template-columns:1fr}
  .g4{grid-template-columns:1fr 1fr}
  .content{padding:16px}
  .topbar{padding:0 16px;height:56px}
  .nav{top:56px}
  .nvb{padding:13px 15px;font-size:12px}
  /* Pre-session strip: stack vertically on mobile */
  .pre-sess-inner{flex-direction:column!important;align-items:stretch!important;gap:14px!important}
  .pre-sess-start{width:100%!important;text-align:center;padding:16px!important}
  /* Action buttons: 2√ó2 on mobile */
  .dash-act-grid{grid-template-columns:1fr 1fr!important}
  /* Hide felt table card on mobile ‚Äî phone is command center */
  #d-players-card{display:none!important}
  #d-share-card,#d-pnl-card{display:none!important}
}
@media(max-width:480px){
  .wm-sub{display:none}
  .g3{grid-template-columns:1fr 1fr}
  .denom-grid{grid-template-columns:1fr}
  .modal{padding:18px}
  table{min-width:420px}
  .content{padding:12px}
  .card{padding:18px}
}
@media(min-width:1100px){
  .content{padding:24px 32px}
  .chip-grid{grid-template-columns:minmax(0,640px) minmax(0,480px)}
  .dash-grid{grid-template-columns:1fr 340px}
  .trainer-grid{grid-template-columns:1fr 340px}
}
@media(min-width:1440px){
  .content{max-width:1480px;padding:28px 40px}
}
</style>
</head>
<body>
<div id="bg">
  <div class="orb" style="width:700px;height:700px;background:radial-gradient(circle,#1a0050,transparent 70%);top:-200px;left:-200px;--t:24s;--dx:22px;--dy:-16px;opacity:.5"></div>
  <div class="orb" style="width:500px;height:500px;background:radial-gradient(circle,#003060,transparent 70%);top:30%;right:-150px;--t:18s;--dx:-18px;--dy:22px;opacity:.4"></div>
  <div class="orb" style="width:400px;height:400px;background:radial-gradient(circle,#001428,transparent 70%);bottom:0;left:30%;--t:14s;--dx:14px;--dy:-20px;opacity:.3"></div>
  <div class="grid-overlay"></div>
  <div class="scanline"></div>
</div>
<div id="app">

<!-- TOPBAR -->
<header class="topbar">
  <div class="wm" style="margin-right:auto">
    <img src="/logo.png" class="wm-logo" alt="Moons Home Game" onerror="this.style.display='none'">
    <div>
      <div class="wm-name">Moon's</div>
      <div class="wm-sub">Home Game</div>
    </div>
  </div>
  <div class="hs"><div class="hs-v" id="h-players">0</div><div class="hs-l">Players</div></div>
  <div class="hs"><div class="hs-v" id="h-pot">$0.00</div><div class="hs-l">In Play</div></div>
  <div class="live-badge"><div class="ldot"></div>Live</div>
</header>

<!-- NAV -->
<nav class="nav">
  <button id="nav-dash"     class="nvb on" onclick="goTab('dash',this)">Home</button>
  <button id="nav-players"  class="nvb"    onclick="goTab('players',this)">Players</button>
  <button id="nav-oracle"   class="nvb"    onclick="goTab('oracle',this)">Wizard</button>
  <button id="nav-cashout"  class="nvb"    onclick="goTab('cashout',this)">Cash Out</button>
  <button id="nav-chips"    class="nvb"    onclick="goTab('chips',this)">Chips</button>
  <button id="nav-hands"    class="nvb"    onclick="goTab('hands',this)">Hands</button>
  <button id="nav-trainer"  class="nvb"    onclick="goTab('trainer',this)">Train</button>
  <button id="nav-invite"   class="nvb"    onclick="goTab('invite',this)">Invite</button>
  <button id="nav-sessions" class="nvb"    onclick="goTab('sessions',this)">History</button>
</nav>

<main class="content">

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
<div class="view on" id="view-dash">

  <!-- SESSION STRIP ‚Äî always visible, shows pre vs active state -->
  <div id="d-session-bar" style="margin-bottom:12px">
    <!-- PRE-SESSION strip -->
    <div id="d-pre-session" style="background:var(--s1);border:1px solid var(--brc);border-radius:var(--r10);padding:28px 24px;position:relative;overflow:hidden">
      <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0,rgba(0,212,255,.08),transparent 70%);pointer-events:none"></div>
      <div class="pre-sess-inner" style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
        <!-- Who's coming chips -->
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:12px">Quick-add players</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
            <div id="pre-roster-chips" style="display:contents"></div>
            <span id="pre-roster-empty" style="display:none;font-size:13px;color:var(--i4)">No roster yet ‚Äî add your first player</span>
            <button class="btn btn-ghost btn-sm" onclick="openAdd()">+ New</button>
          </div>
          <div id="pre-seated-wrap" style="display:none;margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;align-items:center">
            <span style="font-size:12px;color:var(--cy);font-weight:700;letter-spacing:.06em;text-transform:uppercase">Seated:</span>
            <div id="pre-seated-list" style="display:contents"></div>
          </div>
        </div>
        <!-- Start button -->
        <button class="btn btn-solid-cy pre-sess-start" style="font-size:17px;padding:18px 40px;flex-shrink:0;letter-spacing:.04em;font-weight:800" onclick="startSession()">‚ñ∂ Start Game</button>
      </div>
    </div>

    <!-- ACTIVE SESSION strip -->
    <div id="d-active-session" style="display:none">
      <!-- Timer + stats bar -->
      <div style="background:var(--s1);border:1px solid var(--brc);border-radius:var(--r10);padding:18px 22px;margin-bottom:10px;position:relative;overflow:hidden">
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 0 50%,rgba(0,212,255,.05),transparent 60%);pointer-events:none"></div>
        <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:10px;flex-shrink:0">
            <div class="ldot" style="width:9px;height:9px"></div>
            <div class="mono cy" style="font-size:42px;font-weight:500;line-height:1;letter-spacing:.04em" id="d-timer">0:00</div>
          </div>
          <div style="display:flex;gap:24px;flex-wrap:wrap;flex:1">
            <div style="text-align:center"><div class="mono cy" style="font-size:26px;font-weight:500" id="d-players">0</div><div style="font-size:12px;color:var(--i3);letter-spacing:.05em;text-transform:uppercase;margin-top:4px">Players</div></div>
            <div style="text-align:center"><div class="mono au" style="font-size:26px;font-weight:500" id="d-pot">$0</div><div style="font-size:12px;color:var(--i3);letter-spacing:.05em;text-transform:uppercase;margin-top:4px">In Play</div></div>
            <div style="text-align:center"><div class="mono" style="font-size:26px;font-weight:500" id="d-addons">0</div><div style="font-size:12px;color:var(--i3);letter-spacing:.05em;text-transform:uppercase;margin-top:4px">Add-Ons</div></div>
            <div style="text-align:center"><div class="mono" style="font-size:26px;font-weight:500" id="d-hands">0</div><div style="font-size:12px;color:var(--i3);letter-spacing:.05em;text-transform:uppercase;margin-top:4px">Hands</div></div>
          </div>
          <div style="display:flex;gap:8px;flex-shrink:0">
            <button class="btn btn-neg" onclick="openEndNight()">üèÅ End Night</button>
            <button class="btn btn-ghost btn-sm" onclick="openSettings()">‚öô</button>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;align-items:center;gap:9px">
          <span style="font-size:12px;color:var(--i3)">Blinds</span>
          <span class="mono cy" style="font-size:13px" id="d-blinds">$0.10/$0.10</span>
          <span style="color:var(--i4);font-size:12px">¬∑</span>
          <span style="font-size:12px;color:var(--i3)" id="d-game">NL HOLD'EM</span>
        </div>
      </div>

      <!-- 4-button action bar: Add ¬∑ Add-On ¬∑ Log Hand ¬∑ Bust -->
      <div class="dash-act-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px">
        <button class="btn btn-solid-cy" style="padding:20px 8px;font-size:14px;flex-direction:column;gap:6px;display:flex;align-items:center" onclick="openAdd()">
          <span style="font-size:26px;line-height:1">+</span><span>Add Player</span>
        </button>
        <button class="btn btn-au" style="padding:20px 8px;font-size:14px;flex-direction:column;gap:6px;display:flex;align-items:center" onclick="openQuickAddon()">
          <span style="font-size:26px;line-height:1">‚Ü∫</span><span>Add-On</span>
        </button>
        <button class="btn btn-mg" style="padding:20px 8px;font-size:14px;flex-direction:column;gap:6px;display:flex;align-items:center" onclick="openLogHand()">
          <span style="font-size:26px;line-height:1">üÉè</span><span>Log Hand</span>
        </button>
        <button class="btn" style="padding:20px 8px;font-size:14px;flex-direction:column;gap:6px;display:flex;align-items:center;border-color:rgba(255,69,96,.25);color:var(--neg);background:rgba(255,69,96,.06)" onclick="openQuickBust()">
          <span style="font-size:26px;line-height:1">üíÄ</span><span>Bust</span>
        </button>
      </div>
      <!-- Oracle shortcut -->
      <div style="margin-bottom:10px">
        <button class="btn btn-full" style="border-color:rgba(168,85,247,.3);color:#a855f7;background:rgba(168,85,247,.06);font-size:15px;padding:16px" onclick="goTab('oracle',document.querySelector('.nvb[onclick*=oracle]'))">
          Should I Play This Hand?
        </button>
      </div>

      <!-- Live roster quick-add -->
      <div id="d-live-roster" style="display:none;margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px">Quick-add</div>
        <div id="d-live-roster-chips" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
    </div>
  </div>

  <!-- FELT TABLE ‚Äî full-width above the grid, desktop only -->
  <div class="card" id="d-players-card">
    <div class="chd">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="chd-live-dot ldot"></span>
        <span class="ctitle cy" id="d-table-title">Table</span>
      </div>
      <span style="font-size:12px;color:var(--i3)" id="d-table-sub"></span>
    </div>
    <div id="d-roster-empty" class="empty" style="padding:18px 0"><span class="empty-icon">‚ô†</span><span class="empty-txt">Add players to see the table</span></div>
    <div id="d-felt-wrap" style="display:none">
      <div id="d-felt" style="position:relative;width:100%;aspect-ratio:16/7;margin:8px 0 4px;overflow:visible">
        <div id="d-felt-oval"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none">
          <div style="font-family:'Instrument Serif',serif;font-size:17px;color:rgba(168,85,247,.55);line-height:1.2;text-shadow:0 0 20px rgba(168,85,247,.5)" id="d-felt-game">NL HOLD'EM</div>
          <div style="font-size:12px;color:rgba(0,212,255,.3);margin-top:4px;letter-spacing:.05em" id="d-felt-blinds">$0.10 / $0.10</div>
        </div>
        <div id="d-felt-seats"></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px">
        <div class="stile" style="background:var(--s2)"><div class="stile-v cy" id="d-tbl-players">0</div><div class="stile-l">Players</div></div>
        <div class="stile" style="background:var(--s2)"><div class="stile-v au" id="d-tbl-pot">$0</div><div class="stile-l">In Play</div></div>
        <div class="stile" style="background:var(--s2)"><div class="stile-v ag" id="d-tbl-avg">$0</div><div class="stile-l">Avg Stack</div></div>
      </div>
    </div>
  </div>

  <!-- MAIN GRID: always visible -->
  <div class="dash-grid">
    <div class="dash-main">
      <!-- Live scoreboard ‚Äî shown during active session -->
      <div class="card" id="d-scoreboard" style="display:none">
        <div class="chd">
          <span class="ctitle cy">Live Scoreboard</span>
          <span style="font-size:12px;color:var(--i3)" id="d-score-sub"></span>
        </div>
        <div id="d-score-list"></div>
      </div>
      <div class="card" id="d-share-card" style="display:none">
        <div class="chd"><span class="ctitle">Stack Share</span></div>
        <div id="d-share-bars"></div>
      </div>
      <div class="card" id="d-pnl-card" style="display:none">
        <div class="chd"><span class="ctitle">P&L</span></div>
        <div id="d-pnl-bars"></div>
      </div>
    </div>

    <div class="dash-side">
      <!-- Committed tonight (RSVP) -->
      <div class="card card-cyan card-sm" id="d-committed" style="display:none">
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--cy);text-transform:uppercase;margin-bottom:10px">Committed Tonight</div>
        <div id="d-committed-list" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
      <!-- Live feed -->
      <div class="card" style="flex:1">
        <div class="chd">
          <div style="display:flex;align-items:center;gap:8px">
            <span class="ctitle">Live Feed</span>
            <div class="ldot" style="width:5px;height:5px"></div>
          </div>
          <button class="btn btn-mg btn-sm" style="font-size:11px" onclick="openLogHand()">üÉè Log Hand</button>
        </div>
        <div id="d-pot-ticker" style="display:none;background:var(--s2);border:1px solid var(--brc);border-radius:var(--r6);padding:11px 14px;margin-bottom:12px;align-items:center;justify-content:space-between">
          <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--cy);text-transform:uppercase">Total in play</span>
          <span class="mono cy" style="font-size:22px" id="d-pot-live">$0.00</span>
        </div>
        <div id="d-feed-empty" class="empty" style="padding:14px 0"><span class="empty-icon">‚óà</span><span class="empty-txt">Activity appears here</span></div>
        <div id="d-feed" style="max-height:520px;overflow-y:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PLAYERS ‚ïê‚ïê -->
<div class="view" id="view-players">
  <div class="g2" style="align-items:start">
    <!-- Left: session players + roster -->
    <div>
      <!-- Session players -->
      <div class="card mb12" id="pl-session-card">
        <div class="chd"><span class="ctitle cy">At the Table</span><button class="btn btn-solid-cy btn-xs" onclick="openAdd()">+ Add Player</button></div>
        <!-- Seating controls -->
        <div id="pl-seating-controls" style="display:none;padding:8px 0 10px;border-bottom:1px solid var(--br);margin-bottom:8px">
          <div style="display:flex;gap:7px;flex-wrap:wrap;align-items:center">
            <button class="btn btn-cy btn-sm" style="font-size:11px" onclick="randomizeSeating()">üé≤ Randomize Seats</button>
            <button class="btn btn-au btn-sm" style="font-size:11px" id="pl-dealer-btn" onclick="hostToDealer()">üÉè ‚Üí Seat 1 (Dealer)</button>
            <div style="flex:1"></div>
            <span style="font-size:11px;color:var(--i4)">Seat 1 = Dealer</span>
          </div>
        </div>
        <div id="pl-empty" class="empty" style="padding:14px 0"><span class="empty-icon">‚ô†</span><span class="empty-txt">No players this session</span></div>
        <div id="pl-list"></div>
      </div>
      <!-- All-time roster (collapsible) -->
      <div class="card">
        <div class="chd" style="cursor:pointer;user-select:none" onclick="toggleRosterDB()">
          <span class="ctitle">All-Time Roster</span>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:11px;color:var(--i3)" id="pl-roster-count"></span>
            <span id="pl-roster-toggle" style="font-size:11px;color:var(--i3)">‚ñ∂ Show</span>
          </div>
        </div>
        <div id="roster-db-list" style="display:none"></div>
      </div>
    </div>
    <!-- Right: player profile / detail -->
    <div>
      <div id="pl-detail-empty" class="card empty" style="padding:40px 20px">
        <span class="empty-icon" style="font-size:28px">‚Üê</span><span class="empty-txt">Select a player to view profile</span>
      </div>
      <div id="pl-detail" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CASH OUT ‚ïê‚ïê -->
<div class="view" id="view-cashout">
  <!-- Running balance bar -->
  <div id="co-balance-bar" style="background:var(--s1);border:1px solid var(--br);border-radius:var(--r10);padding:13px 16px;margin-bottom:12px;display:none">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:0">
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:5px">Session Balance</div>
        <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:baseline">
          <span style="font-size:11px;color:var(--i3)">Total In: <span class="mono au" id="co-bal-in">$0</span></span>
          <span style="font-size:11px;color:var(--i3)">Cashed Out: <span class="mono cy" id="co-bal-out">$0</span></span>
          <span style="font-size:11px;color:var(--i3)">Still Playing: <span class="mono" id="co-bal-active">$0</span></span>
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div id="co-bal-diff-wrap" style="display:flex;align-items:center;gap:8px">
          <div>
            <div class="mono" id="co-bal-diff" style="font-size:24px;font-weight:600">$0</div>
            <div style="font-size:11px;color:var(--i3)" id="co-bal-status">balanced</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Balance bar -->
    <div style="height:4px;border-radius:2px;background:var(--s3);margin-top:10px;overflow:hidden">
      <div id="co-bal-fill" style="height:100%;border-radius:2px;width:100%;background:var(--ag);transition:width .3s,background .3s"></div>
    </div>
  </div>

  <!-- Session closed banner -->
  <div id="co-closed-banner" style="display:none;background:rgba(57,255,20,.07);border:1px solid rgba(57,255,20,.25);border-radius:var(--r8);padding:12px 16px;margin-bottom:14px;align-items:center;gap:12px">
    <span style="font-size:18px">üèÅ</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:700;color:var(--ag)">Session Ended</div><div style="font-size:10px;color:var(--i3)" id="co-closed-time"></div></div>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-xs" onclick="reopenSession()">‚Ü© Reopen</button>
      <button class="btn btn-ag btn-xs" onclick="archiveAndClear()">Archive &amp; Clear</button>
      <button class="btn btn-neg btn-xs" onclick="justClear()">Clear Without Saving</button>
    </div>
  </div>

  <div class="co-grid">
    <!-- Left: player list + payout panel -->
    <div>
      <div class="card mb12">
        <div class="chd">
          <span class="ctitle cy">Session Players</span>
          <div class="flex" style="gap:6px;align-items:center">
            <span id="co-summary" style="font-size:10px;color:var(--i3)"></span>
            <button class="btn btn-ag btn-xs" id="co-close-btn" onclick="closeSession()">üèÅ End Session</button>
          </div>
        </div>
        <div id="co-player-list" class="co-player-list"></div>
      </div>

      <!-- Payout panel -->
      <div class="card card-cyan">
        <div class="chd">
          <span class="ctitle cy">Payouts</span>
          <button class="btn btn-sm btn-xs" onclick="autoSettle()">Mark All Paid</button>
        </div>
        <div id="settle-empty" class="empty" style="padding:12px 0"><span class="empty-txt">Cash out players to see payouts</span></div>
        <div id="settle-list"></div>
      </div>
    </div>

    <!-- Right: cash out form -->
    <div>
      <div class="card card-magenta" id="co-form-card">
        <div class="chd"><span class="ctitle mg">Cash Out</span></div>
        <div id="co-no-selection" style="padding:20px;text-align:center;color:var(--i3);font-size:12px">‚Üê Select a player</div>
        <div id="co-form" style="display:none">
          <div style="font-family:'Instrument Serif',serif;font-size:22px;color:var(--i0);margin-bottom:4px" id="co-form-name"></div>
          <div style="font-size:10px;color:var(--i3);margin-bottom:13px" id="co-form-seat"></div>

          <!-- Buy-in editor -->
          <div style="background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:12px;margin-bottom:12px">
            <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:9px;display:flex;justify-content:space-between;align-items:center">
              <span>Transaction Log</span>
              <button class="btn btn-ghost btn-xs" onclick="editBuyInMode()" id="co-edit-btn">‚úé Edit</button>
            </div>
            <div id="co-txn-log"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--br);padding-top:8px;margin-top:6px">
              <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase">Total In</span>
              <span class="mono au" style="font-size:16px" id="co-total-in">$0.00</span>
            </div>
          </div>

          <!-- Stack from chip counter (auto-populated) -->
          <div style="background:var(--cy3);border:1px solid var(--brc);border-radius:var(--r6);padding:9px 12px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
            <span style="font-size:11px;color:var(--cy);font-weight:600">Last Known Stack</span>
            <span class="mono cy" style="font-size:15px;margin-left:auto" id="co-known-stack">‚Äî</span>
            <button class="btn btn-ghost btn-xs" onclick="useKnownStack()" id="co-use-stack-btn" style="display:none">Use</button>
          </div>

          <!-- Chip count -->
          <div class="card" style="background:var(--s2);margin-bottom:12px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">
              <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase">Count Chips Now</span>
              <button class="btn btn-cy btn-xs" onclick="coCaptureChips()" style="font-size:11px;padding:4px 10px">üì∑ Scan</button>
            </div>
            <input type="file" id="co-scan-input" accept="image/*" capture="environment" style="display:none" onchange="coHandleScan(event)">
            <div id="co-chip-inputs" style="display:grid;grid-template-columns:1fr 1fr;gap:6px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--br);padding-top:8px;margin-top:6px">
              <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase">Chip Total</span>
              <span class="mono cy" style="font-size:17px" id="co-chip-total">$0.00</span>
            </div>
          </div>

          <!-- Manual override -->
          <div class="fg">
            <label class="lbl">Or Enter Final Value Manually ($)</label>
            <input class="inp inp-sm" type="number" id="co-manual" placeholder="0.00" min="0" step="0.10" oninput="recalcCO()">
          </div>

          <!-- Result -->
          <div class="co-result-box" id="co-result">
            <div class="co-net" id="co-net">$0</div>
            <div class="co-sub" id="co-sub">Net</div>
            <div style="font-size:10px;color:var(--i3);margin-top:4px" id="co-detail"></div>
          </div>

          <!-- Action buttons ‚Äî split for win vs loss -->
          <div id="co-confirm-win" style="display:none;margin-top:10px">
            <button class="btn btn-ag btn-full" style="font-size:13px;padding:12px" onclick="confirmCO()">‚úì Confirm Payout</button>
          </div>
          <div id="co-confirm-loss" style="display:none;margin-top:10px">
            <button class="btn btn-neg btn-full" style="font-size:13px;padding:12px" onclick="confirmCO()">Confirm Loss &amp; Settle</button>
          </div>
          <div id="co-confirm-neutral" style="display:none;margin-top:10px">
            <button class="btn btn-solid-cy btn-full" onclick="confirmCO()">Confirm Cash Out</button>
          </div>

          <!-- Player quick actions: add-on, chips, bust -->
          <div id="co-player-actions" style="display:none;margin-top:12px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CHIPS ‚ïê‚ïê -->
<div class="view" id="view-chips">
  <div class="chip-grid">
    <div class="col">
      <div class="card">
        <div class="chd"><span class="ctitle cy">Denominations</span><button class="btn btn-sm" onclick="resetDenoms()">Reset</button></div>
        <div class="denom-grid" id="denom-grid"></div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">AI Scanner</span></div>
        <div class="upload-zone" id="upload-zone"
          onclick="document.getElementById('chip-file').click()"
          ondragover="event.preventDefault();this.classList.add('dov')"
          ondragleave="this.classList.remove('dov')"
          ondrop="handleDrop(event)">
          <span class="up-icon">üì∑</span>
          <div class="up-text">Tap to upload or drag photo</div>
          <div class="up-sub">Shoot straight down, spread stacks</div>
          <input type="file" id="chip-file" accept="image/*" capture="environment" onchange="handleFile(event)" style="display:none">
        </div>
        <img id="chip-img" class="chip-prev-img mt8" alt="">
        <div id="chip-loading" style="display:none;padding:18px;text-align:center"><span class="spin">‚óå</span><div style="font-size:10px;color:var(--i3);letter-spacing:.08em">Counting‚Ä¶</div></div>
        <div class="result-box mt8" id="chip-result">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div class="res-total" id="chip-total">$0.00</div>
              <div class="res-lbl">Total Stack Value</div>
            </div>
            <button class="btn btn-ghost btn-xs" onclick="resetChip()" style="margin-top:4px">‚Ü© New Scan</button>
          </div>
          <div class="res-chips" id="chip-chips"></div>
          <div class="res-desc" id="chip-desc"></div>
        </div>
        <div id="chip-actions" style="display:none" class="mt8">
          <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:7px">Apply to player</div>
          <div class="pp-list mb8" id="chip-picker"></div>
          <div class="g2">
            <button class="btn btn-solid-cy btn-sm" onclick="chipApply('buyin')">+ Buy-In</button>
            <button class="btn btn-au btn-sm" onclick="chipApply('rebuy')">‚Ü∫ Add-On</button>
            <button class="btn btn-ag btn-sm" style="grid-column:1/-1" onclick="chipApply('stack')">‚ü≥ Set as Stack</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <div class="chd"><span class="ctitle">Manual Count</span></div>
        <div id="mc-grid" class="denom-grid"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--br);padding-top:10px;margin-top:4px">
          <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase">Total</span>
          <span class="mono cy" style="font-size:24px" id="mc-total">$0.00</span>
        </div>
        <hr>
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:7px">Apply to player</div>
        <div class="pp-list mb8" id="mc-picker"></div>
        <div class="g2 mt8">
          <button class="btn btn-solid-cy btn-sm" onclick="mcApply('buyin')">+ Buy-In</button>
          <button class="btn btn-au btn-sm" onclick="mcApply('rebuy')">‚Ü∫ Add-On</button>
          <button class="btn btn-ag btn-sm" style="grid-column:1/-1" onclick="mcApply('stack')">‚ü≥ Set as Stack</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê HANDS ‚ïê‚ïê -->
<div class="view" id="view-hands">
  <div class="fb mb12">
    <div class="g3" style="flex:1;gap:10px">
      <div class="stile"><div class="stile-v cy" id="sh-count">0</div><div class="stile-l">Logged</div></div>
      <div class="stile"><div class="stile-v ag" id="sh-big">‚Äî</div><div class="stile-l">Biggest Pot</div></div>
      <div class="stile"><div class="stile-v" id="sh-win">‚Äî</div><div class="stile-l">Most Wins</div></div>
    </div>
    <button class="btn btn-solid-cy btn-sm" style="margin-left:10px;flex-shrink:0" onclick="openLogHand()">+ Log</button>
  </div>
  <div id="hands-empty" class="card empty"><span class="empty-icon">‚óà</span><span class="empty-txt">No hands logged</span></div>
  <div id="hands-list"></div>
</div>

<!-- ‚ïê‚ïê TRAINER ‚ïê‚ïê -->
<div class="view" id="view-trainer">
  <div class="trainer-grid">
    <div class="trainer-main">
      <div class="card card-cyan">
        <div class="chd">
          <span class="ctitle cy">Postflop Trainer</span>
          <div class="flex">
            <select class="sel" id="tr-street" style="font-size:10px;padding:5px 26px 5px 9px;width:auto">
              <option value="random">Random Street</option>
              <option value="flop">Flop</option>
              <option value="turn">Turn</option>
              <option value="river">River</option>
            </select>
            <button class="btn btn-solid-cy btn-sm" onclick="newHand()">New Hand</button>
          </div>
        </div>

        <!-- Street progress -->
        <div id="tr-progress" style="margin-bottom:14px;display:none">
          <div class="street-progress" id="sp-dots"></div>
          <div style="display:flex;justify-content:space-around;margin-top:3px">
            <span class="sp-lbl" id="sp-lbl-f">Flop</span>
            <span class="sp-lbl" id="sp-lbl-t">Turn</span>
            <span class="sp-lbl" id="sp-lbl-r">River</span>
          </div>
        </div>

        <!-- Mini table with seats -->
        <div id="tr-table-wrap" style="display:none;margin-bottom:14px">
          <div style="position:relative;width:100%;aspect-ratio:3/1">
            <div style="position:absolute;inset:0;border-radius:50%;background:radial-gradient(ellipse,#0d2e1b,#07150a);border:2px solid rgba(0,212,255,.12);box-shadow:0 0 20px rgba(0,212,255,.06)"></div>
            <div id="tr-seats" style="position:absolute;inset:0"></div>
          </div>
        </div>

        <!-- Board -->
        <div style="margin-bottom:13px">
          <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--i3);margin-bottom:7px">Board</div>
          <div id="tr-board" style="display:flex;gap:7px;flex-wrap:wrap"></div>
        </div>

        <!-- Hero hand -->
        <div style="margin-bottom:13px">
          <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--i3);margin-bottom:7px" id="tr-hero-lbl">Your Hand</div>
          <div id="hd-cards" style="display:flex;gap:7px"></div>
        </div>

        <!-- Context -->
        <div id="hd-context" style="font-size:12px;color:var(--i2);line-height:1.6;background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:10px 12px;margin-bottom:13px;display:none"></div>

        <!-- Action buttons -->
        <div class="g2 mb4" id="action-btns" style="gap:8px">
          <button class="action-btn ab-fold" id="ab-fold" onclick="trainerAction('fold')">Fold</button>
          <button class="action-btn ab-check" id="ab-check" onclick="trainerAction('check')">Check</button>
          <button class="action-btn ab-call" id="ab-call" onclick="trainerAction('call')">Call</button>
          <button class="action-btn ab-bet" id="ab-bet" onclick="trainerAction('bet')">Bet</button>
        </div>

        <!-- Feedback -->
        <div class="feedback-box" id="feedback-box">
          <div class="flex mb8">
            <div class="fb-grade" id="fb-grade">A</div>
            <div style="padding-top:6px"><div class="fb-verdict" id="fb-verdict">Well played</div><div class="fb-spot" id="fb-spot" style="margin-top:6px"></div></div>
          </div>
          <div class="fb-ev-row" id="fb-ev-row"></div>
          <div class="fb-analysis" id="fb-analysis"></div>
          <div id="continue-btn-wrap" style="display:none">
            <button class="btn btn-cy btn-full mt8" onclick="continueHand()">Continue to <span id="next-street-lbl">Turn</span> ‚Üí</button>
          </div>
          <button class="btn btn-solid-cy btn-full mt8" id="next-hand-btn" onclick="newHand()" style="display:none">New Hand ‚Üí</button>
        </div>
      </div>
    </div>

    <div class="trainer-side">
      <div class="card">
        <div class="chd"><span class="ctitle">Session</span><button class="btn btn-ghost btn-xs" onclick="resetTrainer()">Reset</button></div>
        <div class="tr-stat-row"><span class="tr-sl">Hands</span><span class="tr-sv cy" id="tr-played">0</span></div>
        <div class="tr-stat-row"><span class="tr-sl">Correct</span><span class="tr-sv pos" id="tr-correct">0</span></div>
        <div class="tr-stat-row"><span class="tr-sl">Accuracy</span><span class="tr-sv" id="tr-acc">‚Äî</span></div>
        <div class="tr-stat-row"><span class="tr-sl">Avg EV</span><span class="tr-sv cy" id="tr-ev">‚Äî</span></div>
        <div class="tr-stat-row"><span class="tr-sl">Best Street</span><span class="tr-sv" id="tr-best" style="font-size:10px">‚Äî</span></div>
        <div class="tr-stat-row"><span class="tr-sl">Needs Work</span><span class="tr-sv neg" id="tr-weak" style="font-size:10px">‚Äî</span></div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">Hand Info</span></div>
        <div id="tr-hand-info" style="font-size:11px;color:var(--i3);line-height:2">‚Äî</div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle">Concepts</span></div>
        <div style="font-size:10px;color:var(--i3);line-height:2.2">
          <div><span class="mono cy">SPR</span> ‚Äî Stack to pot ratio</div>
          <div><span class="mono cy">Pot odds</span> ‚Äî % equity needed to call</div>
          <div><span class="mono cy">Semi-bluff</span> ‚Äî Bet with a draw</div>
          <div><span class="mono cy">Polarized</span> ‚Äî Nuts or bluffs only</div>
          <div><span class="mono cy">Board texture</span> ‚Äî Wet vs dry</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê INVITE ‚ïê‚ïê -->
<div class="view" id="view-invite">
  <div class="g2" style="align-items:start">
    <div>
      <div class="invite-hero">
        <div class="invite-title" id="inv-title-display">Moon's Night</div>
        <div class="invite-sub" id="inv-date-display">Loading‚Ä¶</div>
        <div style="margin-top:14px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap">
          <div class="stile" style="min-width:90px;text-align:center">
            <div class="stile-v cy" id="inv-in-count">0</div>
            <div class="stile-l">In</div>
          </div>
          <div class="stile" style="min-width:90px;text-align:center">
            <div class="stile-v au" id="inv-maybe-count">0</div>
            <div class="stile-l">Maybe</div>
          </div>
          <div class="stile" style="min-width:90px;text-align:center">
            <div class="stile-v neg" id="inv-out-count">0</div>
            <div class="stile-l">Out</div>
          </div>
        </div>
      </div>

      <!-- Share link -->
      <div class="share-box mb4">
        <a id="inv-share-url" href="#" target="_blank" style="flex:1;font-size:11px;color:var(--cy);font-family:'DM Mono',monospace;word-break:break-all;text-decoration:underline;opacity:.8">‚Äî</a>
        <button class="btn btn-cy btn-xs" onclick="copyInviteLink()">Copy</button>
      </div>

      <!-- RSVPs -->
      <div class="card">
        <div class="chd"><span class="ctitle cy">Responses</span></div>
        <div id="rsvp-empty" class="empty" style="padding:12px 0"><span class="empty-txt">No responses yet</span></div>
        <div class="rsvp-list" id="rsvp-list"></div>
      </div>
    </div>

    <div>
      <!-- Host setup -->
      <div class="card card-cyan mb12">
        <div class="chd"><span class="ctitle cy">Game Setup</span></div>
        <div class="fg"><label class="lbl">Game Name</label><input class="inp inp-sm" id="inv-name" placeholder="Moon's Night" value="Moon's Night"></div>
        <div class="fg"><label class="lbl">Date</label><input class="inp inp-sm" type="date" id="inv-date"></div>
        <div class="fg"><label class="lbl">Time</label><input class="inp inp-sm" type="time" id="inv-time" value="20:00"></div>
        <div class="fg"><label class="lbl">Location</label><input class="inp inp-sm" id="inv-loc" placeholder="Address or 'TBD'"></div>
        <div class="fg"><label class="lbl">Max Players</label><input class="inp inp-sm" type="number" id="inv-max" value="10" min="2" max="12"></div>
        <div class="fg"><label class="lbl">Buy-In ($)</label><input class="inp inp-sm" type="number" id="inv-buyin" value="10" step="5"></div>
        <div class="fg"><label class="lbl">Note to players</label><textarea class="inp inp-sm" id="inv-note" placeholder="BYO drinks, park on the street‚Ä¶" rows="2" style="resize:none"></textarea></div>
        <button class="btn btn-solid-cy btn-full" onclick="saveInvite()">Save & Generate Link</button>
      </div>

      <!-- Self RSVP (guest mode simulation) -->
      <div class="invite-form card-magenta">
        <div class="invite-form-title">RSVP as a Guest</div>
        <div class="fg"><label class="lbl">Your Name</label><input class="inp inp-sm" id="inv-guest-name" placeholder="Your name‚Ä¶"></div>
        <div class="fg"><label class="lbl">Status</label>
          <select class="sel inp-sm" id="inv-guest-status">
            <option value="in">I'm In ü§ô</option>
            <option value="maybe">Maybe ü§î</option>
            <option value="out">Can't Make It üò¢</option>
          </select>
        </div>
        <button class="btn btn-mg btn-full" onclick="submitRSVP()">Send Response</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê WIZARD ‚ïê‚ïê -->
<div class="view" id="view-oracle">
  <div class="g2" style="align-items:start;gap:16px">
    <!-- Left: card picker + verdict -->
    <div>
      <div class="card" style="background:var(--s1);border:1px solid rgba(168,85,247,.3)">
        <div class="chd">
          <span class="ctitle" style="color:#a855f7">üßô Should I Play This?</span>
        </div>
        <p style="font-size:11px;color:var(--i3);margin-bottom:16px;line-height:1.6">GTO Wizard ‚Äî but make it questionable. Pick your hole cards. The Wizard has been consulted.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <div>
            <label class="lbl">Card 1</label>
            <select class="sel" id="ora-c1" onchange="oraclePreview()">
              <option>A</option><option>K</option><option>Q</option><option>J</option><option>T</option>
              <option>9</option><option>8</option><option>7</option><option>6</option>
              <option>5</option><option>4</option><option>3</option><option>2</option>
            </select>
          </div>
          <div>
            <label class="lbl">Card 2</label>
            <select class="sel" id="ora-c2" onchange="oraclePreview()">
              <option>A</option><option>K</option><option>Q</option><option>J</option><option>T</option>
              <option>9</option><option>8</option><option>7</option><option>6</option>
              <option>5</option><option>4</option><option>3</option><option>2</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <label style="flex:1;display:flex;align-items:center;gap:7px;padding:9px 12px;border:1px solid var(--br);border-radius:var(--r8);cursor:pointer;font-size:12px;background:var(--s2)">
            <input type="radio" name="ora-suit" value="o" checked style="accent-color:#a855f7" onchange="oraclePreview()"> Offsuit
          </label>
          <label style="flex:1;display:flex;align-items:center;gap:7px;padding:9px 12px;border:1px solid var(--br);border-radius:var(--r8);cursor:pointer;font-size:12px;background:var(--s2)">
            <input type="radio" name="ora-suit" value="s" style="accent-color:#a855f7" onchange="oraclePreview()"> Suited
          </label>
        </div>

        <!-- Live hand preview + tier (always visible) -->
        <div id="ora-preview-box" style="border-radius:var(--r10);padding:14px;background:var(--s2);border:1px solid var(--br);text-align:center;margin-bottom:14px;transition:border-color .2s,background .2s">
          <div id="ora-preview-hand" style="font-size:32px;font-weight:700;letter-spacing:5px;margin-bottom:7px;font-family:'DM Mono',monospace">A‚ô† A‚ô•</div>
          <div id="ora-preview-badge" style="display:inline-block;font-size:11px;font-weight:700;letter-spacing:.1em;padding:4px 14px;border-radius:20px;margin-bottom:6px">GTO</div>
          <div id="ora-preview-label" style="font-size:11px;color:var(--i3)">Solver approved.</div>
        </div>

        <button class="btn btn-full" style="background:rgba(168,85,247,.15);border-color:rgba(168,85,247,.5);color:#a855f7;font-weight:700;font-size:15px;padding:15px" onclick="askOracle()">
          Ask the Wizard
        </button>

        <!-- Verdict (shown after button press) -->
        <div id="ora-result" style="display:none;border-radius:var(--r10);padding:14px;text-align:center;margin-top:14px;transition:all .2s">
          <div id="ora-verdict" style="font-size:20px;font-weight:700;margin-bottom:6px"></div>
          <div id="ora-reason" style="font-size:12px;line-height:1.7;opacity:.9"></div>
        </div>

      </div>
    </div>

    <!-- Right: tier guide + history -->
    <div>
      <div class="card mb12">
        <div class="chd"><span class="ctitle">Hand Tiers</span></div>
        <div id="ora-tier-guide" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
      <div class="card" id="ora-history-card" style="display:none">
        <div class="chd"><span class="ctitle">Recent Consults</span><button class="btn btn-ghost btn-xs" onclick="clearOracleHistory()">Clear</button></div>
        <div id="ora-history-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SESSIONS ‚ïê‚ïê -->
<div class="view" id="view-sessions">
  <div class="g2" style="align-items:start">
    <div>
      <div class="g4 mb12" style="gap:8px">
        <div class="stile"><div class="stile-v cy" id="hs-sess">0</div><div class="stile-l">Sessions</div></div>
        <div class="stile"><div class="stile-v" id="hs-hands">0</div><div class="stile-l">Hands</div></div>
        <div class="stile"><div class="stile-v ag" id="hs-dumb">0</div><div class="stile-l">Dumb Wins</div></div>
        <div class="stile"><div class="stile-v au" id="hs-top">‚Äî</div><div class="stile-l">Reg</div></div>
      </div>
      <div class="card">
        <div class="chd"><span class="ctitle cy">Past Sessions</span><button class="btn btn-neg btn-xs" id="clr-hist" style="display:none" onclick="clearHistory()">Clear All</button></div>
        <div id="hist-empty" class="card empty" style="padding:20px 0;margin:0;border:none"><span class="empty-icon">‚óà</span><span class="empty-txt">No sessions saved yet</span></div>
        <div id="hist-list"></div>
      </div>
    </div>
    <div>
      <div id="sess-detail-empty" class="card empty" style="padding:40px 20px">
        <span class="empty-icon" style="font-size:28px">‚Üê</span><span class="empty-txt">Select a session</span>
      </div>
      <div id="sess-detail" style="display:none"></div>
    </div>
  </div>
</div>

</main>
</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- Quick Action Modal (Add-On / Re-Buy / Bust) -->
<div class="overlay" id="m-quick-action">
  <div class="modal" style="max-width:360px">
    <div class="modal-t" id="qa-modal-title">Action <button class="mclose" onclick="closeQuickAction()">‚úï</button></div>
    <div class="fg">
      <label class="lbl">Player</label>
      <select class="sel" id="qa-player-sel"></select>
    </div>
    <div class="fg" id="qa-amount-row">
      <label class="lbl">Amount ($)</label>
      <input class="inp" type="number" id="qa-amount" value="10" min="0.10" step="0.10">
    </div>
    <div class="fg" id="qa-type-row">
      <label class="lbl">Type</label>
      <select class="sel" id="qa-type">
        <option value="rebuy">Re-Buy</option>
        <option value="addon">Add-On</option>
      </select>
    </div>
    <div class="flex mt12">
      <button class="btn btn-solid-cy" style="flex:1" id="qa-action-btn">Confirm</button>
      <button class="btn" onclick="closeQuickAction()">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-add">
  <div class="modal" style="max-width:400px">
    <div class="modal-t">Add Player <button class="mclose" onclick="cm('m-add')">‚úï</button></div>

    <!-- Quick-add from roster -->
    <div id="ap-roster-quick" style="margin-bottom:14px;display:none">
      <div style="font-size:8px;font-weight:700;letter-spacing:.12em;color:var(--cy);text-transform:uppercase;margin-bottom:7px">Quick Add from Roster</div>
      <div id="ap-roster-chips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px"></div>
      <div style="height:1px;background:var(--br);margin-bottom:12px"></div>
    </div>

    <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px">New / Custom Seat</div>
    <div class="fg">
      <label class="lbl">Name</label>
      <input class="inp" type="text" id="ap-name" placeholder="Type name‚Ä¶" maxlength="24" list="roster-datalist" onkeydown="if(event.key==='Enter')doAddPlayer()" oninput="ap_name_change()">
      <datalist id="roster-datalist"></datalist>
    </div>
    <div class="fg"><label class="lbl">Buy-In ($)</label><input class="inp" type="number" id="ap-buyin" placeholder="10" min="0.10" step="0.10"></div>
    <div class="fg"><label class="lbl">Seat</label><select class="sel" id="ap-seat"></select></div>
    <div class="flex mt12">
      <button class="btn btn-solid-cy" style="flex:1" onclick="doAddPlayer()">Seat Player</button>
      <button class="btn" onclick="cm('m-add')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-settings">
  <div class="modal">
    <div class="modal-t">Settings <button class="mclose" onclick="cm('m-settings')">‚úï</button></div>
    <div class="fg"><label class="lbl">Your Name (Dealer/Host)</label><input class="inp" type="text" id="set-host" placeholder="blake" maxlength="24"></div>
    <div class="fg"><label class="lbl">Small Blind ($)</label><input class="inp" type="number" id="set-sb" value="0.10" step="0.05"></div>
    <div class="fg"><label class="lbl">Big Blind ($)</label><input class="inp" type="number" id="set-bb" value="0.10" step="0.05"></div>
    <div class="fg"><label class="lbl">Default Buy-In ($)</label><input class="inp" type="number" id="set-bi" value="10" step="1"></div>
    <div class="fg"><label class="lbl">Seats</label>
      <select class="sel" id="set-seats">
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10" selected>10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
      </select>
    </div>
    <div class="fg"><label class="lbl">Game</label>
      <select class="sel" id="set-game"><option>NL HOLD'EM</option><option>PLO</option><option>MIXED</option></select>
    </div>
    <div class="flex mt12">
      <button class="btn btn-solid-cy" style="flex:1" onclick="doSaveSettings()">Save</button>
      <button class="btn" onclick="cm('m-settings')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-hand">
  <div class="modal" style="max-width:400px">
    <div class="modal-t">üÉè Log a Hand <button class="mclose" onclick="cm('m-hand')">‚úï</button></div>

    <div class="fg">
      <label class="lbl">Winner</label>
      <select class="sel" id="lh-winner"></select>
    </div>

    <!-- Hole cards -->
    <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px">Hole Cards</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <label class="lbl">Card 1</label>
        <select class="sel" id="lh-c1" onchange="rateHand()">
          <option>A</option><option>K</option><option>Q</option><option>J</option><option>T</option>
          <option>9</option><option>8</option><option>7</option><option>6</option>
          <option>5</option><option>4</option><option>3</option><option>2</option>
        </select>
      </div>
      <div>
        <label class="lbl">Card 2</label>
        <select class="sel" id="lh-c2" onchange="rateHand()">
          <option>A</option><option>K</option><option>Q</option><option>J</option><option>T</option>
          <option>9</option><option>8</option><option>7</option><option>6</option>
          <option>5</option><option>4</option><option>3</option><option selected>2</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <label style="flex:1;display:flex;align-items:center;gap:7px;padding:9px 12px;border:1px solid var(--br);border-radius:var(--r8);cursor:pointer;font-size:12px;color:var(--i2);background:var(--s2)">
        <input type="radio" name="lh-suit" value="o" checked style="accent-color:var(--cy)" onchange="rateHand()"> Offsuit
      </label>
      <label style="flex:1;display:flex;align-items:center;gap:7px;padding:9px 12px;border:1px solid var(--br);border-radius:var(--r8);cursor:pointer;font-size:12px;color:var(--i2);background:var(--s2)">
        <input type="radio" name="lh-suit" value="s" style="accent-color:var(--cy)" onchange="rateHand()"> Suited
      </label>
    </div>

    <!-- Hand rating display -->
    <div id="lh-rating-box" style="border-radius:var(--r10);padding:12px 14px;margin-bottom:14px;border:1px solid var(--br);background:var(--s2);text-align:center">
      <div id="lh-card-preview" style="font-size:26px;font-weight:700;letter-spacing:4px;margin-bottom:6px">A‚ô† A‚ô•</div>
      <div id="lh-tier-badge" style="display:inline-block;font-size:10px;font-weight:700;letter-spacing:.1em;padding:3px 12px;border-radius:20px;margin-bottom:5px">GTO</div>
      <div id="lh-rating-label" style="font-size:11px;color:var(--i3)">Premium hand</div>
    </div>

    <div class="fg">
      <label class="lbl">Pot ($)</label>
      <input class="inp inp-sm" type="number" id="lh-pot" placeholder="0.00" step="0.10">
    </div>
    <div class="fg">
      <label class="lbl">Notes (optional)</label>
      <input class="inp inp-sm" type="text" id="lh-note" placeholder="He slow rolled it‚Ä¶">
    </div>

    <div class="flex mt12">
      <button class="btn btn-solid-cy" style="flex:1" onclick="doLogHand()">Log It</button>
      <button class="btn" onclick="cm('m-hand')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-end">
  <div class="modal">
    <div class="modal-t">End Night <button class="mclose" onclick="cm('m-end')">‚úï</button></div>
    <div style="font-size:11px;color:var(--i3);margin-bottom:10px">Archive session and clear the table?</div>
    <div id="end-sum" style="background:var(--s2);border:1px solid var(--br);border-radius:var(--r6);padding:11px;font-size:11px;color:var(--i3);line-height:2;margin-bottom:12px"></div>
    <div class="flex">
      <button class="btn btn-solid-cy" style="flex:1" onclick="doSaveEnd()">Save &amp; End</button>
      <button class="btn btn-neg" style="flex:1" onclick="doDiscardEnd()">Discard</button>
      <button class="btn" onclick="cm('m-end')">Cancel</button>
    </div>
  </div>
</div>


<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const G = {
  players:[], hands:[], dumbHands:[], feed:[], nextId:1,
  settings:{sb:0.10,bb:0.10,defaultBuyin:10,seats:10,game:"NL HOLD'EM",hostName:'blake'},
  start:new Date()
};

// Chip denominations ‚Äî 4 only (red, blue, black, green)
const DEFAULT_DENOMS = [
  {id:'r', name:'Red',   color:'#ef4444', value:0.10},
  {id:'b', name:'Blue',  color:'#3b82f6', value:0.50},
  {id:'bl',name:'Black', color:'#6b7280', value:1.00},
  {id:'g', name:'Green', color:'#22c55e', value:5.00},
];
let DENOMS = JSON.parse(JSON.stringify(DEFAULT_DENOMS));

// Persistent player roster (all-time) ‚Äî stored as objects
let ROSTER_DB = (JSON.parse(localStorage.getItem('moonsRoster')||'[]')).map(r=>
  typeof r==='string' ? {name:r,lastSeen:null,nextSession:null,notes:''} : r
);
function saveRosterDB(){localStorage.setItem('moonsRoster',JSON.stringify(ROSTER_DB));scheduleCloudSave();}
function getRosterEntry(name){return ROSTER_DB.find(r=>r.name===name);}
function upsertRoster(name,patch={}){
  let r=getRosterEntry(name);
  if(!r){r={name,lastSeen:null,nextSession:null,notes:''};ROSTER_DB.push(r);}
  Object.assign(r,patch);saveRosterDB();
}

// Trainer state
const TR = {played:0,correct:0,totalEV:0,history:[],currentSpot:null,multiStreet:null};

// Invite state
let INVITE = JSON.parse(localStorage.getItem('moonsInvite')||'{}');
let RSVPS   = JSON.parse(localStorage.getItem('moonsRSVPs') ||'[]');

// Cash out tracking
let coSelectedId = null;
let settleChecked = {}; // playerId -> bool

// Session timer
let sessionActive = false;
let sessionStartTime = null;
let timerInterval = null;

let activeTab = 'dash', selPlayer = null, selPlayerId = null, chipVal = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $ = id => document.getElementById(id);
const ti = p => p.buyin + p.addOnTotal;
const fmt = n => {
  const a=Math.abs(n);
  return '$'+(a>=100?a.toFixed(2):a.toFixed(2));
};
const signed = n => (n>=0?'+':'‚àí')+fmt(n);
const clock  = d => d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
function om(id){$(id).classList.add('on')}
function cm(id){$(id).classList.remove('on')}
function toast(msg,dur=2600){
  const t=$('toast');t.textContent=msg;t.classList.add('on');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),dur);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goTab(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.querySelectorAll('.nvb').forEach(b=>b.classList.remove('on'));
  $(`view-${name}`).classList.add('on'); el.classList.add('on'); activeTab=name;
  if(name==='dash')    renderDash();
  if(name==='players') renderPlayerPanel();
  if(name==='cashout') renderCashOut();
  if(name==='chips')   {buildDenomUI();populatePickers();}
  if(name==='hands')   renderHands();
  if(name==='trainer') {if(!TR.currentSpot)newHand();}
  if(name==='oracle')  renderOraclePage();
  if(name==='invite')  renderInvite();
  if(name==='sessions') renderSessions();
  if(name==='history') renderSessions();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SESSION TIMER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startSession(){
  sessionActive = true;
  sessionStartTime = new Date();
  G.start = sessionStartTime;
  $('d-pre-session').style.display = 'none';
  $('d-active-session').style.display = 'block';
  timerInterval = setInterval(tickTimer, 1000);
  tickTimer();
  addFeed('‚ñ∂','Session started','Timer running ‚Äî good luck everyone üÉè');
  updateNavState();
  refresh();
}

function updateNavState(){
  const live = sessionActive;
  // Show only during live session
  ['nav-cashout','nav-hands'].forEach(id => { const el=$(id); if(el) el.style.display = live ? '' : 'none'; });
  // Show only pre-session
  ['nav-invite','nav-trainer'].forEach(id => { const el=$(id); if(el) el.style.display = live ? 'none' : ''; });
}

function tickTimer(){
  if(!sessionStartTime) return;
  const el = $('d-timer');
  if(!el) return;
  const elapsed = Math.floor((Date.now() - sessionStartTime.getTime()) / 1000);
  const h = Math.floor(elapsed / 3600);
  const m = Math.floor((elapsed % 3600) / 60);
  const s = elapsed % 60;
  el.textContent = h > 0
    ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
    : `${m}:${String(s).padStart(2,'0')}`;
}

function stopTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUICK ACTIONS (Dashboard)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openQuickAddon(){
  const act = G.players.filter(p=>p.status==='active');
  if(!act.length){ toast('No active players'); return; }
  // Build modal content inline
  const sl = document.getElementById('qa-player-sel');
  if(sl){
    sl.innerHTML = act.map(p=>`<option value="${p.id}">${p.name} ‚Äî ${fmt(p.currentStack)}</option>`).join('');
    $('qa-amount').value = G.settings.defaultBuyin;
    $('qa-type').value = 'rebuy';
    om('m-quick-action');
    $('qa-modal-title').textContent = 'Add-On / Re-Buy';
    $('qa-action-btn').textContent = 'Add Chips';
    $('qa-action-btn').onclick = doQuickAddon;
  }
}

function openQuickBuyin(){
  const act = G.players.filter(p=>p.status==='active');
  if(!act.length){ toast('No active players'); return; }
  const sl = $('qa-player-sel');
  if(sl){
    sl.innerHTML = act.map(p=>`<option value="${p.id}">${p.name} ‚Äî ${fmt(p.currentStack)}</option>`).join('');
    $('qa-amount').value = G.settings.defaultBuyin;
    om('m-quick-action');
    $('qa-modal-title').textContent = 'Re-Buy';
    // hide type selector, always rebuy
    const td = $('qa-type-row'); if(td) td.style.display='none';
    $('qa-action-btn').textContent = 'Add Re-Buy';
    $('qa-action-btn').onclick = ()=>{
      const p = G.players.find(q=>q.id===parseInt($('qa-player-sel').value));
      const amt = parseFloat($('qa-amount').value)||G.settings.defaultBuyin;
      if(!p)return;
      p.addOns.push({amount:amt,type:'rebuy',time:new Date()});
      p.addOnTotal+=amt; p.currentStack+=amt;
      addFeed('‚Ü∫',`${p.name} re-buy`,`+${fmt(amt)} ‚Üí ${fmt(p.currentStack)}`);
      cm('m-quick-action'); refresh(); toast(`${p.name} +${fmt(amt)}`);
    };
    const td2=$('qa-type-row');if(td2)td2.style.display='none';
  }
}

function doQuickAddon(){
  const p = G.players.find(q=>q.id===parseInt($('qa-player-sel').value));
  const amt = parseFloat($('qa-amount').value)||G.settings.defaultBuyin;
  const type = $('qa-type').value||'rebuy';
  if(!p){ toast('Select a player'); return; }
  p.addOns.push({amount:amt,type,time:new Date()});
  p.addOnTotal+=amt; p.currentStack+=amt;
  addFeed('‚Ü∫',`${p.name} ${type}`,`+${fmt(amt)} ‚Üí ${fmt(p.currentStack)}`);
  cm('m-quick-action'); refresh(); toast(`${p.name} +${fmt(amt)}`);
}

function openQuickBust(){
  const act = G.players.filter(p=>p.status==='active');
  if(!act.length){ toast('No active players'); return; }
  const sl = $('qa-player-sel');
  if(sl){
    sl.innerHTML = act.map(p=>`<option value="${p.id}">${p.name} ‚Äî ${fmt(p.currentStack)}</option>`).join('');
    const td=$('qa-type-row');if(td)td.style.display='none';
    const ad=$('qa-amount-row');if(ad)ad.style.display='none';
    om('m-quick-action');
    $('qa-modal-title').textContent = 'Bust Out Player';
    $('qa-action-btn').textContent = 'üíÄ Bust ‚Äî Cash Out at $0';
    $('qa-action-btn').style.background = 'rgba(255,69,96,.15)';
    $('qa-action-btn').style.borderColor = 'rgba(255,69,96,.4)';
    $('qa-action-btn').style.color = 'var(--neg)';
    $('qa-action-btn').onclick = doQuickBust;
  }
}

function doQuickBust(){
  const p = G.players.find(q=>q.id===parseInt($('qa-player-sel').value));
  if(!p){ toast('Select a player'); return; }
  p.status = 'cashed'; p.cashoutAmount = 0; p.currentStack = 0;
  settleChecked[p.id] = false;
  addFeed('üíÄ',`${p.name} busted out`,`Lost ${fmt(ti(p))} ¬∑ Cashed $0`);
  closeQuickAction(); refresh(); toast(`${p.name} busted ‚Äî $0 cashout`);
}

function closeQuickAction(){
  cm('m-quick-action');
  // Reset button styles and show all rows again
  const ab=$('qa-action-btn');
  if(ab){ab.style.background='';ab.style.borderColor='';ab.style.color='';}
  const tr=$('qa-type-row'),ar=$('qa-amount-row');
  if(tr)tr.style.display='';if(ar)ar.style.display='';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DASHBOARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FELT TABLE VISUAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFeltTable(players){
  const wrap=$('d-felt-seats');if(!wrap)return;
  const total=G.settings.seats;
  const seatMap={};
  players.forEach(p=>seatMap[p.seat]=p);

  const pal=['#00d4ff','#39ff14','#ff006e','#e8b84b','#a855f7','#fb923c','#38bdf8','#4ade80','#f472b6','#facc15'];

  // Pull the oval in so 50px avatars + labels don't crowd the edges
  const cx=50,cy=50,rx=38,ry=33;

  let html='';
  for(let s=1;s<=total;s++){
    const angle=((s-1)/total)*2*Math.PI - Math.PI/2;
    const x=cx+rx*Math.cos(angle);
    const y=cy+ry*Math.sin(angle);
    const p=seatMap[s];
    if(p){
      const pnl=p.currentStack-ti(p);
      const pnlStr=pnl>0?`+${fmt(pnl)}`:pnl<0?`-${fmt(Math.abs(pnl))}`:'';
      const pnlCol=pnl>0?'#39ff14':'#ff4560';
      const bg=pal[(p.seat-1)%pal.length];
      html+=`<div class="felt-seat" style="left:${x.toFixed(1)}%;top:${y.toFixed(1)}%" onclick="openPlayerPanel(${p.id})">
        <div class="felt-avatar active" style="background:${bg}28;border-color:${bg}">
          <span style="color:${bg}">${p.name.charAt(0).toUpperCase()}</span>
        </div>
        <div class="felt-name">${p.name}</div>
        <div class="felt-stack">${fmt(p.currentStack)}</div>
        ${pnlStr?`<div class="felt-sub" style="color:${pnlCol}">${pnlStr}</div>`:''}
      </div>`;
    } else {
      html+=`<div class="felt-seat" style="left:${x.toFixed(1)}%;top:${y.toFixed(1)}%;opacity:.28" onclick="openAddAtSeat(${s})" title="Seat ${s}">
        <div class="felt-avatar empty">
          <span style="font-size:12px;color:rgba(255,255,255,.35)">+${s}</span>
        </div>
      </div>`;
    }
  }
  wrap.innerHTML=html;
}

function toggleOracle(){
  const card=$('d-oracle-card');
  if(!card)return;
  const open=card.style.display!=='none';
  card.style.display=open?'none':'block';
  const btn=$('d-oracle-toggle');
  if(btn) btn.style.background=open?'rgba(168,85,247,.06)':'rgba(168,85,247,.18)';
}

function renderPreRoster(){
  const chips=$('pre-roster-chips');
  const empty=$('pre-roster-empty');
  const seatedWrap=$('pre-seated-wrap');
  const seatedList=$('pre-seated-list');
  if(!chips) return;

  // Players already seated (added before session started)
  const seated=G.players.filter(p=>p.status==='active');

  // Roster members not yet at table
  const available=ROSTER_DB.filter(r=>!G.players.some(p=>p.name===r.name&&p.status==='active'));

  // Render chips
  if(!available.length && !ROSTER_DB.length){
    chips.innerHTML='';
    if(empty) empty.style.display='block';
  } else {
    if(empty) empty.style.display=available.length?'none':'block';
    chips.innerHTML=available.map(r=>{
      const nameEsc=r.name.replace(/'/g,"\\'");
      return `<button class="btn btn-cy btn-sm" style="padding:6px 12px;font-size:12px;border-radius:20px" onclick="preSessionQuickAdd('${nameEsc}')">+ ${r.name}</button>`;
    }).join('');
  }

  // Show seated preview
  if(seated.length && seatedWrap && seatedList){
    seatedWrap.style.display='block';
    seatedList.innerHTML=seated.map(p=>`
      <div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:var(--ag3);border:1px solid rgba(57,255,20,.2);border-radius:20px">
        <span style="font-size:11px;font-weight:600;color:var(--ag)">${p.name}</span>
        <span style="font-size:11px;color:var(--i3)">S${p.seat}</span>
        <button style="background:none;border:none;color:var(--i3);cursor:pointer;font-size:11px;padding:0;margin-left:2px" onclick="removePreSeated(${p.id})">‚úï</button>
      </div>`).join('');
  } else if(seatedWrap){
    seatedWrap.style.display='none';
  }
}

function preSessionQuickAdd(name){
  const freeSeat=Array.from({length:G.settings.seats},(_,i)=>i+1)
    .find(s=>!G.players.some(p=>p.seat===s&&p.status==='active'));
  if(!freeSeat){toast('No open seats');return;}
  G.players.push({
    id:G.nextId++,name,
    buyin:G.settings.defaultBuyin,
    addOns:[],addOnTotal:0,
    seat:freeSeat,status:'active',
    currentStack:G.settings.defaultBuyin,
    cashoutAmount:null,joinedAt:new Date()
  });
  upsertRoster(name);
  renderPreRoster();
  toast(`${name} ‚Üí Seat ${freeSeat}`);
}

function removePreSeated(id){
  const idx=G.players.findIndex(p=>p.id===id);
  if(idx!==-1) G.players.splice(idx,1);
  renderPreRoster();
}

function renderDash(){
  // Always render roster chips (pre-session strip)
  renderPreRoster();
  // Live roster quick-add during active session
  if(sessionActive) renderLiveRoster();

  // Toggle pre/active session strip
  const pre=$('d-pre-session'),actDiv=$('d-active-session');
  if(sessionActive){
    if(pre) pre.style.display='none';
    if(actDiv) actDiv.style.display='block';
  } else {
    if(pre) pre.style.display='block';
    if(actDiv) actDiv.style.display='none';
  }

  const act=G.players.filter(p=>p.status==='active');
  const tot=act.reduce((s,p)=>s+p.currentStack,0);

  // Session stats (active bar)
  const elP=$('d-players'),elPot=$('d-pot'),elA=$('d-addons'),elH=$('d-hands');
  if(elP) elP.textContent=act.length;
  if(elPot) elPot.textContent=fmt(tot);
  if(elA) elA.textContent=G.players.reduce((s,p)=>s+p.addOns.length,0);
  if(elH) elH.textContent=G.hands.length;
  const elBl=$('d-blinds'),elGm=$('d-game');
  if(elBl) elBl.textContent=`$${G.settings.sb.toFixed(2)}/$${G.settings.bb.toFixed(2)}`;
  if(elGm) elGm.textContent=G.settings.game;

  // Committed (RSVP)
  const inRSVPs=RSVPS.filter(r=>r.status==='in');
  const dc=$('d-committed'),dcl=$('d-committed-list');
  if(inRSVPs.length && dc && dcl){
    dc.style.display='block';
    dcl.innerHTML=inRSVPs.map(r=>`<div style="font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;background:var(--ag3);border:1px solid rgba(57,255,20,.2);color:var(--ag)">${r.name}</div>`).join('');
  } else if(dc){ dc.style.display='none'; }

  // Scoreboard + felt table
  const scoreEl=$('d-scoreboard'),pCard=$('d-players-card');
  const tableTitle=$('d-table-title');
  if(sessionActive){
    if(scoreEl) scoreEl.style.display='block';
    if(pCard){ pCard.style.display='block'; pCard.classList.add('table-live'); }
    if(tableTitle) tableTitle.textContent='Live Table';
    renderScoreboard();
  } else {
    if(scoreEl) scoreEl.style.display='none';
    if(pCard){ pCard.style.display='block'; pCard.classList.remove('table-live'); }
    if(tableTitle) tableTitle.textContent='Table';
  }
  // Felt table ‚Äî always update when there are active players
  const allPlayers=G.players.filter(p=>p.status==='active');
  const re=$('d-roster-empty'),fw=$('d-felt-wrap');
  const feltGame=$('d-felt-game'),feltBlinds=$('d-felt-blinds');
  if(feltGame) feltGame.textContent=G.settings.game;
  if(feltBlinds) feltBlinds.textContent=`$${G.settings.sb.toFixed(2)} / $${G.settings.bb.toFixed(2)}`;
  const sub=$('d-table-sub');
  if(!allPlayers.length){
    if(re) re.style.display='block';
    if(fw) fw.style.display='none';
    if(sub) sub.textContent='';
  } else {
    if(re) re.style.display='none';
    if(fw) fw.style.display='block';
    if(sub) sub.textContent=sessionActive?`${allPlayers.length} active`:`${allPlayers.length} seated`;
    renderFeltTable(allPlayers);
    const totalStack=allPlayers.reduce((s,p)=>s+p.currentStack,0);
    const avgStack=allPlayers.length?totalStack/allPlayers.length:0;
    const tp=$('d-tbl-players'),tpot=$('d-tbl-pot'),tavg=$('d-tbl-avg');
    if(tp) tp.textContent=allPlayers.length;
    if(tpot) tpot.textContent=fmt(totalStack);
    if(tavg) tavg.textContent=fmt(avgStack);
  }

  // Stack share + P&L bars ‚Äî hidden during active session
  if(!act.length || sessionActive){
    const sc=$('d-share-card'),pc2=$('d-pnl-card');
    if(sc)sc.style.display='none'; if(pc2)pc2.style.display='none';
  } else {
    const sc=$('d-share-card');if(sc)sc.style.display='block';
    const palCY=['#00d4ff','#39ff14','#ff006e','#e8b84b','#a855f7','#fb923c','#38bdf8','#4ade80','#f472b6','#facc15'];
    const sorted=[...act].sort((a,b)=>b.currentStack-a.currentStack);
    const sb=$('d-share-bars');
    if(sb) sb.innerHTML=sorted.map((p,i)=>{
      const pct=tot>0?Math.round(p.currentStack/tot*100):0;
      return `<div class="bar-row"><div class="bar-n">${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${palCY[i%palCY.length]}"></div></div><div class="bar-pct">${pct}%</div></div>`;
    }).join('');
    const pc2=$('d-pnl-card');if(pc2)pc2.style.display='block';
    const s2=[...act].sort((a,b)=>(b.currentStack-ti(b))-(a.currentStack-ti(a)));
    const mx=Math.max(...s2.map(p=>Math.abs(p.currentStack-ti(p))),0.01);
    const pb=$('d-pnl-bars');
    if(pb) pb.innerHTML=s2.map(p=>{
      const net=p.currentStack-ti(p),pct=Math.round(Math.abs(net)/mx*100);
      const col=net>=0?'var(--ag)':'var(--neg)';
      return `<div class="bar-row"><div class="bar-n">${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${col}"></div></div><div class="bar-pct" style="color:${col}">${net>=0?'+':'-'}${fmt(Math.abs(net))}</div></div>`;
    }).join('');
  }
  renderFeed();
}

function renderScoreboard(){
  const wrap=$('d-score-list'),sub=$('d-score-sub');
  if(!wrap)return;
  const act=G.players.filter(p=>p.status==='active');
  const sorted=[...act].sort((a,b)=>b.currentStack-a.currentStack);
  if(sub) sub.textContent=sorted.length?`${sorted.length} active`:'';
  if(!sorted.length){
    wrap.innerHTML='<div style="padding:18px 0;text-align:center;color:var(--i3);font-size:13px">No active players</div>';
    return;
  }
  const pal=['#00d4ff','#39ff14','#ff006e','#e8b84b','#a855f7','#fb923c','#38bdf8','#4ade80','#f472b6','#facc15'];
  wrap.innerHTML=sorted.map((p,i)=>{
    const net=p.currentStack-ti(p);
    const netStr=net===0?'Even':net>0?`+${fmt(net)}`:`-${fmt(Math.abs(net))}`;
    const netCol=net>0?'var(--ag)':net<0?'var(--neg)':'var(--i3)';
    const bg=pal[i%pal.length];
    return `<div style="display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04)">
      <div style="width:40px;height:40px;border-radius:50%;background:${bg}22;border:2px solid ${bg};display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:700;color:${bg};flex-shrink:0">${p.name.charAt(0).toUpperCase()}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:600;color:var(--i0)">${p.name}</div>
        <div style="font-size:12px;color:${netCol};margin-top:2px">${netStr}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;margin-right:10px">
        <div class="mono" style="font-size:19px;font-weight:500;color:var(--au)">${fmt(p.currentStack)}</div>
        <div style="font-size:10px;color:var(--i3);margin-top:1px">stack</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;flex-shrink:0">
        <button class="btn btn-au btn-xs" style="padding:5px 11px;font-size:12px" onclick="quickAddonFor(${p.id})">+</button>
        <button class="btn btn-xs" style="padding:5px 11px;font-size:12px;color:var(--neg);border-color:rgba(255,69,96,.25);background:rgba(255,69,96,.06)" onclick="quickBustFor(${p.id})">üíÄ</button>
      </div>
    </div>`;
  }).join('');
}

function quickAddonFor(id){
  openQuickAddon();
  const sl=$('qa-player-sel');if(sl)sl.value=id;
}
function quickBustFor(id){
  openQuickBust();
  const sl=$('qa-player-sel');if(sl)sl.value=id;
}

function renderFeed(){
  const fl=$('d-feed'),fe=$('d-feed-empty');
  if(!fl)return;
  if(!G.feed.length){
    if(fe)fe.style.display='block';fl.innerHTML='';
    updatePotTicker();
    return;
  }
  if(fe)fe.style.display='none';
  const items=[...G.feed].reverse().slice(0,40);
  const ACCENT={'üèÜ':'var(--ag)','üí∏':'var(--neg)','‚ô†':'var(--cy)','‚Ü∫':'var(--au)','‚ü≥':'var(--cy)','‚òÖ':'var(--mg)','üíÄ':'var(--neg)','üèÅ':'var(--ag)','‚úé':'var(--i3)','‚Ü©':'var(--i2)','‚ö°':'var(--mg)','‚ô¶':'var(--cy)','ü§°':'var(--neg)','‚ñ∂':'var(--ag)'};
  fl.innerHTML=items.map((f,i)=>{
    const acc=ACCENT[f.icon]||'var(--cy)';
    const age=Date.now()-new Date(f.time).getTime();
    const ageStr=age<60000?'just now':age<3600000?Math.floor(age/60000)+'m':clock(new Date(f.time));
    const metaFmt=(f.meta||'')
      .replace(/(\+\$[\d.]+)/g,`<span style="color:var(--ag);font-weight:700">$1</span>`)
      .replace(/(‚àí\$[\d.]+|-\$[\d.]+)/g,`<span style="color:var(--neg);font-weight:700">$1</span>`)
      .replace(/(\$[\d.]+)/g,`<span style="color:var(--au)">$1</span>`);
    return `<div class="feed-item" style="border-left:2px solid ${i<3?acc:'transparent'};padding-left:8px;margin-left:-2px;${i===0?'animation:slideIn .2s ease both':''}">
      <div class="feed-ico" style="background:${acc}12;border-color:${acc}22;color:${acc}">${f.icon}</div>
      <div class="feed-body">
        <div class="feed-t">${f.title}</div>
        <div class="feed-m">${metaFmt}</div>
      </div>
      <div class="feed-time" style="color:${i===0?acc:'var(--i4)'}">${ageStr}</div>
    </div>`;
  }).join('');
  updatePotTicker();
}

function updatePotTicker(){
  const act=G.players.filter(p=>p.status==='active');
  const ticker=$('d-pot-ticker'),lv=$('d-pot-live');
  if(!ticker||!lv)return;
  if(act.length){
    ticker.style.display='flex';
    lv.textContent=fmt(act.reduce((s,p)=>s+p.currentStack,0));
  }else{
    ticker.style.display='none';
  }
}

function getFeedIcoStyle(icon){
  const map={'üèÜ':'background:rgba(57,255,20,.1);border-color:rgba(57,255,20,.2)','üí∏':'background:rgba(255,69,96,.08);border-color:rgba(255,69,96,.18)','‚ô†':'background:rgba(0,212,255,.08);border-color:rgba(0,212,255,.18)','‚Ü∫':'background:rgba(232,184,75,.08);border-color:rgba(232,184,75,.18)','‚ü≥':'background:rgba(0,212,255,.08);border-color:rgba(0,212,255,.18)','‚òÖ':'background:rgba(232,184,75,.12);border-color:rgba(232,184,75,.22)','üíÄ':'background:rgba(255,69,96,.08);border-color:rgba(255,69,96,.18)','üèÅ':'background:rgba(57,255,20,.08);border-color:rgba(57,255,20,.18)'};
  return map[icon]||'';
}

function addFeed(icon,title,meta){
  G.feed.push({icon,title,meta,time:new Date()});
  if(activeTab==='dash'){
    const fl=$('d-feed'),fe=$('d-feed-empty');
    if(!fl)return;
    if(fe)fe.style.display='none';
    const ACCENT={'üèÜ':'var(--ag)','üí∏':'var(--neg)','‚ô†':'var(--cy)','‚Ü∫':'var(--au)','‚ü≥':'var(--cy)','‚òÖ':'var(--mg)','üíÄ':'var(--neg)','üèÅ':'var(--ag)','‚úé':'var(--i3)','‚Ü©':'var(--i2)','‚ö°':'var(--mg)','‚ô¶':'var(--cy)','ü§°':'var(--neg)','‚ñ∂':'var(--ag)'};
    const acc=ACCENT[icon]||'var(--cy)';
    const metaFmt=(meta||'')
      .replace(/(\+\$[\d.]+)/g,`<span style="color:var(--ag);font-weight:700">$1</span>`)
      .replace(/(‚àí\$[\d.]+|-\$[\d.]+)/g,`<span style="color:var(--neg);font-weight:700">$1</span>`)
      .replace(/(\$[\d.]+)/g,`<span style="color:var(--au)">$1</span>`);
    const div=document.createElement('div');
    div.className='feed-item';
    div.style.cssText=`border-left:2px solid ${acc};padding-left:8px;margin-left:-2px;animation:slideIn .2s ease both`;
    div.innerHTML=`<div class="feed-ico" style="background:${acc}12;border-color:${acc}22;color:${acc}">${icon}</div>
      <div class="feed-body"><div class="feed-t">${title}</div><div class="feed-m">${metaFmt}</div></div>
      <div class="feed-time" style="color:${acc}">just now</div>`;
    fl.insertBefore(div,fl.firstChild);
    while(fl.children.length>40)fl.removeChild(fl.lastChild);
    updatePotTicker();
    // Pulse the feed dot
    const dot=$('feed-pulse');if(dot){dot.style.transform='scale(2)';dot.style.opacity='1';setTimeout(()=>{dot.style.transform='';dot.style.opacity='';},500);}
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYERS PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let selRosterName = null;
let rosterDBOpen = false;

function toggleRosterDB(){
  rosterDBOpen = !rosterDBOpen;
  const list=$('roster-db-list'),tog=$('pl-roster-toggle');
  if(list) list.style.display = rosterDBOpen ? '' : 'none';
  if(tog) tog.textContent = rosterDBOpen ? '‚ñº Hide' : '‚ñ∂ Show';
}

function renderPlayerPanel(){
  const act=G.players.filter(p=>p.status==='active');
  const pe=$('pl-empty'),pl=$('pl-list');
  const sc=$('pl-seating-controls');

  if(!act.length){
    if(pe)pe.style.display='block';
    if(pl)pl.innerHTML='';
    if(sc)sc.style.display='none';
  } else {
    if(pe)pe.style.display='none';
    if(sc)sc.style.display='block';
    const hostName=(G.settings.hostName||'blake').toLowerCase();
    // Update dealer button to show actual host name
    const dealerBtn=$('pl-dealer-btn');
    if(dealerBtn){
      const displayName=G.settings.hostName?G.settings.hostName.charAt(0).toUpperCase()+G.settings.hostName.slice(1):'Blake';
      dealerBtn.textContent=`üÉè ${displayName} ‚Üí Seat 1`;
    }
    if(pl)pl.innerHTML=act.sort((a,b)=>a.seat-b.seat).map(p=>{
      const pnl=p.currentStack-ti(p);
      const pc=pnl>0?'ppnl-pos':pnl<0?'ppnl-neg':'ppnl-zero';
      const isSel=selPlayerId===p.id||selRosterName===p.name;
      const isDealer=p.seat===1;
      const isHost=p.name.toLowerCase()===hostName;
      const seatOpts=Array.from({length:G.settings.seats},(_,i)=>i+1)
        .map(s=>`<option value="${s}"${s===p.seat?' selected':''}>${s}</option>`).join('');
      return `<div class="p-row${isSel?' selected':''}" id="pli-${p.id}" style="gap:6px">
        <div style="position:relative;flex-shrink:0" title="${isDealer?'Dealer seat ‚Äî click to change':'Click to change seat'}">
          ${isDealer?`<div style="position:absolute;top:-7px;left:50%;transform:translateX(-50%);font-size:7px;background:var(--au);color:#000;border-radius:3px;padding:1px 5px;font-weight:900;white-space:nowrap;z-index:1;letter-spacing:.05em">DEAL</div>`:''}
          <select class="p-seat" style="background:${isDealer?'rgba(232,184,75,.12)':'transparent'};border:1px solid ${isDealer?'var(--au)':'var(--br)'};border-radius:var(--r6);color:${isDealer?'var(--au)':'var(--i3)'};cursor:pointer;font-size:11px;font-weight:700;width:38px;height:28px;text-align:center;padding:0 2px;appearance:none;-webkit-appearance:none" onchange="moveSeat(${p.id},parseInt(this.value))" onclick="event.stopPropagation()">
            ${seatOpts}
          </select>
        </div>
        <div class="p-name" onclick="openPlayerPanel(${p.id})">${p.name}${isHost?` <span style="font-size:9px;color:var(--au)" title="Host/Dealer">üÉè</span>`:''}</div>
        <div class="p-stack" onclick="openPlayerPanel(${p.id})">${fmt(p.currentStack)}</div>
        <div class="${pc}" style="min-width:48px;text-align:right" onclick="openPlayerPanel(${p.id})">${pnl===0?'‚Äî':signed(pnl)}</div>
      </div>`;
    }).join('');
  }

  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  const rdb=$('roster-db-list'),rc=$('pl-roster-count');
  if(rc)rc.textContent=ROSTER_DB.length?`${ROSTER_DB.length} players`:'';
  // Keep roster open/closed state in sync after re-render
  if(rdb) rdb.style.display = rosterDBOpen ? '' : 'none';
  const tog=$('pl-roster-toggle');
  if(tog) tog.textContent = rosterDBOpen ? '‚ñº Hide' : '‚ñ∂ Show';

  if(!ROSTER_DB.length){
    if(rdb)rdb.innerHTML='<div class="empty" style="padding:14px 0"><span class="empty-txt">Players appear here after sessions</span></div>';
  }else if(rdb){
    rdb.innerHTML=ROSTER_DB.map(r=>{
      const inSess=G.players.find(p=>p.name===r.name&&p.status==='active');
      const rsvp=RSVPS.find(rv=>rv.name===r.name);
      const sessions=hist.filter(s=>s.players.some(p=>p.name===r.name));
      const lastSess=sessions[0];
      const lastP=lastSess?.players.find(p=>p.name===r.name);
      const lastNet=lastP?.cashout!=null?lastP.cashout-lastP.buyin:null;
      const isSel=selRosterName===r.name||selPlayerId===(inSess?.id);
      let rsvpDot='';
      if(rsvp?.status==='in')rsvpDot=`<span style="width:7px;height:7px;border-radius:50%;background:var(--ag);box-shadow:0 0 6px rgba(57,255,20,.5);display:inline-block"></span>`;
      else if(rsvp?.status==='maybe')rsvpDot=`<span style="width:7px;height:7px;border-radius:50%;background:var(--au);display:inline-block"></span>`;
      const nameEsc=r.name.replace(/'/g,"\\'");
      return `<div style="display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:var(--r8);border:1px solid ${isSel?'var(--cy)':inSess?'rgba(57,255,20,.2)':'var(--br)'};background:${isSel?'var(--cy3)':inSess?'rgba(57,255,20,.04)':'var(--s2)'};margin-bottom:5px;cursor:pointer;transition:all .12s" onclick="openRosterProfile('${nameEsc}')">
        <div style="width:36px;height:36px;border-radius:50%;background:${inSess?'rgba(57,255,20,.1)':'var(--s3)'};border:2px solid ${inSess?'rgba(57,255,20,.3)':'var(--br)'};display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:${inSess?'var(--ag)':'var(--i2)'};flex-shrink:0">${r.name.charAt(0).toUpperCase()}</div>
        <div style="flex:1;min-width:0;overflow:hidden">
          <div style="font-size:12px;font-weight:700;color:${inSess?'var(--ag)':'var(--i0)'};display:flex;align-items:center;gap:5px">${r.name} ${rsvpDot}</div>
          <div style="font-size:11px;color:var(--i3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${inSess?`Seat ${inSess.seat} ¬∑ ${fmt(inSess.currentStack)}`:lastSess?`Last: ${lastSess.date.split(',')[0]}${lastNet!=null?' ¬∑ '+(lastNet>=0?'+':'')+fmt(Math.abs(lastNet)):''}`:sessions.length?`${sessions.length} sessions`:'New player'}</div>
        </div>
        ${!inSess?`<button class="btn btn-cy btn-xs" style="flex-shrink:0" onclick="event.stopPropagation();quickAddFromRoster('${nameEsc}')">+ Add</button>`:`<span style="font-size:9px;color:var(--ag);flex-shrink:0">‚óè live</span>`}
      </div>`;
    }).join('');
  }

  // Restore detail panel ‚Äî use _show* directly to avoid re-triggering renderPlayerPanel
  if(selPlayerId){
    const p=G.players.find(p=>p.id===selPlayerId&&p.status==='active');
    if(p){$('pl-detail-empty').style.display='none';$('pl-detail').style.display='block';renderPlayerDetail(p);}
    else if(selRosterName){$('pl-detail-empty').style.display='none';$('pl-detail').style.display='block';_showRosterProfile(selRosterName);}
    else{selPlayerId=null;}
  } else if(selRosterName){
    $('pl-detail-empty').style.display='none';$('pl-detail').style.display='block';_showRosterProfile(selRosterName);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEATING MANAGEMENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function moveSeat(playerId, newSeat){
  const mover = G.players.find(p=>p.id===playerId);
  if(!mover) return;
  const oldSeat = mover.seat;
  if(newSeat === oldSeat) return;
  // If someone is already in the target seat, swap them
  const occupant = G.players.find(p=>p.seat===newSeat && p.status==='active' && p.id!==playerId);
  if(occupant) occupant.seat = oldSeat;
  mover.seat = newSeat;
  addFeed('üîÄ', `${mover.name} ‚Üí Seat ${newSeat}`, occupant ? `Swapped with ${occupant.name}` : '');
  renderPlayerPanel();
  renderDash();
  toast(`${mover.name} moved to Seat ${newSeat}${occupant ? ` ¬∑ ${occupant.name} to Seat ${oldSeat}` : ''}`);
}

function randomizeSeating(){
  const act = G.players.filter(p=>p.status==='active');
  if(act.length < 2){ toast('Need at least 2 players'); return; }
  const hostName = (G.settings.hostName||'blake').toLowerCase();
  const host = act.find(p=>p.name.toLowerCase()===hostName);
  const others = act.filter(p=>p.name.toLowerCase()!==hostName);

  // Shuffle the non-host players
  for(let i=others.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [others[i],others[j]]=[others[j],others[i]];
  }

  // Assign: host gets seat 1 (dealer), others fill 2..n
  if(host) host.seat = 1;
  others.forEach((p,i)=> p.seat = i + (host ? 2 : 1));

  addFeed('üé≤','Seats randomized', host ? `${host.name} stays at Seat 1 (Dealer)` : 'All seats shuffled');
  renderPlayerPanel();
  renderDash();
  toast('üé≤ Seats randomized ‚Äî good luck everyone');
}

function hostToDealer(){
  const hostName = (G.settings.hostName||'blake').toLowerCase();
  const host = G.players.find(p=>p.name.toLowerCase()===hostName && p.status==='active');
  if(!host){ toast(`${G.settings.hostName||'Blake'} isn't at the table`); return; }
  if(host.seat===1){ toast('Already in the dealer seat'); return; }
  moveSeat(host.id, 1);
}

function openPlayerPanel(id){
  selPlayerId=id;
  const p=G.players.find(p=>p.id===id);
  if(!p) return;
  selRosterName=p.name;
  if(activeTab!=='players'){
    goTab('players',$('nav-players'));return;
  }
  renderPlayerPanel();
  $('pl-detail-empty').style.display='none';
  $('pl-detail').style.display='block';
  renderPlayerDetail(p);
}

function openRosterProfile(name){
  selRosterName=name; selPlayerId=null;
  if(activeTab!=='players'){
    goTab('players',$('nav-players'));return;
  }
  // Don't call renderPlayerPanel here ‚Äî that causes recursion
  // Just show the profile and let the panel re-highlight on next natural render
  $('pl-detail-empty').style.display='none';
  $('pl-detail').style.display='block';
  _showRosterProfile(name);
}

function _showRosterProfile(name){
  const r=getRosterEntry(name);if(!r)return;
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  const sessions=hist.filter(s=>s.players.some(p=>p.name===name));
  const sData=sessions.map(s=>({...s,pData:s.players.find(p=>p.name===name)}));
  const totalNet=sData.filter(s=>s.pData?.cashout!=null).reduce((a,s)=>a+(s.pData.cashout-s.pData.buyin),0);
  const totalBuyin=sData.reduce((a,s)=>a+(s.pData?.buyin||0),0);
  const rsvp=RSVPS.find(rv=>rv.name===name);
  const inSess=G.players.find(p=>p.name===name&&p.status==='active');
  const nameEsc=name.replace(/'/g,"\\'");

  $('pl-detail-empty').style.display='none';
  $('pl-detail').style.display='block';
  $('pl-detail').innerHTML=`
    <div class="card card-cyan">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
        <div style="width:48px;height:48px;border-radius:50%;background:var(--cy3);border:2px solid var(--brc);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--cy);flex-shrink:0">${name.charAt(0).toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-family:'Instrument Serif',serif;font-size:22px;color:var(--i0);line-height:1">${name}</div>
          <div style="font-size:10px;color:var(--i3);margin-top:3px">${sessions.length} session${sessions.length!==1?'s':''} ¬∑ ${inSess?`<span style="color:var(--ag)">At table ¬∑ Seat ${inSess.seat}</span>`:'Not in session'}</div>
        </div>
        <button class="btn btn-ghost btn-xs" onclick="toggleRosterEdit('${nameEsc}')">‚úé Edit</button>
      </div>

      <div id="rp-edit-panel" style="display:none;background:var(--s2);border:1px solid var(--brc);border-radius:var(--r8);padding:12px;margin-bottom:12px">
        <div class="fg" style="margin-bottom:8px"><label class="lbl">Display Name</label><input class="inp inp-sm" id="rp-name-inp" value="${name}" maxlength="24"></div>
        <div class="fg" style="margin-bottom:8px"><label class="lbl">Next Session</label><input class="inp inp-sm" id="rp-next-inp" value="${r.nextSession||''}" placeholder="e.g. Fri Jan 10"></div>
        <div class="flex" style="gap:6px">
          <button class="btn btn-solid-cy btn-sm" style="flex:1" onclick="saveRosterProfile('${nameEsc}')">Save</button>
          <button class="btn btn-ghost btn-xs" onclick="$('rp-edit-panel').style.display='none'">Cancel</button>
        </div>
      </div>

      <div class="pd-stats" style="margin-bottom:14px">
        <div class="pd-stat"><div class="pd-stat-v cy">${sessions.length}</div><div class="pd-stat-l">Sessions</div></div>
        <div class="pd-stat"><div class="pd-stat-v ${totalNet>0?'ag':totalNet<0?'neg':'i2'}">${totalNet===0?'‚Äî':(totalNet>0?'+':'')+fmt(Math.abs(totalNet))}</div><div class="pd-stat-l">All-Time P&L</div></div>
        <div class="pd-stat"><div class="pd-stat-v au">${totalBuyin>0?fmt(totalBuyin):'‚Äî'}</div><div class="pd-stat-l">Total In</div></div>
      </div>

      <div style="background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:10px 12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <span style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase">Next Session</span>
          ${rsvp?`<span style="font-size:9px;padding:2px 8px;border-radius:10px;background:${rsvp.status==='in'?'var(--ag3)':'var(--au3)'};color:${rsvp.status==='in'?'var(--ag)':'var(--au)'}">${rsvp.status==='in'?'In ‚úì':'Maybe'}</span>`:''}
        </div>
        <div style="font-size:13px;font-weight:600;color:var(--i0)">${r.nextSession||'Not scheduled'}</div>
        ${r.lastSeen?`<div style="font-size:10px;color:var(--i3);margin-top:3px">Last seen: ${r.lastSeen}</div>`:''}
      </div>

      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:7px">Session History</div>
      ${!sData.length?`<div class="empty" style="padding:10px 0"><span class="empty-txt">No sessions yet</span></div>`:''}
      <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:14px">
        ${sData.slice(0,8).map(s=>{
          const net=s.pData?.cashout!=null?s.pData.cashout-s.pData.buyin:null;
          return `<div style="display:flex;align-items:center;gap:8px;padding:6px 9px;background:var(--s2);border-radius:var(--r6);border:1px solid var(--br)">
            <div style="flex:1;font-size:11px;color:var(--i3)">${s.date?.split(',')[0]||'‚Äî'}</div>
            <span class="mono au" style="font-size:10px">${fmt(s.pData?.buyin||0)}</span>
            <span style="font-size:11px;font-weight:700;color:${net==null?'var(--i3)':net>0?'var(--ag)':net<0?'var(--neg)':'var(--i2)'}">${net==null?'‚Äî':net>0?'+'+fmt(net):'-'+fmt(Math.abs(net))}</span>
          </div>`;
        }).join('')}
      </div>

      ${inSess?`
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px;border-top:1px solid var(--br);padding-top:10px">Live Session</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="stile" style="cursor:pointer;background:var(--s2)" onclick="openPlayerPanel(${inSess.id})">
            <div class="stile-v cy">${fmt(inSess.currentStack)}</div><div class="stile-l">Stack</div>
          </div>
          <div class="stile" style="background:var(--s2)">
            <div class="stile-v au">${fmt(ti(inSess))}</div><div class="stile-l">Total In</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">
          <button class="btn btn-solid-cy btn-sm" onclick="goToCashOut(${inSess.id})">$ Cash Out</button>
          <button class="btn btn-au btn-sm" onclick="openPlayerPanel(${inSess.id})">‚úé Manage</button>
        </div>
        <button class="btn btn-sm btn-full" style="border-color:rgba(255,69,96,.3);color:var(--neg);font-weight:700;padding:9px" onclick="bustPlayerZero(${inSess.id})">üíÄ Bust ‚Äî Cash Out $0</button>
      `:`<button class="btn btn-solid-cy btn-full" onclick="quickAddFromRoster('${nameEsc}')">+ Add to Current Session</button>`}
    </div>`;
}

function toggleRosterEdit(name){
  const panel=$('rp-edit-panel');
  if(panel)panel.style.display=panel.style.display==='none'?'block':'none';
}

function saveRosterProfile(oldName){
  const newName=($('rp-name-inp')?.value||'').trim();
  const nextSess=($('rp-next-inp')?.value||'').trim();
  if(!newName){toast('Name required');return;}
  const r=getRosterEntry(oldName);if(!r){toast('Not found');return;}
  if(newName!==oldName){
    // Rename in roster and in current session
    r.name=newName;
    G.players.filter(p=>p.name===oldName).forEach(p=>p.name=newName);
    if(selRosterName===oldName)selRosterName=newName;
  }
  r.nextSession=nextSess||null;
  r.lastSeen=r.lastSeen||new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  saveRosterDB();
  renderPlayerPanel();
  toast(`${newName} updated`);
}

function renderPlayerDetail(p){
  if(!p)return;
  selPlayerId=p.id;
  selRosterName=p.name; // keep name synced so profile tab still works
  const tot=ti(p),pnl=p.currentStack-tot;
  const pc=pnl>0?'ag':pnl<0?'neg':'';
  $('pl-detail').innerHTML=`
    <div class="card card-cyan">
      <div class="pd-name">${p.name} <span style="font-size:12px;font-weight:400;color:var(--i3)">Seat ${p.seat}</span></div>
      <div class="pd-stats">
        <div class="pd-stat"><div class="pd-stat-v cy">${fmt(p.currentStack)}</div><div class="pd-stat-l">Stack</div></div>
        <div class="pd-stat"><div class="pd-stat-v ${pc||'i2'}">${pnl===0?'‚Äî':signed(pnl)}</div><div class="pd-stat-l">Net P&L</div></div>
        <div class="pd-stat"><div class="pd-stat-v au">${fmt(tot)}</div><div class="pd-stat-l">Total In</div></div>
      </div>

      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--br)">Chips</div>
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-bottom:10px">
        <div><label class="lbl">Add-On ($)</label><input class="inp inp-sm" type="number" id="pd-ao-amt" value="${G.settings.defaultBuyin}" min="0.10" step="0.10" oninput="updateAOPreview()"></div>
        <button class="btn btn-au" onclick="doAddon(${p.id})" style="height:36px">Add-On</button>
      </div>
      <div style="font-size:10px;color:var(--i3);margin-bottom:12px">Stack after: <span class="mono cy" id="pd-ao-preview">${fmt(p.currentStack+G.settings.defaultBuyin)}</span></div>
      <button class="btn btn-full mb12" style="border-color:rgba(255,69,96,.3);color:#ff6b6b;background:rgba(255,69,96,.06);font-weight:700" onclick="openDumbWin(${p.id})">üÉè Log Hand</button>

      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--br)">Transaction Log</div>
      <div class="addon-log mb12">
        <div class="addon-line"><span class="atag bi">BUY-IN</span><span class="addon-amt">${fmt(p.buyin)}</span><span class="addon-when">${clock(p.joinedAt)}</span></div>
        ${p.addOns.map(a=>`<div class="addon-line"><span class="atag rb">${a.type.toUpperCase()}</span><span class="addon-amt">+${fmt(a.amount)}</span><span class="addon-when">${clock(a.time)}</span></div>`).join('')}
      </div>

      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--br)">Update Stack</div>
      <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end;margin-bottom:14px">
        <div><label class="lbl">Current Stack Size ($)</label><input class="inp inp-sm" type="number" id="pd-stk-val" value="${p.currentStack}" min="0" step="0.10" onkeydown="if(event.key==='Enter')doUpdateStack(${p.id})"></div>
        <button class="btn btn-cy" onclick="doUpdateStack(${p.id})" style="height:36px">Set</button>
        <button class="btn" onclick="openChipsForPlayer(${p.id})" style="height:36px;font-size:10px">üì∑</button>
      </div>

      <div class="flex">
        <button class="btn btn-solid-cy" style="flex:1" onclick="goToCashOut(${p.id})">$ Cash Out</button>
        <button class="btn btn-ghost btn-xs" onclick="openRosterProfile('${p.name.replace(/'/g,"\\'")}')">Profile</button>
      </div>
      <div class="flex mt8">
        <button class="btn" style="flex:1;border-color:rgba(255,69,96,.3);color:var(--neg);font-weight:700;padding:11px 0;font-size:12px" onclick="bustPlayerZero(${p.id})">üíÄ Bust ‚Äî Cash Out $0</button>
      </div>
    </div>`;

  document.querySelectorAll('.p-row').forEach(r=>r.classList.remove('selected'));
  const pli=$(`pli-${p.id}`);if(pli)pli.classList.add('selected');
}

function updateAOPreview(){
  const amt=parseFloat($('pd-ao-amt')?.value)||0;
  const p=G.players.find(p=>p.id===selPlayerId);
  if(p&&$('pd-ao-preview'))$('pd-ao-preview').textContent=fmt(p.currentStack+amt);
}
function doAddon(id){
  const amt=parseFloat($('pd-ao-amt').value)||G.settings.defaultBuyin;
  const p=G.players.find(p=>p.id===id);
  p.addOns.push({amount:amt,type:'add-on',time:new Date()});
  p.addOnTotal+=amt;p.currentStack+=amt;
  addFeed('‚Ü∫',`${p.name} add-on`,`+${fmt(amt)} ‚Üí ${fmt(p.currentStack)}`);
  refresh();renderPlayerPanel();toast(`${p.name} +${fmt(amt)}`);
}
function doUpdateStack(id){
  const nv=parseFloat($('pd-stk-val').value);
  if(isNaN(nv)||nv<0){toast('Invalid');return;}
  const p=G.players.find(p=>p.id===id),old=p.currentStack;p.currentStack=nv;
  addFeed('‚ü≥',`${p.name} stack set`,`${fmt(old)} ‚Üí ${fmt(nv)}`);
  refresh();renderPlayerPanel();toast(`${p.name}: ${fmt(nv)}`);
}
function doMarkOut(id){
  if(!confirm('Mark as out (no cashout recorded)?'))return;
  const p=G.players.find(p=>p.id===id);p.status='out';
  addFeed('üíÄ',`${p.name} busted`,`In: ${fmt(ti(p))}`);
  selPlayerId=null;refresh();renderPlayerPanel();toast(`${p.name} out`);
}
function bustPlayerZero(id){
  const p=G.players.find(q=>q.id===id);if(!p)return;
  const lost=ti(p);
  p.status='cashed';p.cashoutAmount=0;p.currentStack=0;
  settleChecked[p.id]=false;
  addFeed('üíÄ',`${p.name} busted`,`Lost ${fmt(lost)} ¬∑ Cashed $0`);
  selPlayerId=null;
  // Keep them selected in cashout so user sees confirmation
  if(activeTab==='cashout'){ coSelectedId=id; refresh(); renderCashOut(); }
  else { coSelectedId=null; refresh(); if(activeTab==='players') renderPlayerPanel(); }
  toast(`${p.name} busted ‚Äî $0`);
}
function goToCashOut(id){
  coSelectedId=id;
  goTab('cashout',$('nav-cashout'));
}
function openChipsForPlayer(id){
  selPlayer=id;
  goTab('chips',$('nav-chips'));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADD PLAYER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openAdd(presetSeat){
  const n=G.settings.seats,sel=$('ap-seat');
  sel.innerHTML='';let found=false;
  for(let i=1;i<=n;i++){
    if(!G.players.some(p=>p.seat===i&&p.status==='active')){
      sel.innerHTML+=`<option value="${i}"${presetSeat===i?' selected':''}>Seat ${i}</option>`;found=true;
    }
  }
  if(!found){toast('All seats taken');return;}
  $('ap-name').value='';$('ap-buyin').value=G.settings.defaultBuyin;

  // Populate datalist
  const dl=$('roster-datalist');
  dl.innerHTML=ROSTER_DB.filter(r=>!G.players.some(p=>p.name===r.name&&p.status==='active'))
    .map(r=>`<option value="${r.name}">`).join('');

  // Quick-add chips
  const available=ROSTER_DB.filter(r=>!G.players.some(p=>p.name===r.name&&p.status==='active'));
  const qsec=$('ap-roster-quick'),qchips=$('ap-roster-chips');
  if(available.length && qsec && qchips){
    qsec.style.display='block';
    qchips.innerHTML=available.map(r=>{
      const nameEsc=r.name.replace(/'/g,"\\'");
      return `<button class="btn btn-cy btn-xs" style="padding:5px 10px" onclick="quickAddFromModal('${nameEsc}')">+ ${r.name}</button>`;
    }).join('');
  } else if(qsec){ qsec.style.display='none'; }

  om('m-add');setTimeout(()=>$('ap-name').focus(),120);
}

function openAddAtSeat(seatNum){ openAdd(seatNum); }
function ap_name_change(){/* roster lookup could go here */}

function quickAddFromModal(name){
  const freeSeat=Array.from({length:G.settings.seats},(_,i)=>i+1).find(s=>!G.players.some(p=>p.seat===s&&p.status==='active'));
  if(!freeSeat){toast('No open seats');return;}
  G.players.push({id:G.nextId++,name,buyin:G.settings.defaultBuyin,addOns:[],addOnTotal:0,seat:freeSeat,status:'active',currentStack:G.settings.defaultBuyin,cashoutAmount:null,joinedAt:new Date()});
  upsertRoster(name);
  addFeed('‚ô†',`${name} bought in`,`${fmt(G.settings.defaultBuyin)} ¬∑ Seat ${freeSeat}`);
  refresh();
  // Re-render the modal to remove added player from chips
  const available=ROSTER_DB.filter(r=>!G.players.some(p=>p.name===r.name&&p.status==='active'));
  const qsec=$('ap-roster-quick'),qchips=$('ap-roster-chips');
  if(qchips) qchips.innerHTML=available.map(r=>{
    const ne=r.name.replace(/'/g,"\\'");
    return `<button class="btn btn-cy btn-xs" style="padding:5px 10px" onclick="quickAddFromModal('${ne}')">+ ${r.name}</button>`;
  }).join('');
  if(qsec) qsec.style.display=available.length?'block':'none';
  // Update seat select
  const sel=$('ap-seat');sel.innerHTML='';
  for(let i=1;i<=G.settings.seats;i++){
    if(!G.players.some(p=>p.seat===i&&p.status==='active'))
      sel.innerHTML+=`<option value="${i}">Seat ${i}</option>`;
  }
  toast(`${name} ‚Üí Seat ${freeSeat}`);
}

function quickAddFromRoster(name){
  const freeSeat=Array.from({length:G.settings.seats},(_,i)=>i+1).find(s=>!G.players.some(p=>p.seat===s&&p.status==='active'));
  if(!freeSeat){toast('No open seats');return;}
  G.players.push({id:G.nextId++,name,buyin:G.settings.defaultBuyin,addOns:[],addOnTotal:0,seat:freeSeat,status:'active',currentStack:G.settings.defaultBuyin,cashoutAmount:null,joinedAt:new Date()});
  upsertRoster(name);
  addFeed('‚ô†',`${name} bought in`,`${fmt(G.settings.defaultBuyin)} ¬∑ Seat ${freeSeat}`);
  refresh();renderPlayerPanel();toast(`${name} ‚Üí Seat ${freeSeat}`);
}

function doAddPlayer(){
  const name=$('ap-name').value.trim();
  const buyin=parseFloat($('ap-buyin').value)||G.settings.defaultBuyin;
  const seat=parseInt($('ap-seat').value);
  if(!name){toast('Enter a name');return;}
  G.players.push({id:G.nextId++,name,buyin,addOns:[],addOnTotal:0,seat,status:'active',currentStack:buyin,cashoutAmount:null,joinedAt:new Date()});
  upsertRoster(name);
  addFeed('‚ô†',`${name} bought in`,`${fmt(buyin)} ¬∑ Seat ${seat}`);
  cm('m-add');refresh();toast(`${name} ‚Üí Seat ${seat}`);
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CASH OUT ‚Äî full rewrite
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let sessionClosed = false;
let sessionClosedAt = null;
let coEditMode = false; // true when editing txns inline

function renderBalanceBar(){
  const bar=$('co-balance-bar');if(!bar)return;
  const all=G.players.filter(p=>p.status==='active'||p.status==='cashed'||p.status==='out');
  if(!all.length){bar.style.display='none';return;}
  bar.style.display='block';

  const totalIn=all.reduce((s,p)=>s+ti(p),0);
  const cashedOut=all.filter(p=>p.status==='cashed'||p.status==='out').reduce((s,p)=>s+(p.cashoutAmount||0),0);
  const activeStack=all.filter(p=>p.status==='active').reduce((s,p)=>s+p.currentStack,0);
  const accountedFor=cashedOut+activeStack;
  const diff=accountedFor-totalIn; // should be 0 if math checks out

  $('co-bal-in').textContent=fmt(totalIn);
  $('co-bal-out').textContent=fmt(cashedOut);
  $('co-bal-active').textContent=fmt(activeStack);

  const diffEl=$('co-bal-diff');
  const statEl=$('co-bal-status');
  const fillEl=$('co-bal-fill');

  const balanced=Math.abs(diff)<0.02;
  if(balanced){
    diffEl.textContent='‚úì Balanced';
    diffEl.style.color='var(--ag)';
    diffEl.style.fontSize='16px';
    statEl.textContent='money in = money out';
    statEl.style.color='var(--ag)';
    if(fillEl){fillEl.style.width='100%';fillEl.style.background='var(--ag)';}
  } else {
    const sign=diff>0?'+':'-';
    diffEl.textContent=sign+fmt(Math.abs(diff));
    diffEl.style.color=diff>0?'var(--ag)':'var(--neg)';
    diffEl.style.fontSize='24px';
    statEl.textContent=diff>0?'more cashed than bought in':'unaccounted chips';
    statEl.style.color=diff>0?'var(--ag)':'var(--neg)';
    const pct=totalIn>0?Math.min(accountedFor/totalIn,1):0;
    if(fillEl){fillEl.style.width=(pct*100)+'%';fillEl.style.background=diff>0?'var(--ag)':'var(--neg)';}
  }
}

function renderCashOut(){
  renderBalanceBar();

  // Session closed banner
  const banner=$('co-closed-banner');
  if(banner){
    banner.style.display = sessionClosed ? 'flex' : 'none';
    if(sessionClosed && sessionClosedAt) $('co-closed-time').textContent = 'Closed at '+clock(sessionClosedAt);
  }
  const closeBtn=$('co-close-btn');
  if(closeBtn) closeBtn.style.display = sessionClosed ? 'none' : 'inline-flex';

  const all=G.players.filter(p=>p.status==='active'||p.status==='cashed'||p.status==='out');
  const cpl=$('co-player-list');

  if(!all.length){
    cpl.innerHTML='<div class="empty" style="padding:18px 0"><span class="empty-txt">No players ‚Äî add some first</span></div>';
    $('co-form').style.display='none';$('co-no-selection').style.display='block';
    renderPayout();return;
  }

  // Summary line
  const totalIn=G.players.reduce((s,p)=>s+ti(p),0);
  const cashedCount=G.players.filter(p=>p.status==='cashed').length;
  const co=$('co-summary');
  if(co) co.textContent=`${cashedCount}/${all.length} cashed ¬∑ ${fmt(totalIn)} in play`;

  cpl.innerHTML=all.sort((a,b)=>a.seat-b.seat).map(p=>{
    let badge='',cardCls='';
    if(p.status==='cashed'){
      const net=(p.cashoutAmount||0)-ti(p);
      badge=`<span class="co-status-badge ${net>=0?'csb-paid':'csb-collect'}">${net>0?'+'+(fmt(net)):net<0?'‚àí'+fmt(Math.abs(net)):'Even'}</span>`;
      cardCls='cashed';
    }else if(p.status==='out'){
      badge=`<span class="co-status-badge csb-collect">Busted</span>`;
    }else{
      badge=`<span class="co-status-badge csb-pending">Playing</span>`;
    }
    const isSel = coSelectedId===p.id;
    return `<div class="co-player-card ${cardCls}${isSel?' selected':''}" onclick="selectCOPlayer(${p.id})">
      <div class="co-row">
        <span class="co-name">${p.name}</span>
        <span style="font-size:10px;color:var(--i3);white-space:nowrap"><span class="mono au">${fmt(ti(p))}</span>${p.status==='active'?`‚Üí<span class="mono cy">${fmt(p.currentStack)}</span>`:p.status==='cashed'?`‚Üí<span class="mono">${fmt(p.cashoutAmount||0)}</span>`:''}</span>
        ${badge}
      </div>
    </div>`;
  }).join('');

  // Right panel
  if(coSelectedId){
    const p=G.players.find(q=>q.id===coSelectedId);
    if(p){ $('co-no-selection').style.display='none'; $('co-form').style.display='block'; populateCOForm(p); }
    else { $('co-form').style.display='none'; $('co-no-selection').style.display='block'; }
  }else{
    $('co-form').style.display='none'; $('co-no-selection').style.display='block';
  }

  renderPayout();
}

function populateCOForm(p){
  $('co-form-name').textContent = p.name;
  $('co-form-seat').textContent = `Seat ${p.seat} ¬∑ ${p.status==='cashed'?'Cashed out':'Active'}`;

  // Transaction log with edit/delete
  renderCOTxnLog(p);

  // Known stack from currentStack (synced from chip counter)
  const stackEl=$('co-known-stack'), useBtn=$('co-use-stack-btn');
  if(p.status!=='cashed' && p.currentStack>0){
    stackEl.textContent = fmt(p.currentStack);
    if(useBtn){ useBtn.style.display='inline-flex'; }
  } else {
    stackEl.textContent = p.status==='cashed' ? fmt(p.cashoutAmount||0)+' (cashed)' : '‚Äî';
    if(useBtn) useBtn.style.display='none';
  }

  // Build chip inputs
  buildCOChipInputs(p);

  // If already cashed out show locked state
  if(p.status==='cashed'){
    $('co-manual').value = (p.cashoutAmount||0).toFixed(2);
    $('co-manual').disabled = false;
    recalcCO();
    // Hide confirm buttons, show correction + undo buttons
    ['co-confirm-win','co-confirm-loss','co-confirm-neutral'].forEach(id=>{const e=$(id);if(e)e.style.display='none';});
    const editArea=$('co-cashed-edit');
    if(!editArea){
      const div=document.createElement('div');div.id='co-cashed-edit';div.style.cssText='margin-top:10px;display:flex;gap:8px';
      div.innerHTML=`<button class="btn btn-ghost btn-sm" style="flex:1" onclick="uncashPlayer(${p.id})">‚Ü© Undo Cash Out</button><button class="btn btn-cy btn-sm" style="flex:1" onclick="saveCashedStack(${p.id})">üíæ Save Correction</button>`;
      $('co-manual').parentElement.after(div);
    }
  } else {
    $('co-manual').disabled=false;
    const old=$('co-cashed-edit');if(old)old.remove();
    const manual=$('co-manual');if(manual&&!manual.value)recalcCO();
  }

  // ‚îÄ‚îÄ Player quick actions (active only) ‚îÄ‚îÄ
  const qa=$('co-player-actions');
  if(qa){
    if(p.status==='active'){
      qa.style.display='block';
      qa.innerHTML=`
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px;padding-top:4px;border-top:1px solid var(--br)">Player Actions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px">
          <button class="btn btn-au btn-sm" onclick="coQuickAddon(${p.id})">‚Ü∫ Add-On / Re-Buy</button>
          <button class="btn btn-cy btn-sm" onclick="openChipsForPlayer(${p.id})">üì∑ Chip Counter</button>
        </div>
        <button class="btn btn-sm btn-full" style="border-color:rgba(255,69,96,.3);color:var(--neg);font-weight:700;padding:10px 0" onclick="bustPlayerZero(${p.id})">üíÄ Bust ‚Äî Cash Out at $0</button>`;
    } else {
      qa.style.display='none';
    }
  }
}

function renderCOTxnLog(p){
  const log=$('co-txn-log');if(!log)return;
  const editable = coEditMode;
  let html='';
  // Buy-in row
  html+=`<div style="display:flex;align-items:center;gap:7px;padding:6px 0;border-bottom:1px solid var(--br)">
    <span class="atag bi" style="flex-shrink:0">BUY-IN</span>
    ${editable
      ? `<input type="number" value="${p.buyin}" min="0" step="0.10" style="width:70px;background:var(--s1);border:1px solid var(--brc);border-radius:4px;padding:3px 6px;color:var(--cy);font-family:'DM Mono',monospace;font-size:12px;outline:none" onchange="editBuyIn(${p.id},this.value)">`
      : `<span class="addon-amt">${fmt(p.buyin)}</span>`}
    <span class="addon-when" style="margin-left:auto">${clock(p.joinedAt)}</span>
  </div>`;
  // Add-on rows
  p.addOns.forEach((a,i)=>{
    html+=`<div style="display:flex;align-items:center;gap:7px;padding:6px 0;border-bottom:1px solid var(--br)">
      <span class="atag rb" style="flex-shrink:0">${a.type.toUpperCase().slice(0,6)}</span>
      ${editable
        ? `<input type="number" value="${a.amount}" min="0" step="0.10" style="width:70px;background:var(--s1);border:1px solid var(--brc);border-radius:4px;padding:3px 6px;color:var(--au);font-family:'DM Mono',monospace;font-size:12px;outline:none" onchange="editAddOn(${p.id},${i},this.value)">`
        : `<span class="addon-amt">+${fmt(a.amount)}</span>`}
      <span class="addon-when" style="margin-left:auto">${clock(a.time)}</span>
      ${editable?`<button onclick="deleteAddOn(${p.id},${i})" style="background:none;border:none;color:var(--neg);cursor:pointer;font-size:14px;padding:0 2px;line-height:1">√ó</button>`:''}
    </div>`;
  });
  log.innerHTML=html||'<div style="font-size:11px;color:var(--i4);padding:6px 0">No transactions</div>';
  $('co-total-in').textContent=fmt(ti(p));

  // Edit button label
  const editBtn=$('co-edit-btn');
  if(editBtn) editBtn.textContent = editable ? '‚úì Done' : '‚úé Edit';
}

function editBuyInMode(){
  coEditMode=!coEditMode;
  const p=G.players.find(q=>q.id===coSelectedId);if(p)renderCOTxnLog(p);
}
function editBuyIn(id,val){
  const p=G.players.find(q=>q.id===id);if(!p)return;
  const old=p.buyin;
  p.buyin=parseFloat(val)||0;
  // Adjust stack by delta
  p.currentStack=Math.max(0,p.currentStack+(p.buyin-old));
  $('co-total-in').textContent=fmt(ti(p));
  recalcCO();
  addFeed('‚úé',`${p.name} buy-in edited`,`${fmt(old)} ‚Üí ${fmt(p.buyin)}`);
  refresh();
}
function editAddOn(id,idx,val){
  const p=G.players.find(q=>q.id===id);if(!p||!p.addOns[idx])return;
  const old=p.addOns[idx].amount;
  const nv=parseFloat(val)||0;
  p.addOnTotal+=(nv-old);
  p.currentStack=Math.max(0,p.currentStack+(nv-old));
  p.addOns[idx].amount=nv;
  $('co-total-in').textContent=fmt(ti(p));
  recalcCO(); refresh();
}
function deleteAddOn(id,idx){
  const p=G.players.find(q=>q.id===id);if(!p||!p.addOns[idx])return;
  const amt=p.addOns[idx].amount;
  p.addOnTotal-=amt;
  p.currentStack=Math.max(0,p.currentStack-amt);
  p.addOns.splice(idx,1);
  addFeed('‚úé',`${p.name} add-on removed`,`‚àí${fmt(amt)}`);
  renderCOTxnLog(p); recalcCO(); refresh();
}

function buildCOChipInputs(p){
  const grid=$('co-chip-inputs');if(!grid)return;
  grid.innerHTML=DENOMS.map(d=>`
    <div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--s1);border:1px solid var(--br);border-radius:var(--r4)">
      <div style="width:10px;height:10px;border-radius:50%;background:${d.color};flex-shrink:0"></div>
      <span style="font-size:10px;color:var(--i3);flex:1">${d.name}</span>
      <input type="number" id="co-c-${d.id}" value="0" min="0"
        style="width:46px;background:var(--s2);border:1px solid var(--br);border-radius:4px;padding:4px 6px;color:var(--cy);font-family:'DM Mono',monospace;font-size:12px;outline:none;text-align:center;caret-color:var(--cy)"
        oninput="calcCOChips()">
    </div>`).join('');
  calcCOChips();
}

function coCaptureChips(){
  const inp=$('co-scan-input');if(inp)inp.click();
}
function coHandleScan(e){
  const file=e.target.files[0];if(!file)return;
  // Reset input so same file can be reselected
  e.target.value='';
  const reader=new FileReader();
  reader.onload=ev=>{
    const base64=(ev.target.result||'').split(',')[1]||'';
    const chipValues=DENOMS.map(d=>d.name.toUpperCase()+'=$'+d.value.toFixed(2)).join(', ');
    toast('Scanning chips‚Ä¶',2000);
    fetch('/api/chip-counter',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64:base64,chipValues})})
      .then(r=>r.json())
      .then(data=>{
        if(!data||data.error){toast('Scan failed: '+(data&&data.error||'unknown'));return;}
        coApplyScan(data);
      })
      .catch(err=>toast('Scan failed: '+err.message,5000));
  };
  reader.readAsDataURL(file);
}
function coApplyScan(data){
  if(!data||!data.counts)return;
  const idMap={red:'r',blue:'b',black:'bl',green:'g'};
  Object.entries(data.counts).forEach(([col,cnt])=>{
    const inp=$(`co-c-${idMap[col]||col}`);
    if(inp)inp.value=cnt;
  });
  calcCOChips();
  toast(`Scanned: ${fmt(data.total)}`);
}

function calcCOChips(){
  let tot=0;
  DENOMS.forEach(d=>{const i=$(`co-c-${d.id}`);if(i)tot+=(parseFloat(i.value)||0)*d.value;});
  tot=parseFloat(tot.toFixed(2));
  const ctEl=$('co-chip-total');if(ctEl)ctEl.textContent=fmt(tot);
  // Only override if user has actually entered chip counts (tot > 0)
  // and there's no manual override already entered
  const manual=$('co-manual');
  if(tot>0&&manual&&!manual.value){
    recalcCO(tot);
  }else if(tot===0&&manual&&!manual.value){
    // If chips cleared, fall back to known stack
    const p=G.players.find(q=>q.id===coSelectedId);
    if(p&&p.status==='active'&&p.currentStack>0) recalcCO(p.currentStack);
    else recalcCO(0);
  }
}

function useKnownStack(){
  const p=G.players.find(q=>q.id===coSelectedId);if(!p)return;
  const manual=$('co-manual');
  if(manual){ manual.value=p.currentStack.toFixed(2); recalcCO(); }
  toast('Stack value loaded');
}

function recalcCO(chipTot){
  const p=G.players.find(q=>q.id===coSelectedId);if(!p)return;
  const manual=$('co-manual');
  let val;
  if(manual&&manual.value!==''){
    val=parseFloat(manual.value)||0;
  }else if(chipTot!==undefined){
    val=chipTot;
  }else{
    // Try chip inputs first
    let chipSum=0;
    DENOMS.forEach(d=>{const i=$(`co-c-${d.id}`);if(i)chipSum+=(parseFloat(i.value)||0)*d.value;});
    chipSum=parseFloat(chipSum.toFixed(2));
    // Fall back to known stack if no chips entered
    if(chipSum>0) val=chipSum;
    else if(p.status==='active'&&p.currentStack>0) val=p.currentStack;
    else val=0;
  }
  const totalInvested=ti(p);
  const net=parseFloat((val-totalInvested).toFixed(2));
  const res=$('co-result');
  if(!res||isNaN(val))return;
  res.style.display='block';
  const ne=$('co-net');
  ne.textContent=net===0?'$0.00':signed(net);
  ne.className='co-net '+(net>0?'pos':net<0?'neg':'');
  $('co-sub').textContent=net>0?'Profit üèÜ':net<0?'Loss':'Break Even';
  $('co-detail').textContent=`Final value ${fmt(val)} ¬∑ Invested ${fmt(totalInvested)}${p.addOns.length?` ¬∑ ${p.addOns.length} add-on${p.addOns.length!==1?'s':''}` :''}`;
  // Update chip total display to reflect what we're using
  const ct=$('co-chip-total');if(ct&&chipTot!==undefined)ct.textContent=fmt(val);
  // Show correct confirm button
  if(p.status!=='cashed'){
    $('co-confirm-win').style.display  = net>0  ? 'block' : 'none';
    $('co-confirm-loss').style.display = net<0  ? 'block' : 'none';
    $('co-confirm-neutral').style.display = net===0 ? 'block' : 'none';
  }
  // Store for confirmCO
  p._pendingCOValue=val;
}

function selectCOPlayer(id){
  coSelectedId=id; coEditMode=false;
  const manual=$('co-manual');if(manual)manual.value='';
  // Clear chip inputs
  DENOMS.forEach(d=>{const i=$(`co-c-${d.id}`);if(i)i.value='0';});
  const old=$('co-cashed-edit');if(old)old.remove();
  renderCashOut();
  // After render, pre-populate chip total from player's current stack
  const p=G.players.find(q=>q.id===id);
  if(p&&p.status==='active'&&p.currentStack>0){
    const ct=$('co-chip-total');
    if(ct)ct.textContent=fmt(p.currentStack);
    // Trigger recalc with the known stack as starting value so result shows immediately
    recalcCO(p.currentStack);
  }
}

function confirmCO(){
  const p=G.players.find(q=>q.id===coSelectedId);
  if(!p){toast('Select a player');return;}
  if(p.status==='cashed'){toast('Already cashed out');return;}
  // Use pending value if available, else recalculate
  let val=p._pendingCOValue;
  if(val===undefined||val===null){
    const manual=$('co-manual');
    if(manual&&manual.value!=='') val=parseFloat(manual.value)||0;
    else{
      let chipSum=0;
      DENOMS.forEach(d=>{const i=$(`co-c-${d.id}`);if(i)chipSum+=(parseFloat(i.value)||0)*d.value;});
      val=parseFloat(chipSum.toFixed(2));
      if(val===0&&p.currentStack>0) val=p.currentStack;
    }
  }
  val=parseFloat(val.toFixed(2));
  const net=parseFloat((val-ti(p)).toFixed(2));
  p.status='cashed'; p.cashoutAmount=val; p.currentStack=0; delete p._pendingCOValue;
  addFeed(net>0?'üèÜ':'üí∏',`${p.name} cashed out`,`${fmt(val)} ¬∑ Net ${net>=0?'+'+fmt(net):'‚àí'+fmt(Math.abs(net))}`);
  coSelectedId=null; coEditMode=false; refresh(); renderCashOut();
  setTimeout(()=>{const sl=$('settle-list');if(sl)sl.scrollIntoView({behavior:'smooth',block:'nearest'});},300);
  toast(net>0?`${p.name} wins ${fmt(net)} üèÜ`:net<0?`${p.name} out ‚Äî owes ${fmt(Math.abs(net))}`:`${p.name} breaks even`);
}

function uncashPlayer(id){
  const p=G.players.find(q=>q.id===id);if(!p)return;
  p.status='active'; p.currentStack=p.cashoutAmount||0; p.cashoutAmount=null;
  settleChecked[id]=false;
  addFeed('‚Ü©',`${p.name} cash-out undone`,'Back to active');
  coSelectedId=id; refresh(); renderCashOut();
  toast(`${p.name} moved back to active`);
}

function saveCashedStack(id){
  const p=G.players.find(q=>q.id===id);if(!p||p.status!=='cashed')return;
  const manual=$('co-manual');
  if(!manual||manual.value===''){toast('Enter a corrected amount');return;}
  const val=parseFloat(parseFloat(manual.value).toFixed(2));
  if(isNaN(val)||val<0){toast('Invalid amount');return;}
  const old=p.cashoutAmount||0;
  p.cashoutAmount=val;
  addFeed('‚úé',`${p.name} cashout corrected`,`${fmt(old)} ‚Üí ${fmt(val)}`);
  refresh(); renderCashOut();
  toast(`${p.name} updated to ${fmt(val)}`);
}

// Quick add-on from the cash out tab ‚Äî uses shared modal
function coQuickAddon(id){
  const p=G.players.find(q=>q.id===id);if(!p)return;
  const sl=$('qa-player-sel');
  if(!sl){toast('Modal not ready');return;}
  const act=G.players.filter(q=>q.status==='active');
  sl.innerHTML=act.map(q=>`<option value="${q.id}"${q.id===id?' selected':''}>${q.name} ‚Äî ${fmt(q.currentStack)}</option>`).join('');
  $('qa-amount').value=G.settings.defaultBuyin;
  const tr=$('qa-type-row'),ar=$('qa-amount-row');
  if(tr)tr.style.display='';if(ar)ar.style.display='';
  $('qa-modal-title').textContent='Add-On / Re-Buy';
  $('qa-action-btn').textContent='Add Chips';
  $('qa-action-btn').style.cssText='';
  $('qa-action-btn').onclick=()=>{
    const pp=G.players.find(q=>q.id===parseInt($('qa-player-sel').value));
    const amt=parseFloat($('qa-amount').value)||G.settings.defaultBuyin;
    const type=$('qa-type').value||'rebuy';
    if(!pp)return;
    pp.addOns.push({amount:amt,type,time:new Date()});
    pp.addOnTotal+=amt;pp.currentStack+=amt;
    addFeed('‚Ü∫',`${pp.name} ${type}`,`+${fmt(amt)} ‚Üí ${fmt(pp.currentStack)}`);
    closeQuickAction();refresh();renderCashOut();toast(`${pp.name} +${fmt(amt)}`);
  };
  om('m-quick-action');
}

// Payout panel (replaces renderSettle)
function renderPayout(){
  const cashed=G.players.filter(p=>p.status==='cashed'||p.status==='out');
  const se=$('settle-empty'),sl=$('settle-list');
  if(!se||!sl)return;
  if(!cashed.length){se.style.display='block';sl.innerHTML='';return;}
  se.style.display='none';

  const winners=cashed.filter(p=>(p.cashoutAmount||0)>ti(p)).sort((a,b)=>((b.cashoutAmount||0)-ti(b))-((a.cashoutAmount||0)-ti(a)));
  const losers =cashed.filter(p=>(p.cashoutAmount||0)<ti(p)).sort((a,b)=>((a.cashoutAmount||0)-ti(a))-((b.cashoutAmount||0)-ti(b)));
  const evens  =cashed.filter(p=>(p.cashoutAmount||0)===ti(p));

  const makeRow=(p,label,color,actionWord)=>{
    const net=(p.cashoutAmount||0)-ti(p);
    const done=!!settleChecked[p.id];
    const absNet=Math.abs(net);
    return `<div class="settle-row" id="sr-${p.id}" style="${done?'opacity:.5':''}">
      <div style="flex:1">
        <div class="settle-name">${p.name}</div>
        <div style="font-size:11px;color:var(--i3);margin-top:2px">In: ${fmt(ti(p))} ¬∑ Out: ${fmt(p.cashoutAmount||0)}</div>
      </div>
      <div style="text-align:right;margin-right:10px">
        <div class="settle-amt" style="color:${color}">${net===0?'Even':absNet>0?fmt(absNet):''}</div>
        <div style="font-size:11px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:${color};opacity:.7">${actionWord}</div>
      </div>
      <div class="settle-check${done?' done':''}" id="sc-${p.id}" onclick="toggleSettle(${p.id})" title="${done?'‚úì Paid':'Mark paid'}"></div>
    </div>`;
  };

  let html='';
  if(winners.length){
    html+=`<div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--ag);text-transform:uppercase;margin-bottom:7px;padding:4px 0;border-bottom:1px solid rgba(57,255,20,.12)">üí∏ Pay Out ‚Äî they won</div>`;
    html+=winners.map(p=>makeRow(p,'Pay them','var(--ag)','you pay')).join('');
  }
  if(losers.length){
    html+=`<div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--neg);text-transform:uppercase;margin-bottom:7px;padding:4px 0;border-bottom:1px solid rgba(255,69,96,.12);margin-top:${winners.length?12:0}px">üí∞ Collect Venmo ‚Äî they lost</div>`;
    html+=losers.map(p=>makeRow(p,'They owe you','var(--neg)','collect')).join('');
  }
  if(evens.length){
    html+=evens.map(p=>makeRow(p,'Break even','var(--i3)','even')).join('');
  }

  // Session closed summary with archive option
  if(sessionClosed){
    const totalWon=winners.reduce((s,p)=>s+((p.cashoutAmount||0)-ti(p)),0);
    html+=`<div style="margin-top:14px;padding:11px;background:var(--ag3);border:1px solid rgba(57,255,20,.18);border-radius:var(--r6);text-align:center">
      <div style="font-size:11px;font-weight:700;color:var(--ag);margin-bottom:3px">Session Complete üèÅ</div>
      <div style="font-size:10px;color:var(--i3)">${cashed.length} players ¬∑ ${fmt(totalWon)} total winnings</div>
      <button class="btn btn-ag btn-sm btn-full mt8" onclick="doSaveEnd()">Archive & Clear Table</button>
    </div>`;
  }

  sl.innerHTML=html;
  // Re-apply done styles
  cashed.forEach(p=>{
    const el=$(`sc-${p.id}`);
    if(el&&settleChecked[p.id]) el.style.cssText='background:var(--ag);border-color:var(--ag);box-shadow:var(--glow-ag)';
  });
}

function toggleSettle(id){
  settleChecked[id]=!settleChecked[id];
  const el=$(`sc-${id}`);
  if(el){
    if(settleChecked[id]) el.style.cssText='background:var(--ag);border-color:var(--ag);box-shadow:var(--glow-ag)';
    else el.style.cssText='';
  }
  const p=G.players.find(q=>q.id===id);
  toast(settleChecked[id]?`‚úì ${p?.name} paid out`:`${p?.name} marked unpaid`);
}
function autoSettle(){
  G.players.filter(p=>p.status==='cashed').forEach(p=>{ settleChecked[p.id]=true; });
  renderPayout(); toast('All marked as paid out ‚úì');
}

function closeSession(){
  const active=G.players.filter(p=>p.status==='active');
  if(active.length){
    if(!confirm(`${active.length} player${active.length!==1?'s':''} still active. Close anyway?`))return;
  }
  sessionClosed=true; sessionClosedAt=new Date();
  addFeed('üèÅ','Session closed',`${G.players.filter(p=>p.status==='cashed').length} players settled`);
  refresh(); renderCashOut(); toast('Session closed ‚Äî all data viewable and editable');
}
function reopenSession(){
  sessionClosed=false; sessionClosedAt=null;
  renderCashOut(); toast('Session reopened');
}
function archiveAndClear(){
  // Check that money in = money out before archiving
  const all=G.players.filter(p=>p.status==='active'||p.status==='cashed'||p.status==='out');
  const totalIn=all.reduce((s,p)=>s+ti(p),0);
  const cashedOut=all.filter(p=>p.status==='cashed'||p.status==='out').reduce((s,p)=>s+(p.cashoutAmount||0),0);
  const activeStack=all.filter(p=>p.status==='active').reduce((s,p)=>s+p.currentStack,0);
  const diff=Math.abs((cashedOut+activeStack)-totalIn);
  const activeCt=G.players.filter(p=>p.status==='active').length;

  if(activeCt>0){
    if(!confirm(`${activeCt} player${activeCt!==1?'s':''} still active and haven't cashed out. Archive anyway?`))return;
  } else if(diff>0.02){
    const over=(cashedOut+activeStack)>totalIn;
    if(!confirm(`‚ö†Ô∏è Math doesn't balance ‚Äî ${fmt(diff)} ${over?'more cashed out than bought in':'unaccounted for'}.\n\nAre you sure you want to archive?`))return;
  }

  saveHistory();resetGame();
  goTab('dash',$('nav-dash'));
  toast('Session archived ‚Äî gg! üÉè');
}
function justClear(){
  if(!confirm('Clear table without saving to history?'))return;
  resetGame();
  goTab('dash',$('nav-dash'));
  toast('Table cleared');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHIP COUNTER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildDenomUI(){
  const grid=$('denom-grid');if(!grid)return;
  grid.innerHTML=DENOMS.map(d=>`
    <div class="denom-item">
      <div class="denom-dot" style="background:${d.color}"></div>
      <span class="denom-name">${d.name}</span>
      <span class="denom-val">$${d.value.toFixed(2)}</span>
      <input class="denom-inp" type="number" id="dv-${d.id}" value="${d.value}" min="0.01" step="0.01" onchange="updateDenom('${d.id}',this.value)">
    </div>`).join('');
  buildMCGrid();
}
function updateDenom(id,val){const d=DENOMS.find(d=>d.id===id);if(d){d.value=parseFloat(val)||d.value;}calcManual();}
function resetDenoms(){DENOMS=JSON.parse(JSON.stringify(DEFAULT_DENOMS));buildDenomUI();toast('Reset to default');}
function buildMCGrid(){
  const g=$('mc-grid');if(!g)return;
  g.innerHTML=DENOMS.map(d=>`
    <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--s1);border:1px solid var(--br);border-radius:var(--r6)">
      <div style="width:16px;height:16px;border-radius:50%;background:${d.color};flex-shrink:0"></div>
      <span style="font-size:10px;color:var(--i3);flex:1">${d.name} √ó$${d.value.toFixed(2)}</span>
      <input style="width:52px;background:var(--s2);border:1px solid var(--br);border-radius:var(--r4);padding:5px 7px;color:var(--cy);font-family:'DM Mono',monospace;font-size:13px;outline:none;text-align:center;caret-color:var(--cy)" type="number" id="mc-${d.id}" value="0" min="0" oninput="calcManual()">
    </div>`).join('');
}
function calcManual(){
  let t=0;DENOMS.forEach(d=>{const i=$(`mc-${d.id}`);if(i)t+=(parseFloat(i.value)||0)*d.value;});
  const mt=$('mc-total');if(mt)mt.textContent=fmt(t);
}
function handleFile(e){const f=e.target.files[0];if(f)processImg(f);}
function handleDrop(e){e.preventDefault();$('upload-zone').classList.remove('dov');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))processImg(f);}
function processImg(file){
  const r=new FileReader();
  r.onload=e=>{const img=$('chip-img');img.src=e.target.result;img.style.display='block';$('upload-zone').style.display='none';runAI(e.target.result);};
  r.readAsDataURL(file);
}
async function runAI(dataUrl){
  var loading = document.getElementById('chip-loading');
  var result  = document.getElementById('chip-result');
  var actions = document.getElementById('chip-actions');

  if (loading) loading.style.display = 'block';
  if (result)  result.style.display  = 'none';
  if (actions) actions.style.display = 'none';

  var parts = (dataUrl || '').split(',');
  var base64 = parts[1] || '';

  var chipValues = DENOMS
    .map(function(d){ return d.name.toUpperCase() + '=$' + d.value.toFixed(2); })
    .join(', ');

  fetch('/api/chip-counter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      imageBase64: base64,
      chipValues: chipValues
    })
  })
  .then(function(resp){
    var status = resp.status;
    return resp.text().then(function(text){
      return { status: status, text: text };
    });
  })
  .then(function(payload){
    if (loading) loading.style.display = 'none';

    var data;
    try {
      data = JSON.parse(payload.text);
    } catch (e) {
      var msg = 'HTTP ' + payload.status + ': ' + payload.text;
      if (typeof toast === 'function') toast('Scan failed: ' + msg, 8000);
      else alert('Scan failed: ' + msg);
      return;
    }

    if (payload.status !== 200) {
      var msg2 = data && data.error ? data.error : ('HTTP ' + payload.status);
      if (data && data.body) {
        msg2 += ' ‚Äî ' + String(data.body).slice(0, 200);
      }
      if (typeof toast === 'function') toast('Scan failed: ' + msg2, 8000);
      else alert('Scan failed: ' + msg2);
      return;
    }

    showChipResult(data);
  })
  .catch(function(err){
    if (loading) loading.style.display = 'none';
    if (typeof toast === 'function') toast('Scan failed: ' + err.message, 8000);
    else alert('Scan failed: ' + err.message);
  });
}


function showChipResult(r){
  $('chip-loading').style.display='none';chipVal=r;
  $('chip-total').textContent=fmt(r.total);
  const chx={red:'#ef4444',blue:'#3b82f6',black:'#9ca3af',green:'#22c55e'};
  const idMap={red:'r',blue:'b',black:'bl',green:'g'};
  $('chip-chips').innerHTML=r.counts?Object.entries(r.counts).filter(([,v])=>v>0).map(([col,cnt])=>{
    const d=DENOMS.find(d=>d.id===(idMap[col]||col));
    const clr=chx[col]||'#fff';
    return `<div class="rchip"><div class="rchip-dot" style="background:${clr}"></div><span class="rchip-l">${col} ¬∑ $${d?d.value.toFixed(2):'?'}</span><button class="rchip-adj" onclick="adjustChip('${col}',-1)">‚àí</button><span class="rchip-n" id="rchip-n-${col}" style="color:${clr}">${cnt}</span><button class="rchip-adj" onclick="adjustChip('${col}',1)">+</button></div>`;
  }).join(''):'';
  $('chip-desc').textContent=r.description||'';
  $('chip-result').style.display='block';$('chip-actions').style.display='block';
  populatePickers();toast(`Counted: ${fmt(r.total)}`);
}
function adjustChip(col,delta){
  if(!chipVal||!chipVal.counts)return;
  const next=Math.max(0,(chipVal.counts[col]||0)+delta);
  chipVal.counts[col]=next;
  const el=$('rchip-n-'+col);if(el)el.textContent=next;
  const idMap={red:'r',blue:'b',black:'bl',green:'g'};
  let t=0;
  Object.entries(chipVal.counts).forEach(([c,cnt])=>{const d=DENOMS.find(d=>d.id===(idMap[c]||c));if(d)t+=cnt*d.value;});
  chipVal.total=parseFloat(t.toFixed(2));
  $('chip-total').textContent=fmt(chipVal.total);
}
function chipApply(action){if(!chipVal){toast('Scan chips first');return;}applyToPlayer(action,chipVal.total,'scan');}
function mcApply(action){let t=0;DENOMS.forEach(d=>{const i=$(`mc-${d.id}`);if(i)t+=(parseFloat(i.value)||0)*d.value;});applyToPlayer(action,parseFloat(t.toFixed(2)),'manual');}
function applyToPlayer(action,val,src){
  if(!selPlayer){toast('Select a player first');return;}
  const p=G.players.find(p=>p.id===selPlayer);if(!p){toast('Not found');return;}
  if(action==='buyin'){
    p.buyin+=val;p.currentStack+=val;
    addFeed('‚ô†',`${p.name} buy-in (${src})`,`+${fmt(val)}`);
  }else if(action==='rebuy'){
    p.addOns.push({amount:val,type:'add-on',time:new Date()});
    p.addOnTotal+=val;p.currentStack+=val;
    addFeed('‚Ü∫',`${p.name} add-on (${src})`,`+${fmt(val)} ‚Üí ${fmt(p.currentStack)}`);
  }else if(action==='stack'){
    const old=p.currentStack;p.currentStack=val;
    addFeed('‚ü≥',`${p.name} stack updated (${src})`,`${fmt(old)} ‚Üí ${fmt(val)}`);
  }
  refresh();
  toast(`Applied ${fmt(val)} to ${p.name}`);
  // Always sync to cash out known stack display
  const ks=$('co-known-stack'),ub=$('co-use-stack-btn');
  if(ks){ks.textContent=fmt(p.currentStack);}
  if(ub&&p.currentStack>0){ub.style.display='inline-flex';}
  // If this player is selected in cash out AND their stack changed, pre-load into chip total
  if(coSelectedId===p.id&&(action==='stack'||action==='rebuy'||action==='buyin')){
    const ct=$('co-chip-total');if(ct)ct.textContent=fmt(p.currentStack);
    // Also reset chip inputs and pre-fill manual field as hint
    const manual=$('co-manual');
    if(manual&&!manual.value){
      // Don't auto-fill manual, just update the "use" button hint
    }
    recalcCO(p.currentStack);
  }
}
function populatePickers(){
  const act=G.players.filter(p=>p.status==='active');
  ['chip-picker','mc-picker'].forEach(pid=>{
    const pp=$(pid);if(!pp)return;
    if(!act.length){pp.innerHTML=`<div style="font-size:10px;color:var(--i4);padding:5px 0">No active players</div>`;return;}
    pp.innerHTML=act.map(p=>`
      <div class="pp-row${selPlayer===p.id?' sel':''}" id="ppr-${pid}-${p.id}" onclick="selectPlayer(${p.id})">
        <div class="pp-name">${p.name}</div><div class="pp-stack">${fmt(p.currentStack)}</div>
      </div>`).join('');
  });
}
function selectPlayer(id){
  selPlayer=id;
  document.querySelectorAll('.pp-row').forEach(r=>{r.classList.remove('sel');if(r.id.endsWith('-'+id))r.classList.add('sel');});
  toast(`${G.players.find(p=>p.id===id)?.name} selected`);
}
function resetChip(){
  $('chip-img').style.display='none';$('chip-img').src='';
  $('upload-zone').style.display='block';$('chip-result').style.display='none';
  $('chip-loading').style.display='none';$('chip-actions').style.display='none';
  $('chip-file').value='';chipVal=null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HANDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HAND RATING ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Returns score: pairs score by rank (AA=0, KK=1..22=12), non-pairs by high+low rank indices
function handScore(c1,c2,suited){
  const ORDER='AKQJT98765432'; // index 0=Ace (best), 12=2 (worst)
  const r1=ORDER.indexOf(c1),r2=ORDER.indexOf(c2);
  if(r1<0||r2<0) return 999;
  const hi=Math.min(r1,r2),lo=Math.max(r1,r2);
  const isPair=r1===r2;
  // pairs: 0..168 stepping by ~13; non-pairs: add gap+suited bonus
  if(isPair) return hi*14;
  const gap=lo-hi;
  const base=hi*14+gap*2;
  return suited?base:base+1;
}

// Tiers ‚Äî score ranges tuned so 72o (gap=5, hi=5,lo=12 ‚Üí 5*14+10+1=81) = Home Game Legend
const HAND_TIERS=[
  {max:2,   tier:'GTO',              color:'#00d4ff', bg:'rgba(0,212,255,.13)', emoji:'üß†', label:'Solver approved. You literally cannot be wrong.'},
  {max:8,   tier:'Premium',          color:'#39ff14', bg:'rgba(57,255,20,.1)',  emoji:'üëë', label:'Open-raise anywhere. Your GTO coach is smiling.'},
  {max:18,  tier:'Strong',           color:'#a855f7', bg:'rgba(168,85,247,.1)', emoji:'üí™', label:'Solid hand. Most regs are happy to see this.'},
  {max:32,  tier:'Playable',         color:'#e8b84b', bg:'rgba(232,184,75,.1)', emoji:'üÉè', label:'Fine preflop. Needs a decent flop and some position.'},
  {max:50,  tier:'Speculative',      color:'#fb923c', bg:'rgba(251,146,60,.1)', emoji:'üé≤', label:'High variance. Works best multiway and in position.'},
  {max:70,  tier:'Questionable',     color:'#ff6b6b', bg:'rgba(255,107,107,.1)', emoji:'ü§®', label:'GTO has entered the chat and is shaking its head.'},
  {max:85,  tier:'Home Game Special',color:'#ff006e', bg:'rgba(255,0,110,.12)',  emoji:'üé™', label:'A bold choice. This is why everyone loves home games.'},
  {max:999, tier:'Home Game Legend', color:'#ff006e', bg:'rgba(255,0,110,.18)',  emoji:'ü§°', label:'72o energy. All-time. Tattoo worthy. No further comment.'},
];

function getHandTier(c1,c2,suited){
  const score=handScore(c1,c2,suited);
  return HAND_TIERS.find(t=>score<=t.max)||HAND_TIERS[HAND_TIERS.length-1];
}

function rateHand(){
  const c1=$('lh-c1')?.value||'A';
  const c2=$('lh-c2')?.value||'A';
  const suited=document.querySelector('input[name="lh-suit"]:checked')?.value==='s';
  const isPair=c1===c2;
  const tier=getHandTier(c1,c2,suited);

  // Card preview with suits
  const suits=isPair?['‚ô†','‚ô•']:suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
  const prev=$('lh-card-preview');
  if(prev) prev.textContent=`${c1}${suits[0]} ${c2}${suits[1]}`;

  // Tier badge
  const badge=$('lh-tier-badge');
  if(badge){
    badge.textContent=`${tier.emoji} ${tier.tier}`;
    badge.style.color=tier.color;
    badge.style.background=tier.bg;
    badge.style.border=`1px solid ${tier.color}44`;
  }

  // Rating label
  const lbl=$('lh-rating-label');
  if(lbl) lbl.textContent=tier.label;

  // Rating box background tint
  const box=$('lh-rating-box');
  if(box) box.style.background=tier.bg;
}

function openLogHand(preSelectId){
  const act=G.players.filter(p=>p.status==='active');
  if(!act.length){toast('Add players first');return;}
  const sel=$('lh-winner');
  sel.innerHTML=act.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(preSelectId) Array.from(sel.options).forEach(o=>o.selected=parseInt(o.value)===preSelectId);
  $('lh-pot').value='';$('lh-note').value='';
  // Reset to A/A for clean start
  const c1=$('lh-c1'),c2=$('lh-c2');
  if(c1) c1.value='A'; if(c2) c2.value='A';
  const offsuit=document.querySelector('input[name="lh-suit"][value="o"]');
  if(offsuit) offsuit.checked=true;
  rateHand();
  om('m-hand');
}

// Alias for old calls from player detail panel
function openDumbWin(playerId){ openLogHand(playerId); }
function openDumbHand(){ openLogHand(); }

function doLogHand(){
  const wid=parseInt($('lh-winner').value);
  const c1=$('lh-c1').value, c2=$('lh-c2').value;
  const suited=document.querySelector('input[name="lh-suit"]:checked')?.value==='s';
  const isPair=c1===c2;
  const pot=parseFloat($('lh-pot').value)||0;
  const note=$('lh-note').value.trim();
  const w=G.players.find(p=>p.id===wid);
  if(!w){toast('Pick a winner');return;}

  const tier=getHandTier(c1,c2,suited);
  const suits=isPair?['‚ô†','‚ô•']:suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
  const handStr=`${c1}${suits[0]}${c2}${suits[1]}`;
  const isDumb=['Home Game Special','Home Game Legend','Questionable'].includes(tier.tier);

  const entry={
    winner:w.name, pot, card1:c1, card2:c2, suited, note,
    tier:tier.tier, tierEmoji:tier.emoji, handStr, time:new Date()
  };
  G.hands.push(entry);
  if(isDumb) G.dumbHands.push(entry);

  addFeed(tier.emoji,`${w.name} wins ‚Äî ${handStr}`,`${tier.tier}${pot>0?' ¬∑ '+fmt(pot):''}`);
  cm('m-hand'); renderHands(); updateHeader();
  toast(`${tier.emoji} ${w.name} wins with ${handStr} ‚Äî ${tier.tier}`);
}

function renderHands(){
  const hl=$('hands-list'),he=$('hands-empty');
  if(!hl||!he)return;
  if(!G.hands.length){
    he.style.display='block';hl.innerHTML='';
    $('sh-count').textContent='0';$('sh-big').textContent='‚Äî';$('sh-win').textContent='‚Äî';return;
  }
  he.style.display='none';
  const wc={};G.hands.forEach(h=>{wc[h.winner]=(wc[h.winner]||0)+1;});
  const tw=Object.keys(wc).sort((a,b)=>wc[b]-wc[a])[0]||'‚Äî';
  const big=Math.max(...G.hands.map(h=>h.pot));
  $('sh-count').textContent=G.hands.length;
  $('sh-big').textContent=big>0?fmt(big):'‚Äî';
  $('sh-win').textContent=tw.length>9?tw.slice(0,9)+'‚Ä¶':tw;

  hl.innerHTML=[...G.hands].reverse().map(h=>{
    const tier=h.tier?HAND_TIERS.find(t=>t.tier===h.tier):null;
    const color=tier?.color||'var(--i2)';
    const emoji=h.tierEmoji||tier?.emoji||'üÉè';
    const suits=h.card1===h.card2?['‚ô†','‚ô•']:h.suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
    const handStr=h.card1&&h.card2?`${h.card1}${suits[0]}${h.card2}${suits[1]}`:'';
    return `<div style="background:var(--s2);border:1px solid var(--br);border-radius:var(--r8);padding:11px 13px;margin-bottom:7px;display:flex;gap:10px;align-items:flex-start">
      <div style="font-size:22px;flex-shrink:0;line-height:1;margin-top:1px">${emoji}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:baseline;gap:7px;flex-wrap:wrap;margin-bottom:2px">
          <span style="font-size:13px;font-weight:700;color:var(--i0)">${h.winner}</span>
          ${handStr?`<span style="font-size:13px;font-weight:700;color:${color};font-family:'DM Mono',monospace">${handStr}</span>`:''}
        </div>
        ${h.tier?`<div style="font-size:9px;font-weight:700;letter-spacing:.1em;color:${color};text-transform:uppercase;margin-bottom:2px">${h.tier}</div>`:''}
        ${h.note?`<div style="font-size:10px;color:var(--i3);font-style:italic">${h.note}</div>`:''}
        <div style="font-size:11px;color:var(--i4);margin-top:3px;font-family:'DM Mono',monospace">${clock(h.time)}</div>
      </div>
      ${h.pot>0?`<div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--ag);flex-shrink:0">${fmt(h.pot)}</div>`:''}
    </div>`;
  }).join('');
}

function renderHandCards(c1,c2,suited){
  const suits=c1===c2?['‚ô†','‚ô•']:suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
  return `${c1}${suits[0]}${c2}${suits[1]}`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE ROSTER QUICK-ADD (Dashboard)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderLiveRoster(){
  const wrap=$('d-live-roster');
  const chips=$('d-live-roster-chips');
  if(!wrap||!chips)return;
  const available=ROSTER_DB.filter(r=>!G.players.some(p=>p.name===r.name&&p.status==='active'));
  if(!available.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  chips.innerHTML=available.map(r=>{
    const nameEsc=r.name.replace(/'/g,"\\'");
    return `<button class="btn btn-cy btn-sm" style="padding:5px 12px;font-size:11px;border-radius:20px" onclick="liveQuickAdd('${nameEsc}')">+ ${r.name}</button>`;
  }).join('');
}

function liveQuickAdd(name){
  const freeSeat=Array.from({length:G.settings.seats},(_,i)=>i+1)
    .find(s=>!G.players.some(p=>p.seat===s&&p.status==='active'));
  if(!freeSeat){toast('No open seats');return;}
  G.players.push({
    id:G.nextId++,name,
    buyin:G.settings.defaultBuyin,addOns:[],addOnTotal:0,
    seat:freeSeat,status:'active',
    currentStack:G.settings.defaultBuyin,
    cashoutAmount:null,joinedAt:new Date()
  });
  upsertRoster(name);
  addFeed('‚ô†',`${name} joined`,`Seat ${freeSeat} ¬∑ ${fmt(G.settings.defaultBuyin)}`);
  refresh(); renderLiveRoster();
  toast(`${name} ‚Üí Seat ${freeSeat}`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WIZARD ‚Äî Should I Play This?
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let oracleLog=JSON.parse(localStorage.getItem('oracleLog')||'[]');

function oracleRate(){
  // Stub kept for old dashboard toggle (now removed) - does nothing
}

function oraclePreview(){
  // Called from Oracle tab selects ‚Äî update live preview box
  const c1=$('ora-c1')?.value||'A';
  const c2=$('ora-c2')?.value||'A';
  const suited=document.querySelector('input[name="ora-suit"]:checked')?.value==='s';
  const isPair=c1===c2;
  const tier=getHandTier(c1,c2,suited);
  const suits=isPair?['‚ô†','‚ô•']:suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
  const handStr=`${c1}${suits[0]} ${c2}${suits[1]}`;

  const prev=$('ora-preview-hand');
  const badge=$('ora-preview-badge');
  const lbl=$('ora-preview-label');
  const box=$('ora-preview-box');
  if(prev) prev.textContent=handStr;
  if(prev) prev.style.color=tier.color;
  if(badge){
    badge.textContent=`${tier.emoji} ${tier.tier}`;
    badge.style.color=tier.color;
    badge.style.background=tier.bg;
    badge.style.border=`1px solid ${tier.color}55`;
  }
  if(lbl) lbl.textContent=tier.label;
  if(box){
    box.style.background=tier.bg;
    box.style.borderColor=`${tier.color}44`;
  }
  // Hide previous verdict when cards change
  const res=$('ora-result');
  if(res) res.style.display='none';
}

function renderOraclePage(){
  // Tier guide
  const guide=$('ora-tier-guide');
  if(guide){
    guide.innerHTML=HAND_TIERS.map(t=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--r8);background:${t.bg};border:1px solid ${t.color}33">
        <span style="font-size:18px;flex-shrink:0">${t.emoji}</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;font-weight:700;color:${t.color};letter-spacing:.06em">${t.tier}</div>
          <div style="font-size:10px;color:var(--i3);margin-top:1px">${t.label}</div>
        </div>
      </div>`).join('');
  }
  // Trigger initial preview
  oraclePreview();
  // History
  renderOracleHistory();
}

function renderOracleHistory(){
  const card=$('ora-history-card');
  const list=$('ora-history-list');
  if(!card||!list)return;
  if(!oracleLog.length){card.style.display='none';return;}
  card.style.display='block';
  list.innerHTML=[...oracleLog].reverse().slice(0,10).map(e=>{
    const col=e.play?'var(--ag)':'var(--neg)';
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--s2);border-radius:var(--r8);margin-bottom:5px">
      <span style="font-size:18px">${e.emoji}</span>
      <div style="flex:1">
        <div style="font-size:12px;font-weight:700;color:var(--i0)">${e.hand}</div>
        <div style="font-size:10px;color:var(--i3);margin-top:1px">${e.verdict}</div>
      </div>
      <div style="font-size:11px;color:var(--i4)">${e.time}</div>
    </div>`;
  }).join('');
}

function clearOracleHistory(){
  oracleLog=[];localStorage.removeItem('oracleLog');renderOracleHistory();
}

async function askOracle(){
  const c1=$('ora-c1')?.value||'A';
  const c2=$('ora-c2')?.value||'A';
  const suited=document.querySelector('input[name="ora-suit"]:checked')?.value==='s';
  const isPair=c1===c2;
  const tier=getHandTier(c1,c2,suited);
  const suits=isPair?['‚ô†','‚ô•']:suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
  const handStr=`${c1}${suits[0]} ${c2}${suits[1]}`;

  // Context clues
  const hour=new Date().getHours();
  const isLate=hour>=22||hour<4;
  const isEarly=hour>=6&&hour<=9;
  const players=G.players.filter(p=>p.status==='active');
  const nPlayers=players.length;
  const sessionMins=sessionStartTime?Math.floor((Date.now()-sessionStartTime.getTime())/60000):0;
  const isLongSession=sessionMins>120;
  const isNewSession=sessionMins<20;
  const losers=players.filter(p=>p.currentStack<ti(p));
  const winners=players.filter(p=>p.currentStack>ti(p));
  const scoreVal=handScore(c1,c2,suited);
  const r=Math.random();

  // Special hand flags
  const isImpossibleSuitedPair=isPair&&suited; // e.g. "suited aces" ‚Äî physically impossible
  const isJack=(c1==='J'||c2==='J')&&!isPair;
  const jackKicker=isJack?(c1==='J'?c2:c1):null;
  const JACK_SAY={'2':'Jay deuceeee nice','3':'Jay threeee nice','4':'oh is the Jack 4 game on???',
    '5':'Jay fayyyy nice','6':'Jay siiix nice','7':'Jay sayyy nice',
    '8':'Jay ayyyyte nice','9':'Jay niiine nice','T':'Jay tennnnn nice'};

  const result=$('ora-result');
  const verdictEl=$('ora-verdict');
  const reasonEl=$('ora-reason');
  if(!result)return;

  // Show loading state
  result.style.cssText='display:block;border-radius:var(--r10);padding:14px;text-align:center;margin-top:14px;background:rgba(168,85,247,.07);border:1px solid rgba(168,85,247,.3);transition:all .2s';
  verdictEl.textContent='üßô Consulting...';
  verdictEl.style.color='#a855f7';
  reasonEl.textContent='The Wizard is thinking...';

  let play, verdict, reason;

  try {
    const ctx=[
      `${nPlayers} active player${nPlayers!==1?'s':''}`,
      isLate?'late night session':isEarly?'early morning':sessionMins>0?`${sessionMins} min in`:'new session',
      winners.length?`up: ${winners.map(p=>p.name).join(', ')}`:null,
      losers.length?`stuck: ${losers.map(p=>p.name).join(', ')}`:null,
    ].filter(Boolean).join('; ');

    const resp=await fetch('/api/wizard',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({hand:handStr.trim(),context:ctx})
    });
    if(!resp.ok) throw new Error('API '+resp.status);
    const data=await resp.json();
    if(data.error) throw new Error(data.error);
    play=!!data.play; verdict=data.verdict; reason=data.reason;
  } catch(e){
    // Fallback: fully random ‚Äî hand strength is irrelevant, chaos is the point
    const rando=Math.floor(r*players.length)||0;

    // ‚îÄ‚îÄ Special overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(isImpossibleSuitedPair){
      // Physically impossible hand (e.g. suited aces)
      play=true;
      verdict='ü§Ø How did you even do that';
      reason=`Not sure how you got suited ${c1}s but no shot you're getting set up here. Go all in.`;
    } else if(isJack&&jackKicker&&JACK_SAY[jackKicker]&&r<0.75){
      // Jack + kicker 2-T: phonetic Jay phrase (75% of the time, else general pool)
      play=true;
      verdict=`üÉè ${JACK_SAY[jackKicker]}`;
      reason=suited?'Well it\'s suited isn\'t it???':'Classic. Ship it.';
    } else {
      // General pool ‚Äî suited hands get a couple extra entries
      const suitedBonus=suited&&!isPair?[
        {play:true, verdict:'üíß Well it\'s suited isn\'t it???', reason:'I mean... it\'s suited. What else do you need bro.'},
        {play:true, verdict:'‚ô† Suited. That\'s it.',            reason:'Well it\'s suited isn\'t it??? The conversation is over.'},
      ]:[];
      const pool=[
        // classics
        {play:true,  verdict:'‚úÖ Yeah that\'s real',        reason: losers.length?`${losers[0].name} is steaming. Take their chips.`:'Table\'s calling wide. Get your money in.'},
        {play:true,  verdict:'‚úÖ Play it',                  reason: isLate?'Late night = loose table. They\'re calling with anything.':'This hand prints money. Don\'t get cute.'},
        {play:true,  verdict:'‚úÖ No brainer',               reason: isNewSession?'Early in the session ‚Äî set the tone. Punish them.':isLongSession?'You\'ve been patient. Now make them pay.':'Position and pot odds say yes. Pop it.'},
        {play:true,  verdict:'üî• Ship it',                  reason:`${handStr.trim()} is a cooler disguise. They'll never put you on this.`},
        {play:true,  verdict:'üÉè See a flop',               reason:'If you don\'t play this then maybe I can interest you in some tickets to the puss convention.'},
        {play:true,  verdict:'‚úÖ Yeah that\'s real',        reason:'If you fold this then I understand why dad is still getting milk.'},
        {play:true,  verdict:'üëÄ Could be something',       reason: winners.length?`${winners[0].name} is up ‚Äî they'll call wide. Use that.`:'Table\'s been passive. Steal it preflop.'},
        {play:true,  verdict:'üî• Ship it',                  reason:'Yeah play this and then min raise, for strength.'},
        {play:true,  verdict:'üÉè Worth a look',             reason: suited?'Well it\'s suited isn\'t it??? Free money.':nPlayers>=5?'Multiway pots = implied odds. Just need one miracle card.':'First-in juice. They don\'t know what you\'re capable of.'},
        {play:true,  verdict:'ü§∑ Just play it',             reason: isLongSession?'You\'ve been folding for 2 hours. Nobody expects this.':'Look, do you want to WIN or do you want to be COMFORTABLE?'},
        {play:true,  verdict:'‚úÖ Raise 2, for strength',    reason:'Play this bad hand and raise 2, for strength. It\'s called balance bro.'},
        {play:true,  verdict:'üé∞ Re-entry special',         reason:'Play this one if you\'re ready for another re-entry.'},
        {play:true,  verdict:'üíª Bro just Google it',       reason:'You had to ask bro? They have free poker online if this is too spicy for you.'},
        {play:true,  verdict:'üíØ No way you lose',          reason:'No way you lose with this one bro. Trust.'},
        {play:true,  verdict:'üêª Does the pope poop in the woods?', reason:'Idk man, does the pope poop in the woods? The answer is yes. Play it.'},
        {play:true,  verdict:'ü§ù Easy game',                reason: nPlayers>4?`${nPlayers} players in and you\'re asking me? Ship it.`:'Heads up or not ‚Äî this prints.'},
        {play:true,  verdict:'üß† Solver approved',          reason:'The solver said raise. I think. I didn\'t actually check but it seems right.'},
        {play:true,  verdict:'üìà Equity is there',          reason:'You have at minimum 2 outs. That\'s basically a coin flip bro.'},
        {play:true,  verdict:'üéØ This is the one',          reason: isLate?'It\'s late and you\'re asking the Wizard. Just play and see what happens.':'The Wizard sees great things. Or nothing. One of those.'},
        {play:true,  verdict:'ü§å Chef\'s kiss',             reason:'Beautiful hand. Or is it? Doesn\'t matter. Get in there.'},
        {play:true,  verdict:'üëë Premium feels',            reason:'This feels premium. Feelings are GTO. That\'s science.'},
        {play:true,  verdict:'üèÉ Run it',                   reason: losers.length?`${losers[0].name} already rebought once. Keep the pressure on.`:'They can\'t put you on this. Go.'},
        {play:true,  verdict:'‚ö° Get in there',             reason:'Sometimes you just gotta jump in the water. This is one of those times.'},
        {play:true,  verdict:'üé≤ Variance is your friend',  reason:'High variance hand, high variance advice. We\'re aligned bro.'},
        {play:true,  verdict:'üîÆ The Wizard says yes',      reason:'Look man, you consulted the Wizard. The Wizard said play. That\'s on you now.'},
        {play:true,  verdict:'üß¶ Dobby is free',            reason:'Master has given dobby a shizzy hand, dobby is freeeee. Ship it.'},
        {play:true,  verdict:'üí∏ No wechat needed',         reason:'Don\'t need wechat to get paid here bro. Ship it.'},
        {play:true,  verdict:'ü§† Cowboy up',                reason: suited?'Suited connectors in a home game? That\'s basically a straight flush already.':'You\'re playing a home game not the WSOP. Relax and ship it.'},
        {play:true,  verdict:'üí™ Trust the process',        reason:'The process is: pick cards, ask Wizard, play hand, lose money. Step 3.'},
        {play:true,  verdict:'üåü Star power',               reason: winners.length?`${winners[0].name} is running hot. Ride that table energy.`:'Good vibes only at this table tonight.'},
        {play:true,  verdict:'üÉè Let\'s find out',          reason:'The only way to know if you win is to play bro. That\'s a Wizard exclusive insight.'},
        {play:true,  verdict:'üé™ Home game mode',           reason:'This is a home game. The hand ranking is: whatever feels good > GTO.'},
        // folds
        {play:false, verdict:'üôÖ Fold it',                  reason:'The table energy is off right now.'},
        {play:false, verdict:'üôÖ Fold it',                  reason:'You\'ve been running hot ‚Äî protect it.'},
        {play:false, verdict:'üôÖ Fold it',                  reason:'I\'m getting a bad feeling about this one.'},
        {play:false, verdict:'üôÖ Fold it',                  reason: nPlayers>3&&players[rando]?`${players[rando].name} has been suspiciously quiet.`:'Someone\'s got a monster.'},
        {play:false, verdict:'üôÖ Fold it',                  reason: isLate?'It\'s late. Everyone\'s tilted. Including you.':'Trust your gut. Not the cards.'},
        {play:false, verdict:'‚è∏ Sit this one out',          reason: isEarly?'Session is young. Wait for better spots.':nPlayers>=6?'Too many players in ‚Äî someone hit this board hard.':'Save it for a better spot. This isn\'t it.'},
        {play:false, verdict:'üíÄ Please fold',              reason:`${handStr.trim()} is ${tier.tier.toLowerCase()} energy. Even the Wizard has standards. Barely.`},
        {play:false, verdict:'ü´° Respect the range',        reason: isLongSession?'Two hours in and you\'re thinking about playing THIS? Discipline.':'The GTO overlords are watching. You don\'t want this energy.'},
        {play:false, verdict:'üò¨ Walk away',                reason:'The Wizard is seeing some stuff right now and none of it is good.'},
        {play:false, verdict:'üßò Patience bro',             reason:'A wise man once said wait for better spots. That man went broke at the river. Still ‚Äî fold this.'},
        {play:false, verdict:'üí∏ Save your chips',          reason: isLate?'You\'ve been in too many hands tonight. This one\'s a trap.':'Re-entry is always an option. Fold responsibly.'},
        {play:false, verdict:'üìâ Nope',                     reason: losers.length?`Even ${losers[0].name} wouldn\'t play this and they\'re steaming.`:'The Wizard consulted the data. The data said no. The Wizard agrees.'},
        {play:false, verdict:'üö´ Hard no',                  reason:'You had to ask bro? The fact that you\'re asking tells you everything.'},
        {play:false, verdict:'üï≥Ô∏è Fold into the void',       reason:'This hand has a special destiny. That destiny is the muck.'},
        {play:false, verdict:'üôà Don\'t look at me',        reason:'You asked the Wizard for this. The Wizard says absolutely not and is embarrassed for you.'},
        {play:false, verdict:'‚ö∞Ô∏è R.I.P.',                   reason: nPlayers>4?'There\'s too many people in this pot. Somebody has it.':'Even in a dead pot this is a fold. Historic.'},
        {play:false, verdict:'ü§¶ Bro',                      reason:`${handStr.trim()} and you\'re asking if you should play? We need to have a different conversation.`},
        ...suitedBonus,
      ];
      const pick=pool[Math.floor(r*pool.length)];
      play=pick.play; verdict=pick.verdict; reason=pick.reason;
    }
  }

  // Save to oracle log
  oracleLog.push({hand:handStr.trim(),verdict,play,emoji:tier.emoji,time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})});
  if(oracleLog.length>50) oracleLog=oracleLog.slice(-50);
  localStorage.setItem('oracleLog',JSON.stringify(oracleLog));scheduleCloudSave();

  // Render verdict
  const color=play?'var(--ag)':'var(--neg)';
  const bg=play?'rgba(57,255,20,.07)':'rgba(255,69,96,.07)';
  const border=play?'rgba(57,255,20,.2)':'rgba(255,69,96,.2)';
  result.style.background=bg;
  result.style.border=`1px solid ${border}`;
  verdictEl.textContent=verdict;
  verdictEl.style.color=color;
  reasonEl.textContent=reason;

  result.style.transform='scale(.97)';
  setTimeout(()=>result.style.transform='scale(1)',120);
  renderOracleHistory();
}

function clearHistory(){
  if(!confirm('Clear all session history? This cannot be undone.'))return;
  localStorage.removeItem('moonsHistory');
  renderSessions();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INVITE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getInviteURL(id){
  const base=window.location.href.split('?')[0].split('#')[0];
  return `${base}?invite=${id}`;
}

function openSettings(){
  $('set-host').value=G.settings.hostName||'blake';
  $('set-sb').value=G.settings.sb;$('set-bb').value=G.settings.bb;
  $('set-bi').value=G.settings.defaultBuyin;$('set-seats').value=G.settings.seats;$('set-game').value=G.settings.game;
  om('m-settings');
}
function doSaveSettings(){
  G.settings.hostName=($('set-host').value||'blake').trim().toLowerCase();
  G.settings.sb=parseFloat($('set-sb').value)||0.10;G.settings.bb=parseFloat($('set-bb').value)||0.10;
  G.settings.defaultBuyin=parseFloat($('set-bi').value)||10;
  G.settings.seats=parseInt($('set-seats').value)||10;G.settings.game=$('set-game').value;
  cm('m-settings');refresh();toast('Settings saved');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   END NIGHT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openEndNight(){
  // Save to history, mark session closed, go to cashout tab
  saveHistory();
  sessionClosed=true; sessionClosedAt=new Date();
  stopTimer();
  addFeed('üèÅ','Session ended','Review & settle on the Cash Out tab');
  goTab('cashout',$('nav-cashout'));
  toast('Session ended ‚Äî settle up on this page üèÅ',3500);
}
function doSaveEnd(){saveHistory();cm('m-end');resetGame();toast('Night saved ‚Äî gg!');}
function doDiscardEnd(){cm('m-end');resetGame();toast('Table cleared');}
function resetGame(){
  G.players=[];G.hands=[];G.dumbHands=[];G.feed=[];G.nextId=1;G.start=new Date();
  selPlayerId=null;selPlayer=null;coSelectedId=null;settleChecked={};
  sessionClosed=false;sessionClosedAt=null;
  stopTimer();sessionActive=false;sessionStartTime=null;
  const pre=$('d-pre-session'),act=$('d-active-session');
  if(pre)pre.style.display='block';if(act)act.style.display='none';
  const tmr=$('d-timer');if(tmr)tmr.textContent='0:00';
  updateNavState();
  refresh();
}
function saveHistory(){
  const dateStr=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  hist.unshift({
    id:Date.now(),
    date:dateStr,
    time:clock(G.start),
    players:G.players.map(p=>({name:p.name,buyin:ti(p),cashout:p.cashoutAmount,status:p.status})),
    handsCount:G.hands.length,
    totalPot:G.players.reduce((s,p)=>s+ti(p),0),
    biggestPot:G.hands.length?Math.max(...G.hands.map(h=>h.pot)):0
  });
  localStorage.setItem('moonsHistory',JSON.stringify(hist.slice(0,50)));
  scheduleCloudSave();
  // Stamp lastSeen on each player in roster
  G.players.forEach(p=>upsertRoster(p.name,{lastSeen:dateStr}));
}
function saveHistory(){
  const dateStr=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  const elapsed=sessionStartTime?Math.floor((Date.now()-sessionStartTime.getTime())/1000):0;
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  hist.unshift({
    id:Date.now(),
    date:dateStr,
    time:clock(G.start),
    durationSecs:elapsed,
    players:G.players.map(p=>({name:p.name,buyin:ti(p),cashout:p.cashoutAmount,status:p.status})),
    handsCount:G.hands.length,
    dumbHands:(G.dumbHands||[]),
    totalPot:G.players.reduce((s,p)=>s+ti(p),0),
    biggestPot:G.hands.length?Math.max(...G.hands.map(h=>h.pot)):0
  });
  localStorage.setItem('moonsHistory',JSON.stringify(hist.slice(0,50)));
  scheduleCloudSave();
  G.players.forEach(p=>upsertRoster(p.name,{lastSeen:dateStr}));
}

let selectedSession = null;

function fmtDur(secs){
  const h=Math.floor(secs/3600),m=Math.floor((secs%3600)/60);
  return h>0?`${h}h ${m}m`:`${m}m`;
}

function renderSessions(){
  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  const he=$('hist-empty'),hl=$('hist-list');
  const ch=$('clr-hist');
  if(ch)ch.style.display=hist.length?'inline-flex':'none';
  if(!he||!hl)return;

  he.style.display=hist.length?'none':'block';
  if(!hist.length){
    ['hs-sess','hs-hands','hs-dumb','hs-top'].forEach(id=>{const e=$(id);if(e)e.textContent='0';});
    const e=$('hs-top');if(e)e.textContent='‚Äî';
    return;
  }

  // All-time stats
  const es=$('hs-sess');if(es)es.textContent=hist.length;
  const eh=$('hs-hands');if(eh)eh.textContent=hist.reduce((a,s)=>a+s.handsCount,0);
  const totalDumb=hist.reduce((a,s)=>a+(s.dumbHands||[]).length,0);
  const ed=$('hs-dumb');if(ed)ed.textContent=totalDumb;
  const pc={};hist.forEach(s=>s.players.forEach(p=>{pc[p.name]=(pc[p.name]||0)+1;}));
  const top=Object.keys(pc).sort((a,b)=>pc[b]-pc[a])[0]||'‚Äî';
  const et=$('hs-top');if(et)et.textContent=top.length>8?top.slice(0,8)+'‚Ä¶':top;

  hl.innerHTML=hist.map((s,idx)=>{
    const isSel=selectedSession===s.id;
    const winners=s.players.filter(p=>p.cashout!=null&&p.cashout>p.buyin).sort((a,b)=>(b.cashout-b.buyin)-(a.cashout-a.buyin));
    const topW=winners[0];
    const dur=s.durationSecs?fmtDur(s.durationSecs):'';
    const dumbCount=(s.dumbHands||[]).length;
    return `<div style="background:${isSel?'var(--cy3)':'var(--s2)'};border:1px solid ${isSel?'var(--cy)':'var(--br)'};border-radius:var(--r8);margin-bottom:6px;padding:11px 13px;cursor:pointer;transition:all .12s" onclick="selectSession(${s.id})">
      <div style="font-size:12px;font-weight:700;color:${isSel?'var(--cy)':'var(--i0)'}">${s.date}</div>
      <div style="font-size:11px;color:var(--i3);margin-top:3px">${s.players.length} players ¬∑ ${fmt(s.totalPot)}${dur?' ¬∑ '+dur:''}${dumbCount?` ¬∑ ü§° ${dumbCount}`:''}</div>
      ${topW?`<div style="font-size:9px;margin-top:4px;color:var(--ag)">üèÜ ${topW.name} +${fmt(topW.cashout-topW.buyin)}</div>`:''}
    </div>`;
  }).join('');

  // Auto-select first session if none selected
  if(!selectedSession && hist.length) selectSession(hist[0].id, false);
}

function selectSession(id, render=true){
  selectedSession = id;
  if(render) renderSessions();

  const hist=JSON.parse(localStorage.getItem('moonsHistory')||'[]');
  const s=hist.find(h=>h.id===id);
  if(!s) return;

  const sd=$('sess-detail'),sde=$('sess-detail-empty');
  if(!sd||!sde) return;
  sde.style.display='none'; sd.style.display='block';

  const dur=s.durationSecs?fmtDur(s.durationSecs):'‚Äî';
  const dumbHands=s.dumbHands||[];
  const sorted=[...s.players].sort((a,b)=>{
    const na=a.cashout!=null?a.cashout-a.buyin:-999;
    const nb=b.cashout!=null?b.cashout-b.buyin:-999;
    return nb-na;
  });

  // All-time dumb hands for each player (across all sessions)
  const allDumb=hist.flatMap(h=>(h.dumbHands||[]).map(d=>({...d,date:h.date})));

  sd.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div style="font-family:'Instrument Serif',serif;font-size:20px;color:var(--i0);margin-bottom:2px">${s.date}</div>
      <div style="font-size:10px;color:var(--i3);margin-bottom:14px">${s.time} ¬∑ ${s.players.length} players ¬∑ ${dur}</div>

      <div class="g4 mb12" style="gap:8px">
        <div class="stile" style="background:var(--s2)"><div class="stile-v cy">${fmt(s.totalPot)}</div><div class="stile-l">Total In</div></div>
        <div class="stile" style="background:var(--s2)"><div class="stile-v ag">${s.handsCount}</div><div class="stile-l">Hands</div></div>
        <div class="stile" style="background:var(--s2)"><div class="stile-v" style="color:var(--neg)">${dumbHands.length}</div><div class="stile-l">ü§° Dumb Wins</div></div>
        <div class="stile" style="background:var(--s2)"><div class="stile-v au">${s.biggestPot>0?fmt(s.biggestPot):'‚Äî'}</div><div class="stile-l">Big Pot</div></div>
      </div>

      <!-- Player results -->
      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:8px">Results</div>
      <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:14px">
        ${sorted.map((p,i)=>{
          const net=p.cashout!=null?p.cashout-p.buyin:null;
          const col=net==null?'var(--i3)':net>0?'var(--ag)':net<0?'var(--neg)':'var(--i2)';
          const medal=i===0&&net>0?'üèÜ ':i===sorted.length-1&&net<0?'üíÄ ':'';
          const playerDumb=dumbHands.filter(d=>d.winner===p.name);
          return `<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--s2);border-radius:var(--r8);border:1px solid ${net>0?'rgba(57,255,20,.15)':net<0?'rgba(255,69,96,.1)':'var(--br)'}">
            <div style="width:28px;height:28px;border-radius:50%;background:${net>0?'var(--ag3)':net<0?'rgba(255,69,96,.1)':'var(--s3)'};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${net>0?'var(--ag)':net<0?'var(--neg)':'var(--i2)'};flex-shrink:0">${p.name.charAt(0)}</div>
            <div style="flex:1">
              <div style="font-size:12px;font-weight:600;color:var(--i0)">${medal}${p.name}</div>
              ${playerDumb.length?`<div style="font-size:9px;color:var(--neg);margin-top:1px">ü§° ${playerDumb.map(d=>d.card1+d.card2+(d.suited?'s':'o')).join(', ')}</div>`:''}
            </div>
            <div style="text-align:right">
              <div style="font-size:10px;color:var(--i3)">In: ${fmt(p.buyin)}</div>
              <div style="font-size:12px;font-weight:700;color:${col}">${net==null?'no cashout':net>0?'+'+fmt(net):net<0?'-'+fmt(Math.abs(net)):'¬±0'}</div>
            </div>
          </div>`;
        }).join('')}
      </div>

      ${dumbHands.length?`
        <div style="font-size:8px;font-weight:700;letter-spacing:.12em;color:var(--neg);text-transform:uppercase;margin-bottom:8px">ü§° Hall of Shame</div>
        <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:14px">
          ${dumbHands.map(d=>{
            const suits=d.suited?['‚ô†','‚ô†']:['‚ô†','‚ô•'];
            return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(255,69,96,.06);border:1px solid rgba(255,69,96,.18);border-radius:var(--r8)">
              <div style="font-size:18px;font-weight:700;color:var(--neg);letter-spacing:1px">${d.card1}${suits[0]} ${d.card2}${suits[1]}</div>
              <div style="flex:1">
                <div style="font-size:12px;font-weight:700;color:var(--i0)">${d.winner}</div>
                <div style="font-size:11px;color:var(--i3)">${d.card1}${d.card2}${d.suited?'suited':'offsuit'}${d.note?' ¬∑ '+d.note:''}</div>
              </div>
              <div class="mono ag" style="font-size:13px;font-weight:700">${fmt(d.pot)}</div>
            </div>`;
          }).join('')}
        </div>
      `:''}
    </div>

    <!-- Per-player career view -->
    <div class="card">
      <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--i3);text-transform:uppercase;margin-bottom:10px">Career Stats ‚Äî Players from This Session</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${s.players.map(p=>{
          const pSessions=hist.filter(h=>h.players.some(pl=>pl.name===p.name));
          const pNet=pSessions.flatMap(h=>h.players.filter(pl=>pl.name===p.name&&pl.cashout!=null)).reduce((a,pl)=>a+(pl.cashout-pl.buyin),0);
          const pDumb=allDumb.filter(d=>d.winner===p.name);
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--s2);border-radius:var(--r8);border:1px solid var(--br)">
            <div style="width:32px;height:32px;border-radius:50%;background:var(--s3);border:2px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--i2);flex-shrink:0">${p.name.charAt(0)}</div>
            <div style="flex:1">
              <div style="font-size:12px;font-weight:700;color:var(--i0)">${p.name}</div>
              <div style="font-size:11px;color:var(--i3);margin-top:2px">${pSessions.length} sessions${pDumb.length?` ¬∑ ü§° ${pDumb.length} dumb win${pDumb.length!==1?'s':''}`:''}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:13px;font-weight:700;color:${pNet>0?'var(--ag)':pNet<0?'var(--neg)':'var(--i2)'}">${pNet>0?'+':pNet<0?'-':''}${fmt(Math.abs(pNet))}</div>
              <div style="font-size:11px;color:var(--i3)">all-time</div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}


function clearHistory(){
  if(!confirm('Clear all session history? This cannot be undone.'))return;
  localStorage.removeItem('moonsHistory');
  renderSessions();
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INVITE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getInviteURL(id){
  const base=window.location.href.split('?')[0].split('#')[0];
  return `${base}?invite=${id}`;
}

function renderInvite(){
  if(INVITE.name){
    $('inv-title-display').textContent=INVITE.name;
    const dt=INVITE.date?new Date(INVITE.date+'T'+INVITE.time).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',hour:'numeric',minute:'2-digit'}):'Date TBD';
    $('inv-date-display').textContent=(INVITE.loc?INVITE.loc+' ¬∑ ':'')+dt+(INVITE.buyin?` ¬∑ $${INVITE.buyin} buy-in`:'');
    $('inv-name').value=INVITE.name;
    if(INVITE.date)$('inv-date').value=INVITE.date;
    if(INVITE.time)$('inv-time').value=INVITE.time;
    if(INVITE.loc)$('inv-loc').value=INVITE.loc;
    if(INVITE.max)$('inv-max').value=INVITE.max;
    if(INVITE.buyin)$('inv-buyin').value=INVITE.buyin;
    if(INVITE.note)$('inv-note').value=INVITE.note;
  }
  const el=$('inv-share-url');
  if(INVITE.id){
    const url=getInviteURL(INVITE.id);
    el.textContent=url; el.href=url;
  } else {
    el.textContent='Save your game details to generate a link'; el.href='#';
  }

  const ins=RSVPS.filter(r=>r.status==='in').length;
  const maybes=RSVPS.filter(r=>r.status==='maybe').length;
  const outs=RSVPS.filter(r=>r.status==='out').length;
  $('inv-in-count').textContent=ins;$('inv-maybe-count').textContent=maybes;$('inv-out-count').textContent=outs;

  const rl=$('rsvp-list'),re=$('rsvp-empty');
  if(!RSVPS.length){re.style.display='block';rl.innerHTML='';}
  else{
    re.style.display='none';
    const order={in:0,maybe:1,out:2};
    rl.innerHTML=[...RSVPS].sort((a,b)=>order[a.status]-order[b.status]).map(r=>{
      const sc={in:'rs-in',maybe:'rs-maybe',out:'rs-out'};
      const em={in:'ü§ô',maybe:'ü§î',out:'üò¢'};
      return `<div class="rsvp-item ${r.status}">
        <div class="rsvp-avatar">${em[r.status]}</div>
        <span class="rsvp-name">${r.name}</span>
        <span class="rsvp-status ${sc[r.status]}">${r.status==='in'?"I'm In":r.status==='maybe'?'Maybe':'Out'}</span>
        <button class="btn btn-ghost btn-xs" onclick="removeRSVP('${r.name}')">‚úï</button>
      </div>`;
    }).join('');
  }
}
function saveInvite(){
  INVITE={
    id:INVITE.id||Date.now().toString(36),
    name:$('inv-name').value||"Moon's Night",
    date:$('inv-date').value,time:$('inv-time').value,
    loc:$('inv-loc').value,max:parseInt($('inv-max').value)||10,
    buyin:parseFloat($('inv-buyin').value)||10,note:$('inv-note').value
  };
  localStorage.setItem('moonsInvite',JSON.stringify(INVITE));
  scheduleCloudSave();
  renderInvite();toast('Invite saved ‚Äî link ready!');
}
function copyInviteLink(){
  if(!INVITE.id){toast('Save your game details first');return;}
  const url=getInviteURL(INVITE.id);
  navigator.clipboard?.writeText(url).then(()=>toast('Link copied!')).catch(()=>toast('Copy this: '+url));
}
function submitRSVP(){
  const name=$('inv-guest-name').value.trim();
  const status=$('inv-guest-status').value;
  if(!name){toast('Enter your name');return;}
  RSVPS=RSVPS.filter(r=>r.name!==name);// update existing
  RSVPS.push({name,status,time:new Date().toISOString()});
  localStorage.setItem('moonsRSVPs',JSON.stringify(RSVPS));scheduleCloudSave();
  $('inv-guest-name').value='';
  renderInvite();toast(`${name} ‚Üí ${status==='in'?"You're in! ü§ô":status==='maybe'?'Maybe ü§î':'Noted üò¢'}`);
  if(activeTab==='dash')renderDash();
}
function removeRSVP(name){
  RSVPS=RSVPS.filter(r=>r.name!==name);
  localStorage.setItem('moonsRSVPs',JSON.stringify(RSVPS));scheduleCloudSave();
  renderInvite();toast(`Removed ${name}`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   POSTFLOP TRAINER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RANKS=['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const SC={'‚ô†':'black','‚ô£':'black','‚ô•':'red','‚ô¶':'red'};
const POSITIONS=['BTN','CO','HJ','MP','EP','SB','BB'];

function shuf(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function deck(){const d=[];RANKS.forEach(r=>SUITS.forEach(s=>d.push({r,s})));return shuf(d);}
function cardHTML(c){
  return`<div class="playing-card ${SC[c.s]}" style="width:50px;height:70px;background:#fff;border-radius:7px;padding:5px 4px;box-shadow:0 3px 14px rgba(0,0,0,.5)">
    <div class="rank" style="font-family:'Instrument Serif',serif;font-size:15px;font-weight:700;line-height:1">${c.r}</div>
    <div class="suit-ctr" style="text-align:center;font-size:22px;line-height:1;margin:1px 0">${c.s}</div>
    <div class="rank" style="font-family:'Instrument Serif',serif;font-size:15px;font-weight:700;line-height:1;transform:rotate(180deg);text-align:right">${c.r}</div>
  </div>`;
}
function evalHand(hole,board){
  const all=[...hole,...board];
  const ri=r=>RANKS.indexOf(r);
  const ranks=all.map(c=>ri(c.r));const suits=all.map(c=>c.s);
  const rc={};ranks.forEach(r=>{rc[r]=(rc[r]||0)+1;});
  const sc={};suits.forEach(s=>{sc[s]=(sc[s]||0)+1;});
  const pairs=Object.values(rc).filter(v=>v===2).length;
  const trips=Object.values(rc).filter(v=>v===3).length;
  const quads=Object.values(rc).filter(v=>v===4).length;
  const flush=Object.values(sc).some(v=>v>=5);
  const ur=[...new Set(ranks)].sort((a,b)=>a-b);
  let str=false;
  for(let i=0;i<=ur.length-5;i++)if(ur[i+4]-ur[i]===4&&ur.slice(i,i+5).length===5)str=true;
  if(ur.includes(0)&&ur.includes(9)&&ur.includes(10)&&ur.includes(11)&&ur.includes(12))str=true;
  if(flush&&str)return{name:'Straight Flush',tier:9};
  if(quads)return{name:'Four of a Kind',tier:8};
  if(trips&&pairs)return{name:'Full House',tier:7};
  if(flush)return{name:'Flush',tier:6};
  if(str)return{name:'Straight',tier:5};
  if(trips)return{name:'Three of a Kind',tier:4};
  if(pairs>=2)return{name:'Two Pair',tier:3};
  if(pairs===1)return{name:'One Pair',tier:2};
  return{name:'High Card',tier:1};
}
function getDraws(hole,board){
  const draws=[];
  const all=[...hole,...board];
  const sc={};all.forEach(c=>{sc[c.s]=(sc[c.s]||0)+1;});
  if(Object.values(sc).some(v=>v===4))draws.push('Flush draw');
  const ur=[...new Set(all.map(c=>RANKS.indexOf(c.r)))].sort((a,b)=>a-b);
  let consec=1,maxC=1;
  for(let i=1;i<ur.length;i++){if(ur[i]-ur[i-1]<=2)consec++;else consec=1;maxC=Math.max(maxC,consec);}
  if(maxC>=3&&!draws.includes('Flush draw'))draws.push('Straight draw');
  return draws;
}

function newHand(){
  $('feedback-box').classList.remove('show');
  $('continue-btn-wrap').style.display='none';
  $('next-hand-btn').style.display='none';
  ['ab-fold','ab-check','ab-call','ab-bet'].forEach(id=>{
    const b=$(id);if(b){b.classList.remove('correct','wrong');}
  });

  const d=deck();
  const heroHole=[d.pop(),d.pop()];
  const villHole=[d.pop(),d.pop()];
  const flop=[d.pop(),d.pop(),d.pop()];
  const turn=d.pop();const river=d.pop();

  let streetSel=($('tr-street')||{value:'random'}).value;
  if(streetSel==='random')streetSel=shuf(['flop','turn','river'])[0];

  const heroPos=POSITIONS[Math.floor(Math.random()*POSITIONS.length)];
  const villPos=POSITIONS.filter(p=>p!==heroPos)[Math.floor(Math.random()*(POSITIONS.length-1))];
  const heroIP=POSITIONS.indexOf(heroPos)<POSITIONS.indexOf(villPos);

  const bb=G.settings.bb||0.10;
  const stackBB=Math.floor(Math.random()*120+40);
  const potBB=Math.floor(Math.random()*20+6);
  const villBet=Math.random()<0.5?parseFloat((potBB*(0.33+Math.random()*0.67)).toFixed(1)):0;

  TR.currentSpot=null;
  TR.multiStreet={
    heroHole,villHole,flop,turn,river,
    heroPos,villPos,heroIP,bb,stackBB,potBB,villBet,
    currentStreet:streetSel,
    allStreets:streetSel==='flop'?['flop','turn','river']:streetSel==='turn'?['turn','river']:['river'],
    streetIndex:0,
    decisions:[]
  };
  renderTrainerStreet();
}

function renderTrainerStreet(){
  const ms=TR.multiStreet;if(!ms)return;
  const{heroHole,flop,turn,river,heroPos,villPos,heroIP,bb,stackBB,potBB,villBet,currentStreet,allStreets,streetIndex}=ms;

  // Progress dots
  const prog=$('tr-progress');
  if(allStreets.length>1){
    prog.style.display='block';
    const dots=['flop','turn','river'];
    $('sp-dots').innerHTML=dots.map(s=>{
      const idx=allStreets.indexOf(s);
      if(idx<0)return`<div class="sp-dot" style="opacity:.2"></div>`;
      if(idx<streetIndex)return`<div class="sp-dot done"></div>`;
      if(idx===streetIndex)return`<div class="sp-dot active"></div>`;
      return`<div class="sp-dot"></div>`;
    }).join('');
    ['f','t','r'].forEach((l,i)=>{
      const el=$(`sp-lbl-${l}`);
      if(!el)return;
      const s=['flop','turn','river'][i];
      const idx=allStreets.indexOf(s);
      el.style.color=idx===streetIndex?'var(--cy)':idx<streetIndex?'var(--ag)':'var(--i4)';
    });
  }else{prog.style.display='none';}

  // Board for current street
  let board=[];
  if(currentStreet==='flop')board=flop;
  else if(currentStreet==='turn')board=[...flop,turn];
  else board=[...flop,turn,river];
  $('tr-board').innerHTML=board.map(c=>cardHTML(c)).join('');
  $('hd-cards').innerHTML=heroHole.map(c=>cardHTML(c)).join('');

  const heroEval=evalHand(heroHole,board);
  const draws=getDraws(heroHole,board);
  $('tr-hero-lbl').textContent=`Your Hand ¬∑ ${heroEval.name}${draws.length?' + '+draws.join(', '):''}`;

  // Mini table seats
  renderTrainerTable(heroPos,villPos);

  // Context
  const potVal=(potBB*bb).toFixed(2);
  const stackVal=(stackBB*bb).toFixed(2);
  const spr=parseFloat((stackBB/potBB).toFixed(1));
  const ctx=$('hd-context');
  ctx.style.display='block';
  if(villBet>0){
    const betVal=(villBet*bb).toFixed(2);
    const potOdds=Math.round(villBet/(potBB+villBet*2)*100);
    ctx.innerHTML=`<span style="color:var(--cy);font-weight:700">${heroPos}</span> vs <span style="color:var(--mg)">${villPos}</span> ¬∑ <strong style="text-transform:capitalize">${currentStreet}</strong> ¬∑ Pot <strong>$${potVal}</strong> ¬∑ ${villPos} bets <strong style="color:var(--neg)">$${betVal}</strong> ¬∑ Stack <strong>$${stackVal}</strong> ¬∑ SPR ${spr} ¬∑ Need <strong>${potOdds}%</strong> equity to call`;
  }else{
    ctx.innerHTML=`<span style="color:var(--cy);font-weight:700">${heroPos}</span> vs <span style="color:var(--mg)">${villPos}</span> ¬∑ <strong style="text-transform:capitalize">${currentStreet}</strong> ¬∑ Pot <strong>$${potVal}</strong> ¬∑ Action checked to you ¬∑ Stack <strong>$${stackVal}</strong> ¬∑ SPR ${spr}`;
  }

  // Compute correct action
  const tier=heroEval.tier;const hasDraw=draws.length>0;
  const potOddsNeeded=villBet>0?villBet/(potBB+villBet*2):null;
  let correctAction,gtoEV,reasoning;
  if(villBet===0){
    if(tier>=7){correctAction='bet';gtoEV=1.4+Math.random()*1.2;reasoning='Monster ‚Äî bet for max value';}
    else if(tier>=5){correctAction='bet';gtoEV=0.8+Math.random()*0.7;reasoning='Strong hand ‚Äî bet value/protection';}
    else if(tier>=3&&heroIP){correctAction='bet';gtoEV=0.4+Math.random()*0.5;reasoning='Medium hand IP ‚Äî bet for thin value';}
    else if(hasDraw&&heroIP){correctAction='bet';gtoEV=0.2+Math.random()*0.4;reasoning='Semi-bluff draw in position';}
    else if(hasDraw){correctAction='check';gtoEV=0.1+Math.random()*0.3;reasoning='Draw OOP ‚Äî check/call preferred';}
    else{correctAction='check';gtoEV=-(0.1+Math.random()*0.15);reasoning='Weak hand ‚Äî check and control pot';}
  }else{
    const eq=tier>=7?0.92:tier>=5?0.78:tier>=3?0.55:hasDraw?0.36:0.14+Math.random()*0.1;
    if(tier>=8){correctAction='bet';gtoEV=2.0+Math.random()*1.0;reasoning='Raise with monster ‚Äî build pot';}
    else if(tier>=6&&stackBB/potBB<4){correctAction='bet';gtoEV=1.2+Math.random()*0.7;reasoning='Strong hand, low SPR ‚Äî go for stacks';}
    else if(potOddsNeeded&&eq>potOddsNeeded+0.15){correctAction='call';gtoEV=0.5+Math.random()*0.6;reasoning='Good equity vs bet ‚Äî clear call';}
    else if(potOddsNeeded&&eq>potOddsNeeded){correctAction='call';gtoEV=0.1+Math.random()*0.25;reasoning='Thin call ‚Äî barely profitable';}
    else if(hasDraw&&potOddsNeeded&&eq>potOddsNeeded-0.05){correctAction='call';gtoEV=0.05+Math.random()*0.2;reasoning='Draw with implied odds';}
    else{correctAction='fold';gtoEV=-(0.2+Math.random()*0.4);reasoning='Insufficient equity ‚Äî fold saves chips';}
  }

  TR.currentSpot={heroEval,draws,correctAction,gtoEV,reasoning,board,villBet,potBB,bb,spr,heroPos,villPos,heroIP,stackBB,currentStreet};

  // Button labels
  const canCheck=villBet===0;
  const abf=$('ab-fold'),abc=$('ab-check'),abl=$('ab-call'),abb=$('ab-bet');
  if(abf){abf.style.display=canCheck?'none':'block';}
  if(abc){abc.style.display=canCheck?'block':'none';}
  if(abl){abl.style.display=canCheck?'none':'block';abl.textContent=`Call $${(villBet*bb).toFixed(2)}`;}
  if(abb){abb.textContent=canCheck?'Bet':(tier>=6?'Raise':'Raise/Bluff');}
  ['ab-fold','ab-check','ab-call','ab-bet'].forEach(id=>{const b=$(id);if(b)b.classList.remove('correct','wrong');});
  $('feedback-box').classList.remove('show');

  // Sidebar hand info
  const hi=$('tr-hand-info');
  if(hi){
    const tierLabels=['','Trash','Pair','Two Pair','Set','Straight','Flush','Full House','Quads','Str. Flush'];
    hi.innerHTML=`<div style="margin-bottom:6px"><span style="color:var(--cy)">${heroEval.name}</span></div>
      ${draws.map(d=>`<div style="color:var(--au)">‚ö° ${d}</div>`).join('')}
      <div style="margin-top:6px;color:var(--i4);font-size:10px">SPR: ${spr} ¬∑ ${heroIP?'In Position ‚úì':'Out of Position'}</div>`;
  }
  updateTRStats();
}

function renderTrainerTable(heroPos,villPos){
  const wrap=$('tr-table-wrap');const seatsEl=$('tr-seats');if(!wrap||!seatsEl)return;
  wrap.style.display='block';seatsEl.innerHTML='';
  const W=wrap.offsetWidth||300;const H=wrap.offsetHeight||100;
  const cx=W/2;const cy=H/2;const rx=W*0.44;const ry=H*0.40;
  const n=Math.min(G.settings.seats,8);
  for(let i=0;i<n;i++){
    const ang=-Math.PI/2+(2*Math.PI/n)*i;
    const x=cx+rx*Math.cos(ang);const y=cy+ry*Math.sin(ang);
    const pos=POSITIONS[i]||`S${i+1}`;
    const isHero=pos===heroPos;const isVill=pos===villPos;
    const node=document.createElement('div');
    node.style.cssText=`position:absolute;left:${x}px;top:${y}px;transform:translate(-50%,-50%);padding:3px 6px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.06em;white-space:nowrap;border:1px solid;`;
    if(isHero){node.style.background='rgba(0,212,255,.18)';node.style.borderColor='var(--cy)';node.style.color='var(--cy)';node.style.boxShadow='0 0 10px rgba(0,212,255,.3)';}
    else if(isVill){node.style.background='rgba(255,0,110,.14)';node.style.borderColor='var(--mg)';node.style.color='var(--mg)';}
    else{node.style.background='var(--s3)';node.style.borderColor='var(--br)';node.style.color='var(--i4)';}
    node.textContent=isHero?`YOU (${pos})`:isVill?`VIL (${pos})`:pos;
    seatsEl.appendChild(node);
  }
}

function trainerAction(action){
  if(!TR.currentSpot)return;
  const{correctAction,gtoEV,reasoning,heroEval,draws,villBet,potBB,bb,spr,heroPos,villPos,currentStreet}=TR.currentSpot;
  const ms=TR.multiStreet;
  const isCorrect=action===correctAction;

  // Highlight btns
  ['ab-fold','ab-check','ab-call','ab-bet'].forEach(id=>{
    const b=$(id);if(!b||b.style.display==='none')return;
    const ba=b.id.replace('ab-','');
    b.classList.remove('correct','wrong');
    if(ba===action)b.classList.add(isCorrect?'correct':'wrong');
    if(ba===correctAction&&!isCorrect)b.classList.add('correct');
  });

  TR.played++;if(isCorrect)TR.correct++;TR.totalEV+=gtoEV;
  if(ms)ms.decisions.push({street:currentStreet,action,correct:isCorrect,ev:gtoEV});
  TR.history.push({street:currentStreet,action,correct:isCorrect,ev:gtoEV});

  const evDiff=isCorrect?0:gtoEV+0.25;
  let grade,verdict;
  if(isCorrect&&gtoEV>1.5){grade='A+';verdict='Perfect ‚Äî max value';}
  else if(isCorrect&&gtoEV>0.7){grade='A';verdict='Correct ‚Äî solid play';}
  else if(isCorrect){grade='B+';verdict='Correct ‚Äî good discipline';}
  else if(evDiff<0.35){grade='B';verdict='Small mistake ‚Äî close spot';}
  else if(evDiff<0.9){grade='C';verdict='Mistake ‚Äî notable EV leak';}
  else{grade='D';verdict='Big error ‚Äî significant chips lost';}

  const ge=$('fb-grade');ge.textContent=grade;ge.className='fb-grade '+grade[0];
  $('fb-verdict').textContent=verdict;

  const aEV={fold:0,check:gtoEV*0.35,call:gtoEV*0.6,bet:gtoEV};
  const yourEV=aEV[action]!==undefined?aEV[action]:0;
  const lost=isCorrect?0:parseFloat((gtoEV-yourEV).toFixed(2));
  $('fb-ev-row').innerHTML=`
    <div class="fb-ev"><div class="fb-ev-v" style="color:${yourEV>=0?'var(--ag)':'var(--neg)'}">${yourEV>=0?'+':''}${yourEV.toFixed(2)}BB</div><div class="fb-ev-l">Your EV</div></div>
    <div class="fb-ev"><div class="fb-ev-v" style="color:${gtoEV>=0?'var(--cy)':'var(--neg)'}">${gtoEV>=0?'+':''}${gtoEV.toFixed(2)}BB</div><div class="fb-ev-l">Best EV</div></div>
    <div class="fb-ev"><div class="fb-ev-v" style="color:${lost===0?'var(--ag)':'var(--neg)'}">${lost===0?'0.00':'-'+lost.toFixed(2)}BB</div><div class="fb-ev-l">EV Lost</div></div>`;
  $('fb-spot').textContent=`${heroEval.name}${draws.length?' + '+draws.join(', '):''} ¬∑ ${currentStreet} ¬∑ ${heroPos} vs ${villPos} ¬∑ SPR ${spr} ¬∑ GTO: ${correctAction.toUpperCase()} ¬∑ You: ${action.toUpperCase()}`;

  $('feedback-box').classList.add('show');

  // Determine if we can continue
  if(ms){
    const nextIdx=ms.streetIndex+1;
    if(nextIdx<ms.allStreets.length&&action!=='fold'){
      const nextStreet=ms.allStreets[nextIdx];
      $('next-street-lbl').textContent=nextStreet.charAt(0).toUpperCase()+nextStreet.slice(1);
      $('continue-btn-wrap').style.display='block';
      $('next-hand-btn').style.display='none';
    }else{
      $('continue-btn-wrap').style.display='none';
      $('next-hand-btn').style.display='block';
    }
  }else{
    $('continue-btn-wrap').style.display='none';$('next-hand-btn').style.display='block';
  }

  // AI coaching
  const fa=$('fb-analysis');fa.textContent='Analyzing‚Ä¶';fa.className='fb-analysis loading';
  getCoach(TR.currentSpot,action,isCorrect,grade).then(t=>{fa.textContent=t;fa.className='fb-analysis';}).catch(()=>{fa.textContent=reasoning+(isCorrect?' ‚Äî correct!':('. You '+action+'d ‚Äî the better play is to '+correctAction+'.'));fa.className='fb-analysis';});
  TR.currentSpot=null;updateTRStats();
}

function continueHand(){
  $('feedback-box').classList.remove('show');
  $('continue-btn-wrap').style.display='none';
  $('next-hand-btn').style.display='none';
  const ms=TR.multiStreet;if(!ms)return;
  ms.streetIndex++;
  ms.currentStreet=ms.allStreets[ms.streetIndex];
  // update pot/bet for next street
  ms.potBB=Math.floor(ms.potBB*(1.5+Math.random()*1));
  ms.villBet=Math.random()<0.55?parseFloat((ms.potBB*(0.33+Math.random()*0.67)).toFixed(1)):0;
  renderTrainerStreet();
}

async function getCoach(spot, played, isCorrect, grade){
  return new Promise(function(resolve){
    var msg;
    if (isCorrect){
      msg = "Nice hand. Your line looks solid for this position and stack depth.";
    } else {
      msg = "Think about position, SPR, and which worse hands call or better hands fold.";
    }
    resolve(msg);
  });
}

function resetTrainer(){TR.played=0;TR.correct=0;TR.totalEV=0;TR.history=[];TR.currentSpot=null;TR.multiStreet=null;updateTRStats();newHand();}
function updateTRStats(){
  $('tr-played').textContent=TR.played;$('tr-correct').textContent=TR.correct;
  const acc=TR.played?Math.round(TR.correct/TR.played*100):null;
  $('tr-acc').textContent=acc!==null?acc+'%':'‚Äî';
  if(acc!==null)$('tr-acc').className='tr-sv '+(acc>=70?'pos':acc<50?'neg':'cy');
  const ev=TR.played?TR.totalEV/TR.played:null;
  $('tr-ev').textContent=ev!==null?(ev>=0?'+':'')+ev.toFixed(2)+'BB':'‚Äî';
  if(ev!==null)$('tr-ev').className='tr-sv '+(ev>=0.5?'pos':ev<0?'neg':'cy');
  if(TR.history.length){
    const sm={};TR.history.forEach(h=>{if(!sm[h.street])sm[h.street]={c:0,t:0};sm[h.street].t++;if(h.correct)sm[h.street].c++;});
    const best=Object.entries(sm).sort((a,b)=>(b[1].c/b[1].t)-(a[1].c/a[1].t))[0];
    const worst=Object.entries(sm).sort((a,b)=>(a[1].c/a[1].t)-(b[1].c/b[1].t))[0];
    if(best)$('tr-best').textContent=best[0];if(worst)$('tr-weak').textContent=worst[0];
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABLE VISUAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tableSize(){const W=Math.min(window.innerWidth-32,700);return{W,H:Math.round(W*.5)};}
function renderTable(){
  const wrap=$('t-wrap');if(!wrap)return;
  wrap.querySelectorAll('.seat-node').forEach(e=>e.remove());
  const{W,H}=tableSize();
  wrap.style.width=W+'px';wrap.style.height=H+'px';
  $('felt').style.width=Math.round(W*.7)+'px';$('felt').style.height=Math.round(H*.7)+'px';
  $('felt-pot').style.fontSize=Math.round(H*.09)+'px';
  const n=G.settings.seats;const cx=W/2;const cy=H/2;const rx=W*.45;const ry=H*.44;
  const nW=Math.min(80,Math.round(W*.13));
  const act=G.players.filter(p=>p.status==='active');
  $('felt-pot').textContent=fmt(act.reduce((s,p)=>s+p.currentStack,0));
  for(let i=0;i<n;i++){
    const ang=-Math.PI/2+(2*Math.PI/n)*i;
    const x=cx+rx*Math.cos(ang);const y=cy+ry*Math.sin(ang);
    const seat=i+1;const p=G.players.find(p=>p.seat===seat&&p.status==='active');
    const node=document.createElement('div');node.className='seat-node';
    node.style.cssText=`left:${x}px;top:${y}px;width:${nW}px;`;
    node.onclick=()=>p?openPlayerPanel(p.id):openAdd(seat);
    if(p){
      const tot=ti(p);const pct=tot>0?p.currentStack/tot:1;
      let cls='occ';if(pct>=1.5)cls='occ big';else if(pct<=0.4)cls='occ sht';
      const sc=p.currentStack-tot>0?'up':p.currentStack-tot<0?'dn':'';
      node.innerHTML=`<div class="sc ${cls}" style="max-width:${nW}px;padding:5px 4px"><div class="sn-num">S${seat}</div><div class="sn-name" style="max-width:${nW-8}px">${p.name}</div><div class="sn-stack ${sc}">${fmt(p.currentStack)}</div></div>`;
    }else{
      node.innerHTML=`<div class="sc emp" style="max-width:${nW}px;padding:5px 4px"><div class="sn-num">S${seat}</div><div class="sn-open">Open</div></div>`;
    }
    wrap.appendChild(node);
  }
  updateHeader();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateHeader(){
  const act=G.players.filter(p=>p.status==='active');
  $('h-players').textContent=act.length;
  $('h-pot').textContent=fmt(act.reduce((s,p)=>s+p.currentStack,0));
}
function refresh(){
  updateHeader();
  if(activeTab==='dash')    renderDash();
  if(activeTab==='players') renderPlayerPanel();
  if(activeTab==='cashout') renderCashOut();
  if(activeTab==='chips')   populatePickers();
  if(activeTab==='hands')   renderHands();
}

document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on')}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.overlay.on').forEach(m=>m.classList.remove('on'))});
let rsz;window.addEventListener('resize',()=>{clearTimeout(rsz);rsz=setTimeout(()=>{if(activeTab==='table')renderTable();if(TR.multiStreet)renderTrainerTable(TR.multiStreet.heroPos,TR.multiStreet.villPos);},200)});


/* ‚ïê‚ïê CLOUD SYNC (Vercel KV) ‚ïê‚ïê */
let _cloudTimer=null;
function scheduleCloudSave(){clearTimeout(_cloudTimer);_cloudTimer=setTimeout(cloudSave,1500);}
async function cloudSave(){
  try{
    await fetch('/api/state',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        roster:ROSTER_DB,
        history:JSON.parse(localStorage.getItem('moonsHistory')||'[]'),
        invite:INVITE,
        rsvps:RSVPS,
        oracle:oracleLog
      })
    });
  }catch(e){console.warn('Cloud save failed:',e);}
}
async function cloudLoad(){
  try{
    const r=await fetch('/api/state');
    if(!r.ok)return;
    const {data}=await r.json();
    if(!data)return;
    let changed=false;
    if(Array.isArray(data.roster)&&data.roster.length>0){
      ROSTER_DB=data.roster.map(r=>typeof r==='string'?{name:r,lastSeen:null,nextSession:null,notes:''}:r);
      localStorage.setItem('moonsRoster',JSON.stringify(ROSTER_DB));changed=true;
    }
    if(Array.isArray(data.history)&&data.history.length>0){
      localStorage.setItem('moonsHistory',JSON.stringify(data.history));changed=true;
    }
    if(data.invite&&typeof data.invite==='object'&&data.invite.id){
      INVITE=data.invite;localStorage.setItem('moonsInvite',JSON.stringify(INVITE));changed=true;
    }
    if(Array.isArray(data.rsvps)){
      RSVPS=data.rsvps;localStorage.setItem('moonsRSVPs',JSON.stringify(RSVPS));changed=true;
    }
    if(Array.isArray(data.oracle)){
      oracleLog=data.oracle;localStorage.setItem('oracleLog',JSON.stringify(oracleLog));
    }
    if(changed){
      renderDash();
      if(activeTab==='players')renderPlayerPanel();
      if(activeTab==='sessions')renderSessions();
      if(activeTab==='invite')renderInvite();
      toast('‚òÅ Synced');
    }
  }catch(e){console.warn('Cloud load failed, using local:',e);}
}

const today=new Date().toISOString().split('T')[0];
const dinv=$('inv-date');if(dinv&&!dinv.value)dinv.value=today;
setTimeout(renderDash,80);
updateNavState();
cloudLoad();
toast("Moon's ‚Äî let's play",2000);
</script>
</body>
</html>
